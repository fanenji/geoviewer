<!DOCTYPE HTML>

<html lang="it">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8">

    <title>GeoRasterMask</title>

    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/default/base.css"/>
    <link rel="stylesheet" type="text/css" href="raster.css">
    <script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2&language=it"></script>
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <script src="/geoviewer/lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='/geoviewer/lib/proj4js/lib/proj4js-min.js'></script>

    <script src="/geoviewer/lib/Cwn2/cwn2-debug.js"></script>

    <script src="/geoviewer/lib/Cwn2/deploy-config.js"></script>

</head>
<body>

<script>

    function rasterFootprintSave(env) {
        var serviceURl = (env === "PROD")? "http://geoservizi.regione.liguria.it:8089" : "http://geoservizi.datasiel.net:8089";
        var geom = CWN2.Editor.getEditingGeom(CWN2.app.map,"WKT");
        if (!geom) {
            alert('Disegnare un poligono');
            return;
        }

        var wkt = (Array.isArray(geom))? geom[0] : geom;
        // Prendo il primo layer raster della mappa
        var rasterFilePath;
        var rasterLayer;
        Ext.each(CWN2.app.map.layerManager.overlayLayersConfig, function(layer) {
            if (layer.geomType === "RASTER" && layer.rasterFilePath){
                rasterFilePath = layer.rasterFilePath;
                rasterLayer = layer.name;
                return false;
            }
        });

        //Chiamo servizio scrittura file
        var writeWktUrl = serviceURl + "/geoservices/REST/geoserver/set_raster_footprint?idLayer=" + rasterLayer + "&path=" + rasterFilePath + "&wkt=" + wkt;
        CWN2.Util.ajaxRequest({
            type: "JSONP",
            url: writeWktUrl,
            callBack: function(response) {
                if (response.success) {
                    //chiamo servizio di riconfigurazione mappa per impostazione footprint del layer
                    var target = (env === "PROD")? "PROD" : "TEST";
                    var configUrl = "/geoservices/REST/geoserver/service_mngr/" + CWN2.app.initOptions.idMap + "?force=true&action=SET_LAYER_FOOTPRINT&target=" + target + "&output=JSON"
                    CWN2.Util.ajaxRequest({
                        type: "JSONP",
                        url: configUrl,
                        callBack: function(response) {
                            CWN2.Util.msgBox("File di footprint salvato sul server ");
                            var layerConfig = CWN2.app.map.layerManager.getLayerConfigByName(rasterLayer);
                            if (layerConfig.cacheMaxZoomLevel) {
                                CWN2.Util.msgBox("Il livello ha una cache associata.Ricordati di rinfrescarla!!");
                            }
                            var layer =CWN2.app.map.getLayerByName(rasterLayer);
                            layer.redraw(true);
                        }
                    });
                } else {
                    alert("Errore scrittura file wkt: " + response.message);
                }
            }
        });
    }

    Ext.define('CWN2.button.GeoStyler.RasterSave', {
        extend: 'Ext.button.Button',
        alias: 'widget.cwn2-button-geostyler-raster-save',
        id: "geostyler-raster-save",
        iconCls: "geoStylerRasterSave",
        handler: function () {
            rasterFootprintSave("TEST");
        }
        ,text: 'TEST'
    });

    Ext.define('CWN2.button.GeoStyler.RasterSaveEse', {
        extend: 'Ext.button.Button',
        alias: 'widget.cwn2-button-geostyler-raster-save-ese',
        id: "geostyler-raster-save-ese",
        iconCls: "geoStylerRasterSave",
        handler: function () {
            rasterFootprintSave("PROD");
        }
        ,text: 'ESERCIZIO'
    });

Ext.application({

    name: 'GeoStyler',

    loadFootprint: function(idMap) {
        var footprint,rasterLayer;
        Ext.each(CWN2.app.map.layerManager.overlayLayersConfig, function(layer) {
            if (layer.geomType === "RASTER" && layer.rasterFilePath){
                footprint = layer.footprint;
                rasterLayer = layer.name;
                return false;
            }
        });
        if (footprint) {
            //Chiamo servizio lettura file wkt
            var serviceURl = "http://geoservizi.datasiel.net";
            var readWktUrl = serviceURl + ":8089/geoservices/REST/geoserver/get_raster_footprint?idLayer=" + rasterLayer + "&footprint=" + footprint;
            CWN2.Util.ajaxRequest({
                type: "JSONP",
                url: readWktUrl,
                callBack: function(response) {
                    if (response.success) {
                        var wkt = response.wkt;
                        if (wkt) {
                            var layer = CWN2.app.map.getLayerByName("editingLayer");
                            var geom = OpenLayers.Geometry.fromWKT(wkt).transform(CWN2.app.map.displayProjection,new OpenLayers.Projection(CWN2.app.map.projection));
                            //var geom = OpenLayers.Geometry.fromWKT(wkt);
                            layer.addFeatures([new OpenLayers.Feature.Vector(geom)]);
                        }
                    } else {
                        alert("Errore lettura file wkt: " + response.message);
                    }
                }
            });
        }
        Ext.each(CWN2.app.map.layerManager.overlayLayersConfig, function(layer) {
            if (layer.idMap != idMap && layer.name != "editingLayer") {
                CWN2.app.map.layerManager.setLayerVisible(layer.name,false);
            }
        });

    },

    loadMap: function(idMap,projection) {

        var extent = "1379189,4843069,1584097,4960481";
        if (projection != "EPSG:3003") {
            extent = CWN2.Util.transformStrBounds("EPSG:3003",projection,extent);
        }

        var config = {
            "application": {
                "mapOptions": {
                    "projection": projection,
                    "initialExtent": extent
                },
                "layout": {
                    "statusBar": true,
                    "legend": null,
                    "legend": {
                        "type": "simple",
                        "position": "east",
                        "collapsed": false
                    },
                    "widgets": [
                        { "name": "Scale" },
                        { "name": "CoordinateReadOut" }
                    ],
                    "toolbar": {
                        "itemGroups": [
                            {
                                "items": [
                                    { "name": "pan" },
                                    { "name": "zoomin" },
                                    { "name": "zoomout" },
                                    { "name": "fitall" },
                                    { "name": "zoomToInitialExtent" },
                                    { "name": "zoomprevious" },
                                    { "name": "zoomnext" }
                                ]
                            },
                            {
                                "name": "editing",
                                "items": [
                                    {
                                        "type": "button",
                                        "name": "drawPolygon",
                                        "options": {
                                            "singleFeature": true
                                        }
                                    },
                                    {
                                        "type": "button",
                                        "name": "modifyFeature",
                                        "options": {
                                        }
                                    },
                                    {
                                        "type": "button",
                                        "name": "dragFeature",
                                        "options": {}
                                    },
                                    {
                                        "type": "button",
                                        "name": "deleteFeature",
                                        "options": {}
                                    },
                                    {
                                        "type": "button",
                                        "name": "geostyler-raster-save",
                                        "options": {}
                                    },
                                    {
                                        "type": "button",
                                        "name": "geostyler-raster-save-ese",
                                        "options": {}
                                    }
                                ]
                            }
                        ]
                    }
                }
            },
            "baseLayers": [
                { "type": "no_base" , "visible": true}
            ],
            "layers": []
        };

        CWN2.Globals.NO_GWC_CACHE = true;

        CWN2.app.load({
            appConfig: config,
            divID: "cwn2_map",
            callBack: this.loadFootprint,
            callBackArgs: idMap,
            idMap: idMap,
            flagGeoserver: true,
            geoserverUrl: "http://geoservizi.datasiel.net:8080/",
            setDisplayProjection: true,
            debug: true
        });
    },

    launch: function() {
        var me = this;
        var idMap = decodeURIComponent(CWN2.Util.getUrlParam('id'));
        if (idMap === "null") {
            idMap = null;
        }

        CWN2.Util.ajaxRequest({
            type: "JSONP",
            url: "/geoservices/REST/config/map/" + idMap,
            callBack: function(response) {
                var proj = response.data.projection;
                me.loadMap(idMap,proj)
            }
        });


    } //eo launch


});



</script>

</body>
</html>
