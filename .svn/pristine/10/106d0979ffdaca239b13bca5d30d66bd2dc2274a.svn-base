<!DOCTYPE HTML>

<html>
<head>
    <meta charset="utf-8">
    <title>LIBIOSS - Selezione Habitat</title>

    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all.css"/>
    <link rel="stylesheet" type="text/css" href="../../../stili/default/base.css"/>
    <!-- librerie js -->
    <script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2&language=it"></script>
    <script src="../../../lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='../../../lib/proj4js/lib/proj4js-min.js'></script>
    <!-- jQuery -->
    <script src="../../../lib/jQuery/jquery-1.7.min.js"></script>
    <!-- ExtJs -->
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <!-- CWN2 -->
    <script src="../../../lib/Cwn2/cwn2-debug.js"></script>


</head>

<body>

<script>

    Ext.application({
        name: 'LibiossSelezioneHabitat',

        launch: function() {

            var config = {
                "application": {
                    "mapOptions": {
                        "initialExtent": "830036,5402959,1123018,5597635",
                        "restrictedExtent": "830036,5402959,1123018,5597635"
                    },
                    "layout": {
                        "mapTitle": "Selezione Habitat",
                        "statusBar": true,
                        "widgets": [
                            { "name": "Scale" },
                            { "name": "CoordinateReadOut" }
                        ],
                        "toolbar": {
                            "itemGroups": [
                                {
                                    "items": [
                                        { "name": "pan" },
                                        { "name": "zoomin" },
                                        { "name": "zoomout" },
                                        { "name": "fitall" },
                                        { "name": "zoomToInitialExtent" },
                                        { "name": "zoomprevious" },
                                        { "name": "zoomnext" }
                                    ]
                                },
                                {
                                    "items": [
                                        { "name": "measureline" },
                                        { "name": "measurearea" }
                                    ]
                                },
                                {
                                    "items": [
                                        {"name": "transparency" },
                                        {"name": "infowms",
                                            "options": {
                                                "radius": 1,
                                                "maxFeatures": 1,
                                                "zoomToSelected": true,
                                                "zoomLevel": 11
                                            }
                                        },
/*
                                        {"name": "find",
                                            "panels": [
                                                {
                                                    "type": "layer",
                                                    "name": "Livello",
                                                    "options": {
                                                        "layers" : [
                                                            {
                                                               "name" : "L4253",
                                                                "dbSchema": {
                                                                    "schema": "LIBIOSS_ETRF89",
                                                                    "tableName": "LOBG01_HABITAT_WORK_P",
                                                                    "columns": [
                                                                        {
                                                                            "ColumnName": "ID_STAZ",
                                                                            "dataType": "INT"
                                                                        },
                                                                        {
                                                                            "ColumnName": "SIGLA",
                                                                            "dataType": "VARCHAR2"
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                "name" : "L4254",
                                                                "dbSchema": {
                                                                    "schema": "LIBIOSS_ETRF89",
                                                                    "tableName": "LOBG01_HABITAT_WORK_A",
                                                                    "columns": [
                                                                        {
                                                                            "ColumnName": "ID_STAZ",
                                                                            "dataType": "INT"
                                                                        },
                                                                        {
                                                                            "ColumnName": "SIGLA",
                                                                            "dataType": "VARCHAR2"
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }

                                            ]
                                        },
*/
                                        {"type": "combo", "name": "geocoder"}
                                    ]
                                },
                                {
                                    "items": [
                                        {"name": "selectfeature",
                                            "options": {
                                                "idLayer": "L4253,L4254",
                                                "flagSelezioneSingola": true,
                                                "radius": 5
                                            }
                                        }
                                    ]
                                },
                                {
                                    "align": "right",
                                    "items": [
                                        {"name": "simpleLegend"}
                                    ]
                                }
                            ]
                        }
                    }
                },
                "baseLayers": [
                    { "type": "no_base" },
                    { "type": "bing_aerial", "visible": true}
                ]
            };

            $(window).on('beforeunload', function() {
                return insertAnnulla();
            });

            var flagInsert = false;

            function cancel() {
                Ext.MessageBox.confirm(
                        CWN2.I18n.get('Conferma'),
                        CWN2.I18n.get('Sei sicuro?'),
                        function(btn) {
                            if (btn === "yes") {
                                insert(0, '');
                            }
                        }
                );
            }

            // funzione richiamata dalla chiusura della finestra
            function insertAnnulla() {
                if (flagInsert) {
                    return;
                }
                insert(0, '', 'NO');
            }

            function insert(id, idLayer, esito) {
                var insertService = "/geoservices/REST/libioss/insert?";
                insertService += "idSession=" + CWN2.Util.getUrlParam('ID_SESSION');
                insertService += "&id=" + id;
                insertService += "&idLayer=" + idLayer;
                insertService += "&esito=" + esito;
                CWN2.Util.ajaxRequest({
                    type: "JSONP",
                    url: insertService,
                    callBack: function(response) {
                        if (response && !response.success) {
                            CWN2.Util.msgBox("Attenzione: - " + response.message);
                        }

                        flagInsert = true;
                        window.close();
                    }
                });
            }

            function impostaFunzioniCallback() {
                CWN2.app.setButtonOption("selectfeature", "callBacks", {
                    "submit": function(items) {
                        insert(items[0].data.ID, items[0].data.ID_LAYER, 'SI');
                    },
                    "cancel": function(items) {
                        Ext.MessageBox.confirm(
                                CWN2.I18n.get('Conferma'),
                                CWN2.I18n.get('Sei sicuro?'),
                                function(btn) {
                                    if (btn === "yes") {
                                        insert(0, '', 'NO');
                                    }
                                }
                        );
                    }
                });
            }

            // carico la mappa
            CWN2.app.load(
                    {
                        appConfig: config,
                        callBack: impostaFunzioniCallback,
                        idMap: "1621",
                        debug: true
                    }
            );
        }
    });


</script>

</body>
</html>
		