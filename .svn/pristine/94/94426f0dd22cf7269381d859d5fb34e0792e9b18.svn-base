<!DOCTYPE HTML>

<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta charset="utf-8">
    <title>Filtro Cartografico</title>

    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all.css"/>
    <link rel="stylesheet" type="text/css" href="../../../stili/default/base.css"/>
    <!-- librerie js -->
    <script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2&language=it"></script>
    <script src="../../../lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='../../../lib/proj4js/lib/proj4js-min.js'></script>
    <!-- jQuery -->
    <script src="../../../lib/jQuery/jquery-1.7.min.js"></script>
    <!-- ExtJs -->
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <!-- CWN2 -->
    <script src="../../../lib/Cwn2/cwn2.js"></script>
    <script src="../../../lib/Cwn2/deploy-config.js"></script>

    <!-- CUSTOM -->
    <script src="corem.js"></script>

</head>

<body>

<script>

Ext.application({
    name: 'CoremFiltroSpecie',

    launch: function() {
        $(window).on('beforeunload', function() {
            return insertAnnulla();
        });

        var flagInsert = false;
        var flagAnnulla = false;

        function insertAnnulla() {
            if (flagInsert) {
                return;
            }
            var annullaBboxService = "/geoservices/REST/corem/insert_bbox?";
            annullaBboxService += "flagAnnulla=true";
            annullaBboxService += "&idSession=" + idSession;
            annullaBboxService += "&codiceRegno=" + codiceRegno;
            annullaBboxService += "&codiceClasse=" + codiceClasse;
            annullaBboxService += "&codiceOrdine=" + codiceOrdine;
            annullaBboxService += "&codiceFamiglia=" + codiceFamiglia;
            annullaBboxService += "&codiceGenere=" + codiceGenere;
            annullaBboxService += "&codiceSpecie=" + codiceSpecie;
            CWN2.Util.ajaxRequest({
                type: "JSONP",
                url: annullaBboxService,
                callBack: function(response) {
                    if (response && !response.success) {
                        CWN2.Util.msgBox("Attenzione: - " + response.message);
                    }
                    window.close();
                }
            });

            if (!flagAnnulla) {
                //                    alert('Ritorno alla applicazione');
            }

        }

        var cancel = function() {
            Ext.MessageBox.confirm(
                    CWN2.I18n.get('Conferma'),
                    CWN2.I18n.get('Sei sicuro?'),
                    function(btn) {
                        if (btn === "yes") {
                            flagAnnulla = true;
                            insertAnnulla();
                        }
                    }
            );
        };

        var insertBbox = function() {

            // controllo che la geometria esista
            var geom = CWN2.Editor.getEditingGeom(CWN2.app.map);
            if (!geom) {
                CWN2.Util.msgBox('Disegnare un rettangolo');
                return;
            }

            // controllo che il rettangolo non sia troppo grande
            var maxArea = 15000;
            var area = Math.floor(CWN2.Editor.getAreaGeom(CWN2.app.map) / 1000000);
            if (area > maxArea) {
                CWN2.Util.msgBox('Area selezionata troppo grande.<br> Area selezionata: ' + area + ' km2<br>Area massima: ' + maxArea + ' km2');
                return;
            }

            var insertBboxService = "/geoservices/REST/corem/insert_bbox?"
            insertBboxService += "idSession=" + idSession;
            insertBboxService += "&codiceRegno=" + codiceRegno;
            insertBboxService += "&codiceClasse=" + codiceClasse;
            insertBboxService += "&codiceOrdine=" + codiceOrdine;
            insertBboxService += "&codiceFamiglia=" + codiceFamiglia;
            insertBboxService += "&codiceGenere=" + codiceGenere;
            insertBboxService += "&codiceSpecie=" + codiceSpecie;
            insertBboxService += "&bbox=" + CWN2.Editor.getGeometryBounds(CWN2.app.map).toBBOX(0);
            CWN2.Util.ajaxRequest({
                type: "JSONP",
                url: insertBboxService,
                callBack: function(response) {
                    if (response && !response.success) {
                        CWN2.Util.msgBox("Attenzione: - " + response.message);
                    }
                    flagInsert = true;
                    window.close();
                }
            });
        };

        var idSession = CWN2.Util.getUrlParam('IDSESSION');
        var codiceRegno = CWN2.Util.getUrlParam('CODICE_REGNO');
        var codiceClasse = CWN2.Util.getUrlParam('CODICE_CLASSE');
        var codiceOrdine = CWN2.Util.getUrlParam('CODICE_ORDINE');
        var codiceFamiglia = CWN2.Util.getUrlParam('CODICE_FAMIGLIA');
        var codiceGenere = CWN2.Util.getUrlParam('CODICE_GENERE');
        var codiceSpecie = CWN2.Util.getUrlParam('CODICE_SPECIE');
        var dataInizio = CWN2.Util.getUrlParam('DataInizio');
        var dataFine = CWN2.Util.getUrlParam('DataFine');
        var filtroRegioni = CWN2.Util.getUrlParam('FILTRO_REGIONI');
        var filter = "CODICE_REGIONE IN (" + filtroRegioni + ")";

        var wmsName = "COREM_REGIONI,COREM_PROVINCE,COREM_COMUNI";
        var extent =  "460000,4703913,1398525,5900000";
        if (filtroRegioni === "07") {
            wmsName = "COREM_REGIONI_LIG,COREM_PROVINCE_LIG,COREM_COMUNI_LIG";
            extent =  "830036,5402959,1123018,5597635";
        }



        var config = {
            "application": {
                "mapOptions": {
                    "initialExtent": extent,
                    "restrictedExtent": extent
                },
                "layout": {
                    "mapTitle": "Filtro Cartografico",
                    "statusBar": true,
                    "widgets": [
                        { "name": "Scale" },
                        { "name": "CoordinateReadOut" },
                        {"name": "Button",
                            "options": {
                                "id": "cwn2-corem-filtro-annulla",
                                "text": "Annulla",
                                "handler": cancel
                            }
                        },
                        {"name": "Button",
                            "options": {
                                "id": "cwn2-corem-filtro-conferma",
                                "text": "Conferma",
                                "handler": insertBbox
                            }
                        }
                    ],
                    "toolbar": {
                        "itemGroups": [
                            {
                                "items": [
                                    { "name": "pan" },
                                    { "name": "zoomin" },
                                    { "name": "zoomout" },
                                    { "name": "fitall" },
                                    { "name": "zoomToInitialExtent" },
                                    { "name": "zoomprevious" },
                                    { "name": "zoomnext" }
                                ]
                            },
                            {
                                "items": [
                                    { "name": "measureline" },
                                    { "name": "measurearea" }
                                ]
                            },
                            {
                                "items": [
                                    {"name": "transparency" },
                                    {"name": "loadlayers",
                                        "panels": [
                                            {
                                                "type": "layerTree",
                                                "name": "Temi",
                                                "options": {
                                                    "treeServiceUrl": "http://geoportale.regione.liguria.it//geoservices/REST/corem/load_layer_tree/",
                                                    "layersConfigServiceUrl": "http://geoportale.regione.liguria.it//geoservices/REST/corem/load_layer_config/"
                                                }
                                            }
                                        ]
                                    },
                                    {"name": "removelayers" },
                                    {"name": "infowms",
                                        "options": {
                                            "radius": 1,
                                            "maxFeatures": 1,
                                            "zoomToSelected": true,
                                            "zoomLevel": 11
                                        }
                                    },
                                    {"type": "combo", "name": "geocoder"}

                                ]
                            },
                            {
                                "items": [
                                    {"name": "drawRegularPolygon", "options": {"singleFeature": true}}
                                    /*,
                                    {"name": "dragFeature"},
                                    {"name": "deleteFeature"}
                                    */
                                ]
                            },
                            {
                                "align": "right",
                                "items": [
                                    {"name": "simpleLegend"}
                                ]
                            }
                        ]
                    }
                }
            },
            "baseLayers": [
                { "type": "no_base" },
                { "type": "bing_aerial", "visible": true}
            ],
            "layers": [
                {
                    type: "WMS",
                    name: "COREM_LIM_AMM",
                    visible: true,
                    projection: "EPSG:3003",
                    minScale: 0,
                    maxScale: 0,
                    opacity: 0.6,
                    showInLegend: true,
                    geomSubType: "POLYGON",
                    legend: {
                        "label": "Limiti Amministrativi",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E://progetti/mapfiles/corem/corem.map&LAYER=COREM_REGIONI&RULE=COREM_REGIONI&request=GETLEGENDGRAPHIC&version=1.1&SERVICE=WMS&FORMAT=image/png"
                    },
                    infoOptions: {
                        infoIdAttr: "ID",
                        infoUrl: null
                    },
                    classes: [],
                    wmsParams: {
                        url: COREM_wmsUrl,
                        name: wmsName,
                        transparent: true,
                        EXP_FILTER: filter
                    }
                }
            ]

        };

        // carico la mappa
        CWN2.app.load({
            appConfig: config,
            callBack: function() {
                // loadGrid è definita in \custom\corem.js
                loadGridFiltro(idSession, codiceRegno, codiceClasse, codiceOrdine, codiceFamiglia, codiceGenere, codiceSpecie, dataInizio, dataFine, filtroRegioni);
            },
            debug: true
        });
    }
});


</script>

</body>
</html>
		