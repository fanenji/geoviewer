<!DOCTYPE HTML>

<html lang="it">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8">

    <title>GeoStyler</title>

    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/default/base.css"/>
    <link rel="stylesheet" type="text/css" href="colorField.css">

    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <script src="/geoviewer/lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='/geoviewer/lib/proj4js/lib/proj4js-min.js'></script>

    <script src="/geoviewer/lib/Cwn2/cwn2-debug.js"></script>

    <script src="/geoviewer/lib/Cwn2/deploy-config-ese.js"></script>

    <script type='text/javascript' src="https://x2js.googlecode.com/hg/xml2json.js"></script>

</head>
<body>

<script>


var x2js = new X2JS({
        arrayAccessFormPaths : [
//                "StyledLayerDescriptor.NamedLayer",
//                "StyledLayerDescriptor.NamedLayer.UserStyle",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.TextSymbolizer.Font.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PointSymbolizer.Graphic.Mark.Fill.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PointSymbolizer.Graphic.Mark.Stroke.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.LineSymbolizer.Stroke.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.Stroke.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.Fill.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PolygonSymbolizer.Stroke.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PolygonSymbolizer.Fill.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Stroke.CssParameter",
            "StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Fill.CssParameter"
        ]
    });

Ext.application({

    name: 'GeoStyler',

    getStyles: function(idMap) {
        if (!idMap) return;

        var geoserverUrl = "/geoservices/REST/geoserver/geoserver_sld?id=";

        var layersConfig = CWN2.app.map.layerManager.overlayLayersConfig;

        Ext.each(layersConfig, function(layer) {
            if (layer.idMap != idMap) {
                CWN2.app.map.layerManager.setLayerVisible(layer.name,false);
            }
            if (layer.geomType === "VECTOR") {
                CWN2.Util.ajaxRequest({
                    type: "XML",
                    url: geoserverUrl + layer.id,
                    callBack: function(sld,response) {
                        var sldStr = response.responseText.replace(/sld:/g, "").replace(/gml:/g, ""); //.replace(/ogc:/g, "")
                        layer.sld = x2js.xml_str2json(sldStr);
                    }
                });
            }
        });

    },

    launch: function() {

        var idMap = decodeURIComponent(CWN2.Util.getUrlParam('id'));
        if (idMap === "null") {
            idMap = null;
        }

        var layers = [];
        if (!idMap) {
            layers = [
                {
                    "id": 0,"name": "L0",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill None + Stroke WKN",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill None + Stroke WKN",
                            "symbolizers": [
                                {
                                    "fill": false,
                                    "stroke": true,
                                    "graphicStroke": true,
                                    "pointRadius": 6,
                                    "graphicName": "triangle",
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "strokeDashstyle": "5 2",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 1,"name": "L1",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill Simple + Stroke Simple",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Simple + Stroke Simple",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "fillColor": "#961E1E",
                                    "fillOpacity": "0.5",
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "strokeOpacity": "0.8",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 2,"name": "L2",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill Hatch + Stroke None",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Hatch + Stroke None",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "graphicFill": true,
                                    graphicName: "shape://times",
                                    pointRadius: 8,
                                    stroke: false,
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 3,"name": "L3",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill ExternalGraphics",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill ExternalGraphics",
                            "symbolizers": [
                                {
                                    externalGraphic: "http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/images/pallinomezzopieno",
                                    fill: true,
                                    graphic: true,
                                    graphicFill: true,
                                    graphicFormat: "image/gif",
                                    pointRadius: 46.5,
                                    stroke: true,
                                    strokeColor: "#FFFFFF",
                                    strokeWidth: "2",
                                    zIndex: 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 4,"name": "L4",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / MultiRule",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Simple / No Stroke",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "fillColor": "#961E1E",
                                    "stroke": false,
                                    "zIndex": 0
                                }
                            ]
                        },
                        {
                            "name": "R1",
                            "title": "Fill None",
                            "symbolizers": [
                                {
                                    "fill": false,
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 5,"name": "L5",
                    "geomSubType": "LINE",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "LINE / Simple",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L80.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/178.map&",
                        "name": "L80",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Simple",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 6,"name": "L6",
                    "geomSubType": "LINE",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "LINE / WKN - DashArray",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L80.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/178.map&",
                        "name": "L80",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "WKN - DashArray",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    graphic: true,
                                    graphicStroke: true,
                                    graphicName: "circle",
                                    "strokeDashstyle": "5 2",
                                    "strokeColor": "#FF0000",
                                    "strokeDashstyle": "4 6",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 7,"name": "L7",
                    "geomSubType": "POINT",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POINT / WKN",
                        "icon": "http://dcarto3.datasiel.net/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L14.png"
                    },
                    "wmsParams": {
                        "url": "http://dcarto3.datasiel.net/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/36.map&",
                        "name": "L14",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "WKN",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    graphic: true,
                                    graphicStroke: true,
                                    graphicName: "circle",
                                    "strokeDashstyle": "5 2",
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 8,"name": "L8",
                    "geomSubType": "POINT",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POINT / Graphic",
                        "icon": "http://dcarto3.datasiel.net/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L14.png"
                    },
                    "wmsParams": {
                        "url": "http://dcarto3.datasiel.net/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/36.map&",
                        "name": "L14",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Graphic",
                            "symbolizers": [
                                {
                                    graphic: true,
                                    externalGraphic: "http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/images/pallinomezzopieno",
                                    graphicFormat: "image/png",
                                    pointRadius: 16,
                                    zIndex: 0
                                }
                            ]
                        }
                    ]
                }


            ];
        }

        var config = {
            "application": {
                "mapOptions": {
                    "restrictedExtent": "830036,5402959,1123018,5597635"
                },
                "layout": {
                    "statusBar": true,
                    "legend": null,
                    "legend": {
                        "type": "simple",
                        "position": "east",
                        "collapsed": false
                    },
                    "widgets": [
                        { "name": "Scale" },
                        { "name": "CoordinateReadOut" }
                    ],
                    "toolbar": {
                        "itemGroups": [
                            {
                                "items": [
                                    { "name": "pan" },
                                    { "name": "zoomin" },
                                    { "name": "zoomout" },
                                    { "name": "fitall" },
                                    { "name": "zoomToInitialExtent" },
                                    { "name": "zoomprevious" },
                                    { "name": "zoomnext" }
                                ]
                            },
                            {
                                "name": "avanzate",
                                "items": [
                                    {"name": "geostyler", "options": { "idMap": idMap }}
                                ]
                            }
                        ]
                    }
                }
            },
            "baseLayers": [
                { "type": "no_base" , "visible": true},
                { "type": "bing_aerial"},
                { "type": "rl_ortofoto_2013" }
            ],
            "layers": layers
        };

        CWN2.app.load({
            appConfig: config,
            divID: "cwn2_map",
            callBack: this.getStyles,
            callBackArgs: idMap,
            idMap: idMap,
            debug: true
        });

    } //eo launch

});

var p_g = function() {
    print_symb('POINT / Graphic',9,0);
}
var p_w = function() {
    print_symb('POINT / WKN',8,0);
}
var l_s = function() {
    print_symb('LINE / SIMPLE',6,0);
}
var l_w = function() {
    print_symb('LINE / WKN',7,0);
}
var pol_s = function() {
    print_symb('POLYGON / Fill Simple + Stroke Simple',4,0);
}
var pol_g = function() {
    print_symb('POLYGON / Fill Graphics',3,0);
}
var pol_h = function() {
    print_symb('POLYGON / Fill Hatch',2,0);
}
var multi = function() {
    print_symb('MULTICLASSE',3,0);
}


var print_symb = function(title,layer,rule) {
    console.log(CWN2.app.map.layerManager.overlayLayersConfig[layer].legend.label + ' - ' + CWN2.app.map.layerManager.overlayLayersConfig[layer].name)
    console.log('---------------------------------')
    console.log(JSON.stringify(CWN2.app.map.layerManager.overlayLayersConfig[layer].sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[0], null, 2));
    console.log('---------------------------------')
    console.log(x2js.json2xml_str(CWN2.app.map.layerManager.overlayLayersConfig[layer].sld))
    console.log('---------------------------------')
    console.log(CWN2.app.map.layerManager.overlayLayersConfig[layer].sld)
    console.log('---------------------------------')
}

</script>

</body>
</html>
