<!DOCTYPE HTML>

<html>
<head>
    <meta charset="utf-8">

    <!-- librerie css -->
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/default/base.css"/>
    <link rel="stylesheet" type="text/css" href="print.css"/>
    <!-- librerie js -->
    <script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2&language=it"></script>
    <script src="/geoviewer/lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='/geoviewer/lib/proj4js/lib/proj4js-min.js'></script>
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/locale/ext-lang-it.js"></script>
    <script src="/geoviewer/lib/Cwn2/cwn2-debug.js"></script>

    <script>

        //http://parodi.datasiel.net:8080/geoviewer/pages/apps/print/map.html?print_config_url=/geoservices/temp/print_d8a59a8d-2aff-4b6a-b971-3f3313489933.json

        Ext.application({
            name: 'stampa',

            launch: function() {
                // imposto la url del servizio di configurazione
                var printConfigUrl = decodeURIComponent(CWN2.Util.getUrlParam('print_config_url'));

                if (!printConfigUrl) {
                    return;
                }

                function setCenter(params) {
                    var flagSameScale = params.flagSameScale,
                        lon = params.center.lon,
                        lat = params.center.lat,
                        scaleDiv = Ext.get("scale_div"),
                        zoom = params.zoom;
                    if (flagSameScale) {
                        CWN2.app.map.setCenter(new OpenLayers.LonLat(lon,lat),zoom);
                    }
                    //scaleDiv.setHeight(50);
                    //scaleDiv.update('<span id="scale_span"><br>Scala Approssimata 1:' + CWN2.app.map.getScale() + '</span>');

                }

                CWN2.Util.ajaxRequest({
                    type: "JSON",
                    url: printConfigUrl,
                    callBack: function(response) {
                        var extent = (response.mapOptions.flagSameScale) ? null : response.mapOptions.extent,
                                mapDiv = Ext.get("map_div"),
                                scaleDiv = Ext.get("scale_div"),
                                titleDiv = Ext.get("title_div");

                        mapDiv.setWidth(response.printConfig.width);
                        mapDiv.setHeight(response.printConfig.height);

                        if (response.printConfig.title && response.printConfig.fileType === "pdf") {
                            titleDiv.setWidth(response.printConfig.width);
                            titleDiv.setHeight(50);
                            titleDiv.update('<span id="title_span">' + response.printConfig.title + '</span>');
                        } else {
                            mapDiv.setY(0);
                        }
                        scaleDiv.setWidth(response.printConfig.width);
                        scaleDiv.setHeight(30);
                        scaleDiv.update('<span id="scale_span"><br>Scala Approssimata 1:' + Math.round(parseFloat(response.mapOptions.scale)) + '</span>');

                        CWN2.app.load({
                            appConfig: {
                                "application": {
                                    "mapOptions": {
                                        projection: response.mapOptions.projection,
                                        initialExtent: extent,
                                        restrictedExtent: extent
                                    },
                                    "layout": {
                                        type: "panel",
                                        toolbar: false,
                                        statusbar: false,
                                        width: response.printConfig.width,
                                        height: response.printConfig.height
                                    },
                                },
                                "baseLayers": response.baseLayers,
                                "layers": response.layers
                            },
                            divID: "map_div",
                            //idMap: 1568,
                            debug: true,
                            callBack: setCenter,
                            callBackArgs: response.mapOptions,
                            disableLoadingScreen: true
                        });

                    }
                });


            } //eo launch
        });


    </script>


</head>

<body>
<div id="title_div"></div>
<div id="map_div"></div>
<div id="scale_div"></div>
</body>

</html>
		