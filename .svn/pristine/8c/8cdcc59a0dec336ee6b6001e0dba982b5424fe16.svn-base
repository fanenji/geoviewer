<!DOCTYPE HTML>

<html lang="it">
<head>
    <meta charset="utf-8">

    <title>GeoStyler</title>

    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/default/base.css"/>
    <link rel="stylesheet" type="text/css" href="colorField.css">

    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <script src="/geoviewer/lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='/geoviewer/lib/proj4js/lib/proj4js-min.js'></script>

    <script src="/geoviewer/lib/Cwn2/cwn2-debug.js"></script>

    <script src="/geoviewer/lib/Cwn2/deploy-config-ese.js"></script>

</head>
<body>

<script>



OpenLayers.Format.SLD.v1_0_0_GeoServer = OpenLayers.Class(
        OpenLayers.Format.SLD.v1_0_0, {

            /**
             * Property: version
             * {String} The specific parser version.
             */
            version: "1.0.0",

            /**
             * Property: profile
             * {String} The specific profile
             */
            profile: "GeoServer",

            /**
             * Constructor: OpenLayers.Format.SLD.v1_0_0_GeoServer
             * Create a new parser for GeoServer-enhanced SLD version 1.0.0.
             *
             * Parameters:
             * options - {Object} An optional object whose properties will be set on
             *     this instance.
             */

            /**
             * Property: readers
             * Contains public functions, grouped by namespace prefix, that will
             *     be applied when a namespaced node is found matching the function
             *     name.  The function will be applied in the scope of this parser
             *     with two arguments: the node being read and a context object passed
             *     from the parent.
             */
            readers: OpenLayers.Util.applyDefaults({
                "sld": OpenLayers.Util.applyDefaults({
                    "Priority": function(node, obj) {
                        var value = this.readers.ogc._expression.call(this, node);
                        if (value) {
                            obj.priority = value;
                        }
                    },
                    "VendorOption": function(node, obj) {
                        if (!obj.vendorOptions) {
                            obj.vendorOptions = {};
                        }
                        obj.vendorOptions[node.getAttribute("name")] = this.getChildValue(node);
                    },
                    "TextSymbolizer": function(node, rule) {
                        OpenLayers.Format.SLD.v1_0_0.prototype.readers.sld.TextSymbolizer.apply(this, arguments);
                        var symbolizer = this.multipleSymbolizers ? rule.symbolizers[rule.symbolizers.length - 1] : rule.symbolizer["Text"];
                        if (symbolizer.graphic === undefined) {
                            symbolizer.graphic = false;
                        }
                    },
                    "GraphicFill": function(node, symbolizer) {
                        symbolizer.graphicFill = true;
                        this.readChildNodes(node, symbolizer);
                    },
                    "GraphicStroke": function(node, symbolizer) {
                        symbolizer.graphicStroke = true;
                        this.readChildNodes(node, symbolizer);
                    }
                }, OpenLayers.Format.SLD.v1_0_0.prototype.readers["sld"])
            }, OpenLayers.Format.SLD.v1_0_0.prototype.readers),

            /**
             * Property: writers
             * As a compliment to the readers property, this structure contains public
             *     writing functions grouped by namespace alias and named like the
             *     node names they produce.
             */
            writers: OpenLayers.Util.applyDefaults({
                "sld": OpenLayers.Util.applyDefaults({
                    "Priority": function(priority) {
                        return this.writers.sld._OGCExpression.call(
                                this, "sld:Priority", priority
                        );
                    },
                    "VendorOption": function(option) {
                        return this.createElementNSPlus("sld:VendorOption", {
                            attributes: {name: option.name},
                            value: option.value
                        });
                    },
                    "TextSymbolizer": function(symbolizer) {
                        var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                        var node = writers["sld"]["TextSymbolizer"].apply(this, arguments);
                        if (symbolizer.graphic !== false && (symbolizer.externalGraphic || symbolizer.graphicName)) {
                            this.writeNode("Graphic", symbolizer, node);
                        }
                        if ("priority" in symbolizer) {
                            this.writeNode("Priority", symbolizer.priority, node);
                        }
                        return this.addVendorOptions(node, symbolizer);
                    },
                    "PointSymbolizer": function(symbolizer) {
                        var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                        var node = writers["sld"]["PointSymbolizer"].apply(this, arguments);
                        return this.addVendorOptions(node, symbolizer);
                    },
                    "LineSymbolizer": function(symbolizer) {
                        var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                        var node = writers["sld"]["LineSymbolizer"].apply(this, arguments);
                        return this.addVendorOptions(node, symbolizer);
                    },
                    "PolygonSymbolizer": function(symbolizer) {
                        var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                        var node = writers["sld"]["PolygonSymbolizer"].apply(this, arguments);
                        return this.addVendorOptions(node, symbolizer);
                    },
                    "Fill": function(symbolizer) {
                        var node;
                        if (symbolizer.graphicFill) {
                            node = this.createElementNSPlus("sld:Fill");
                            this.writeNode("GraphicFill", symbolizer, node);
                            ;
                        } else {
                            var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                            node = writers["sld"]["Fill"].apply(this, arguments);
                        }
                        return node;
                    },
                    "GraphicFill": function(symbolizer) {
                        var node = this.createElementNSPlus("sld:GraphicFill");
                        this.writeNode("Graphic", symbolizer, node);
                        return node;
                    },
                    "Stroke": function(symbolizer) {
                        var node;
                        if (symbolizer.graphicStroke) {
                            node = this.createElementNSPlus("sld:Stroke");
                            this.writeNode("GraphicStroke", symbolizer, node);
                            ;
                        } else {
                            var writers = OpenLayers.Format.SLD.v1_0_0.prototype.writers;
                            node = writers["sld"]["Stroke"].apply(this, arguments);
                        }
                        return node;
                    },
                    "GraphicStroke": function(symbolizer) {
                        var node = this.createElementNSPlus("sld:GraphicStroke");
                        this.writeNode("Graphic", symbolizer, node);
                        return node;
                    }

                }, OpenLayers.Format.SLD.v1_0_0.prototype.writers["sld"])
            }, OpenLayers.Format.SLD.v1_0_0.prototype.writers),

            /**
             * Method: addVendorOptions
             * Add in the VendorOption tags and return the node again.
             *
             * Parameters:
             * node - {DOMElement} A DOM node.
             * symbolizer - {Object}
             *
             * Returns:
             * {DOMElement} A DOM node.
             */
            addVendorOptions: function(node, symbolizer) {
                var options = symbolizer.vendorOptions;
                if (options) {
                    for (var key in symbolizer.vendorOptions) {
                        this.writeNode("VendorOption", {
                            name: key,
                            value: symbolizer.vendorOptions[key]
                        }, node);
                    }
                }
                return node;
            },

            CLASS_NAME: "OpenLayers.Format.SLD.v1_0_0_GeoServer"

        });

Ext.application({

    name: 'GeoStyler',

    getStyles: function(idMap) {
        if (!idMap) return;

        var format = new OpenLayers.Format.SLD({
            profile: "GeoServer",
            multipleSymbolizers: true,
            namedLayersAsArray: true,
            schemaLocation: "http://www.opengis.net/sld StyledLayerDescriptor.xsd"
        });

        var geoserverUrl = "/geoservices/REST/proxy/geoserver_sld?id=";

        var layersConfig = CWN2.app.map.layerManager.overlayLayersConfig;

        Ext.each(layersConfig, function(layer) {
            if (layer.geomType === "VECTOR") {
                CWN2.Util.ajaxRequest({
                    type: "XML",
                    url: geoserverUrl + layer.id,
                    callBack: function(sld) {
                        var data = format.read(sld);
                        layer.sld = data;
                    }
                });
            }
        });

    },

    launch: function() {

        var idMap = decodeURIComponent(CWN2.Util.getUrlParam('id'));
        if (idMap === "null") {
            idMap = null;
        }

        var layers = [];
        if (!idMap) {
            layers = [
                {
                    "id": 0,"name": "L0",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill None + Stroke WKN",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill None + Stroke WKN",
                            "symbolizers": [
                                {
                                    "fill": false,
                                    "stroke": true,
                                    "graphicStroke": true,
                                    "pointRadius": 6,
                                    "graphicName": "triangle",
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "strokeDashstyle": "5 2",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 1,"name": "L1",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill Simple + Stroke Simple",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Simple + Stroke Simple",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "fillColor": "#961E1E",
                                    "fillOpacity": "0.5",
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "strokeOpacity": "0.8",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 2,"name": "L2",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill Hatch + Stroke None",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Hatch + Stroke None",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "graphicFill": true,
                                    graphicName: "shape://times",
                                    pointRadius: 8,
                                    stroke: false,
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 3,"name": "L3",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / Fill ExternalGraphics",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill ExternalGraphics",
                            "symbolizers": [
                                {
                                    externalGraphic: "http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/images/pallinomezzopieno",
                                    fill: true,
                                    graphic: true,
                                    graphicFill: true,
                                    graphicFormat: "image/gif",
                                    pointRadius: 46.5,
                                    stroke: true,
                                    strokeColor: "#FFFFFF",
                                    strokeWidth: "2",
                                    zIndex: 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 4,"name": "L4",
                    "geomSubType": "POLYGON",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POLYGON / MultiRule",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/CONFINI/legenda/L1429.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/CONFINI/735.map&",
                        "name": "L1429",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Fill Simple / No Stroke",
                            "symbolizers": [
                                {
                                    "fill": true,
                                    "fillColor": "#961E1E",
                                    "stroke": false,
                                    "zIndex": 0
                                }
                            ]
                        },
                        {
                            "name": "R1",
                            "title": "Fill None",
                            "symbolizers": [
                                {
                                    "fill": false,
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 5,"name": "L5",
                    "geomSubType": "LINE",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "LINE / Simple",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L80.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/178.map&",
                        "name": "L80",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Simple",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 6,"name": "L6",
                    "geomSubType": "LINE",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "LINE / WKN - DashArray",
                        "icon": "http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L80.png"
                    },
                    "wmsParams": {
                        "url": "http://www.cartografiarl.regione.liguria.it/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/178.map&",
                        "name": "L80",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "WKN - DashArray",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    graphic: true,
                                    graphicStroke: true,
                                    graphicName: "circle",
                                    "strokeDashstyle": "5 2",
                                    "strokeColor": "#FF0000",
                                    "strokeDashstyle": "4 6",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 7,"name": "L7",
                    "geomSubType": "POINT",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POINT / WKN",
                        "icon": "http://dcarto3.datasiel.net/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L14.png"
                    },
                    "wmsParams": {
                        "url": "http://dcarto3.datasiel.net/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/36.map&",
                        "name": "L14",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "WKN",
                            "symbolizers": [
                                {
                                    "stroke": true,
                                    graphic: true,
                                    graphicStroke: true,
                                    graphicName: "circle",
                                    "strokeDashstyle": "5 2",
                                    "strokeColor": "#FF0000",
                                    "strokeWidth": "1",
                                    "zIndex": 0
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": 8,"name": "L8",
                    "geomSubType": "POINT",
                    "type": "WMS","visible": true,"projection": "EPSG:3003","geomType": "VECTOR",
                    "legend": {
                        "label": "POINT / Graphic",
                        "icon": "http://dcarto3.datasiel.net/mapfiles/repertoriocartografico/ACQUE_INTERNE/legenda/L14.png"
                    },
                    "wmsParams": {
                        "url": "http://dcarto3.datasiel.net/mapserver/mapserv.exe?MAP=E:/progetti/mapfiles/repertoriocartografico/ACQUE_INTERNE/36.map&",
                        "name": "L14",
                        "transparent": true,
                        "format": "image/png",
                        "format_options": "antialias:none"
                    },
                    "rules": [
                        {
                            "name": "R0",
                            "title": "Graphic",
                            "symbolizers": [
                                {
                                    graphic: true,
                                    externalGraphic: "http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/images/pallinomezzopieno",
                                    graphicFormat: "image/png",
                                    pointRadius: 16,
                                    zIndex: 0
                                }
                            ]
                        }
                    ]
                }


            ];
        }

        var config = {
            "application": {
                "mapOptions": {
                    "restrictedExtent": "830036,5402959,1123018,5597635"
                },
                "layout": {
                    "statusBar": true,
                    "legend": null,
                    "legend": {
                        "type": "simple",
                        "position": "east",
                        "collapsed": false
                    },
                    "widgets": [
                        { "name": "Scale" },
                        { "name": "CoordinateReadOut" }
                    ],
                    "toolbar": {
                        "itemGroups": [
                            {
                                "items": [
                                    { "name": "pan" },
                                    { "name": "zoomin" },
                                    { "name": "zoomout" },
                                    { "name": "fitall" },
                                    { "name": "zoomToInitialExtent" },
                                    { "name": "zoomprevious" },
                                    { "name": "zoomnext" }
                                ]
                            },
                            {
                                "name": "avanzate",
                                "items": [
                                    {"name": "geostyler", "options": { "idMap": idMap }}
                                ]
                            }
                        ]
                    }
                }
            },
            "baseLayers": [
                { "type": "no_base" },
                { "type": "bing_aerial", "visible": true},
                { "type": "rl_ortofoto_2013" }
            ],
            "layers": layers
        };

        CWN2.app.load({
            appConfig: config,
            divID: "cwn2_map",
            callBack: this.getStyles,
            callBackArgs: idMap,
            idMap: idMap,
            debug: true
        });

    } //eo launch

});


</script>

</body>
</html>
