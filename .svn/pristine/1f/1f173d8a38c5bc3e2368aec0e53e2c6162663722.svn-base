Ext.namespace("CWN2.Control");Ext.application({name:"CWN2",controllerList:["CWN2.controller.button.simpleLegend","CWN2.controller.button.loadlayers","CWN2.controller.button.removelayers","CWN2.controller.button.infowms","CWN2.controller.button.transparency","CWN2.controller.button.s3ricerche","CWN2.controller.button.redirect","CWN2.controller.button.routeplanner","CWN2.controller.button.selectfeature","CWN2.controller.button.coordinate","CWN2.controller.button.find","CWN2.controller.button.window","CWN2.controller.button.print","CWN2.controller.button.generic","CWN2.controller.button.geostyler","CWN2.controller.button.qpgtematismi","CWN2.controller.button.risknat","CWN2.controller.SimpleLegendGridPanel","CWN2.controller.TreeLegendGridPanel"],initOptions:null,configuration:{},id:null,map:null,layout:null,init:function(){},launch:function(){var a=this;Ext.each(this.controllerList,function(b){a.getController(b)})},load:function(b){CWN2.Util.log("CWN2.load");var a=this;if(!b.disableLoadingScreen){CWN2.loadingScreen=Ext.getBody().mask("Caricamento Applicazione","loadingscreen")}this.initOptions=b;CWN2.Globals.set(b);if(typeof b.appConfig==="string"){CWN2.Util.ajaxRequest({type:"JSONP",url:b.appConfig,callBack:function(c){a.setConfig(c);a.build(b)}})}else{a.setConfig(b.appConfig);a.build(b)}},setConfig:function(a){this.configuration=a||CWN2.Globals.DEFAULT_CONFIG;if(a&&a.application){this.configuration.application=a.application;if(a.application.mapOptions){this.configuration.application.mapOptions.projection=a.application.mapOptions.projection||CWN2.Globals.DEFAULT_CONFIG.application.mapOptions.projection;this.configuration.application.mapOptions.displayProjection=a.application.mapOptions.displayProjection||CWN2.Globals.DEFAULT_CONFIG.application.mapOptions.displayProjection;this.configuration.application.mapOptions.initialExtent=a.application.mapOptions.initialExtent||CWN2.Globals.DEFAULT_CONFIG.application.mapOptions.initialExtent}else{this.configuration.application.mapOptions=CWN2.Globals.DEFAULT_CONFIG.application.mapOptions}if(a.application.layout){this.configuration.application.layout.type=a.application.layout.type||CWN2.Globals.DEFAULT_CONFIG.application.layout.type}else{this.configuration.application.layout=CWN2.Globals.DEFAULT_CONFIG.application.layout}}else{this.configuration.application=CWN2.Globals.DEFAULT_CONFIG.application}if(a&&a.baseLayers&&a.baseLayers.length>0){this.configuration.baseLayers=a.baseLayers}else{this.configuration.baseLayers=CWN2.Globals.DEFAULT_CONFIG.baseLayers}Ext.each(this.configuration.baseLayers,function(b){b.legend=b.legend||{};b.name=b.name||b.type;if(CWN2.Globals.DEFAULT_BASE_LAYERS_LEGEND[b.type]){b.legend.label=b.legend.label||CWN2.Globals.DEFAULT_BASE_LAYERS_LEGEND[b.type].label;b.legend.icon=b.legend.icon||CWN2.Globals.DEFAULT_BASE_LAYERS_LEGEND[b.type].icon}});Ext.each(this.configuration.layers,function(b){b.legend=b.legend||{}})},build:function(b){var c,e=this.configuration;try{Ext.suspendLayouts();Ext.QuickTips.init();Ext.Ajax.disableCaching=false;this.layout=new CWN2.Layout(b.divID);this.layout.mapPanel.map.zoomToInitialExtent();if(b.idMap||b.idRequest||b.qpgRequest){CWN2.MapCatalogueLoader.loadMap(b)}else{if(b.idLayer){CWN2.MapCatalogueLoader.loadLayers(b)}else{this.removeLoadingScreen();this.callback(b)}}Ext.resumeLayouts(true);if(this.layout.mapPanel.pressedButton&&this.layout.mapPanel.pressedButton!=="pan"){CWN2.Util.log("Imposto selezione bottone: "+this.layout.mapPanel.pressedButton);var d=Ext.ComponentQuery.query("cwn2-button-"+this.layout.mapPanel.pressedButton)[0];if(d){d.getEl().dom.click()}else{CWN2.Util.handleException({message:"Bottone "+this.layout.mapPanel.pressedButton+" non esistente",level:0})}}}catch(a){CWN2.Util.handleException(a)}},callback:function(a){if(a.callBack){a.callBack(a.callBackArgs)}},showMapWindow:function(){this.layout.layout.show()},loadFeatures:function(a){var b=this.map.getLayerByName(a.layerName);if(b){a.layer=b;CWN2.FeatureLoader.loadFeatures(a)}},loadFeatureByAddress:function(a){var b=this.map.getLayerByName(a.layerName);if(b){a.layer=b;CWN2.FeatureLoader.loadFeatureByAddress(a)}},selectFeature:function(a){var b=this.map.getLayerByName(a.layerName);if(b){a.layer=b;CWN2.FeatureSelecter.selectFeature(a)}},unselectFeature:function(a){var b=this.map.getLayerByName(a.layerName);if(b){a.layer=b;CWN2.FeatureSelecter.unselectFeature(a)}},checkServiceException:function(a){if(a.exception){throw {name:"ServiceError",message:"CWN2.app: "+a.exception.message,level:2}}},checkConfig:function(a){CWN2.Util.assert(a,{name:"BadConfiguration",message:"CWN2.app.checkConfig: configuration deve essere valorizzato",level:2});CWN2.Util.assert(a.application,{name:"BadConfiguration",message:"CWN2.app.checkConfig: application deve essere valorizzato",level:2});CWN2.Util.assert(a.application.mapOptions,{name:"BadConfiguration",message:"CWN2.app.checkConfig: mapOptions deve essere valorizzato",level:2});CWN2.Util.assert(a.application.layout,{name:"BadConfiguration",message:"CWN2.app.checkConfig: layout deve essere valorizzato",level:2});CWN2.Util.assert(((a.application.layout.type==="simple")||(a.application.layout.type==="panel")||(a.application.layout.type==="window")||(a.application.layout.type==="viewport")),{name:"BadConfiguration",message:"CWN2.app.checkConfig: layout deve essere di tipo gestito (simple/panel/window/viewport)",level:2});CWN2.Util.assert(a.baseLayers,{name:"BadConfiguration",message:"CWN2.app.checkConfig: baseLayers deve essere valorizzato",level:2});CWN2.Util.assert(a.baseLayers.length>0,{name:"BadConfiguration",message:"CWN2.app.checkConfig: baseLayers deve contenere almeno un layer",level:2})},removeLoadingScreen:function(c){var a=c||2000;if(CWN2.loadingScreen&&CWN2.loadingScreen.dom){var b=new Ext.util.DelayedTask(function(){CWN2.loadingScreen.fadeOut({duration:1000,remove:true});CWN2.loadingScreen.next().fadeOut({duration:1000,remove:true})});b.delay(a)}},setButtonOption:function(b,c,d){var a=this.configuration.application.layout.toolbar.itemGroups;Ext.each(a,function(e){Ext.each(e.items,function(f){if(f.name.toLowerCase()===b.toLowerCase()){f.options=f.options||{};f.options[c]=d;return false}else{return true}})})},loadMap:function(a){CWN2.MapCatalogueLoader.loadMap(a)},findWMS:function(a){CWN2.MapCatalogueLoader.findWMS(a)}});Ext.define("CWN2.Util",{singleton:true,getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);return a?decodeURIComponent(a[1]):null},assert:function(b,a){if(!b){throw a}},handleException:function(a){CWN2.Util.log(a.message,a.level);(a.level>0)?CWN2.Util.msgBox(a.message,"ERROR"):null},log:function(a,d){if(!CWN2.Globals.debug){return}var b;switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info"}try{console[b](a)}catch(c){}},msgBox:function(e,c,d){var b=(c)?Ext.Msg[c]:Ext.Msg.INFO;var a=(d)||"Info";Ext.Msg.show({title:a,msg:e,icon:b,buttons:Ext.Msg.OK})},ajaxRequest:function(l){var h=l.type,a=l.url,c=l.urlParams,e=l.callBack,g=l.args,j=l.jsonData,d={};function k(m,n){var o;CWN2.app.removeLoadingScreen(100);switch(h){case"JSONP":o=m;break;case"JSON":o=Ext.JSON.decode(m.responseText,true);break;case"XML":if(window.ActiveXObject){o=new ActiveXObject("Microsoft.XMLDOM");o.async="false";o.loadXML(m.responseText)}else{o=new DOMParser().parseFromString(m.responseText,"text/xml")}break}if(!o){if(h==="XML"){d.message="CWN2.Util.ajaxRequest - la risposta del server non sembra un documento xml. \nControllare contentType della risposta \n(deve essere text/xml o application/xml "}else{d.message="CWN2.Util.ajaxRequest - "+m.responseText}d.level=2;CWN2.Util.handleException(d);return}if(!l.disableException&&o.success===false){d.message=o.message;d.level=2;CWN2.Util.handleException(d);return}e(o,m,g)}function b(m,o){CWN2.app.removeLoadingScreen(100);var n={};n.message=m.responseText;n.level=2;CWN2.Util.handleException(n)}var f={url:a,params:c,success:k,failure:b,jsonData:j};if(h==="JSONP"){Ext.data.JsonP.request(f)}else{f.headers={"Content-Type":"application/json; charset=UTF-8"};Ext.Ajax.request(f)}},parseXML:function(c){CWN2.Util.log("CWN2.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){throw {name:"xmlTransformation",message:"CWN2.Util.parseXml: errore parsing xml - "+a.message,level:1}}},transformStrBounds:function(c,h,a){CWN2.Util.log("CWN2.Util.transformStrBounds");if(c===h){return a}var g=new OpenLayers.Projection(c),e=new OpenLayers.Projection(h);var b=a;if(c==="EPSG:3003"){var d=b.split(",");d[0]=parseInt(d[0])-parseInt(40);d[2]=parseInt(d[2])-parseInt(40);d[1]=parseInt(d[1])+parseInt(120);d[3]=parseInt(d[3])+parseInt(120);b=d.join(",")}var f=new OpenLayers.Bounds.fromString(b);return f.transform(g,e).toString()},getArrayElementByAttribute:function(e,c,d){if(!e){return null}var a=e.length;for(var b=0;b<a;b++){if(e[b][c]===d){return e[b]}}return null},capitalizeString:function(a){return a.replace(/\w\S*/g,function(b){return b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()})},endsWith:function(b,a){return b.indexOf(a,b.length-a.length)!==-1},geoCode:function(a,b,c){new google.maps.Geocoder().geocode({address:a},function(g,e){if(e===google.maps.GeocoderStatus.OK){var d=g[0].geometry.location.lng();var j=g[0].geometry.location.lat();var f={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[d,j]},properties:{address:a}}]};if(b){for(var h in b){if(b.hasOwnProperty(h)){f.features[0].properties[h]=b[h]}}}c(f)}else{if(e===google.maps.GeocoderStatus.ZERO_RESULTS){CWN2.Util.msgBox("Indirizzo '"+a+"' non trovato")}else{CWN2.Util.handleException({name:"BadGeocoding",message:"Errore di geocoding: "+e,level:1})}}})},getXmlDoc:function(b){var a;if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";a.loadXML(b)}else{a=new DOMParser().parseFromString(b,"text/xml")}return a},transformFilterCQL2json:function(a){var d=new OpenLayers.Format.CQL().read(a);var c=new OpenLayers.Format.Filter.v1_0_0().write(d);var b=c.innerHTML.replace(/ogc:/g,"");return new X2JS().xml_str2json(b)},transformFilterJson2CQL:function(b){function c(f){for(i in f){if(typeof(f[i])=="object"){console.log(i,f[i]);c(f[i])}}}var e=new X2JS().json2xml(b);var a=new OpenLayers.Format.Filter.v1_1_0().read(e);var d=new OpenLayers.Format.CQL().write(a);return d},unescapeHtmlEntities:function(a){a=a.replace(/\&amp;/g,"&");a=a.replace(/\&quot;/g,'"');a=a.replace(/\&lt;/g,"<");a=a.replace(/\&gt;/g,">");return a},htmlDecode:function(c,g){function d(p,n){var k={},m={},j;var l={},h={};var q={},o={};l[0]="HTML_SPECIALCHARS";l[1]="HTML_ENTITIES";h[0]="ENT_NOQUOTES";h[2]="ENT_COMPAT";h[3]="ENT_QUOTES";q=!isNaN(p)?l[p]:p?p.toUpperCase():"HTML_SPECIALCHARS";o=!isNaN(n)?h[n]:n?n.toUpperCase():"ENT_COMPAT";if(q!=="HTML_SPECIALCHARS"&&q!=="HTML_ENTITIES"){throw new Error("Table: "+q+" not supported")}k["38"]="&amp;";if(q==="HTML_ENTITIES"){k["160"]="&nbsp;";k["161"]="&iexcl;";k["162"]="&cent;";k["163"]="&pound;";k["164"]="&curren;";k["165"]="&yen;";k["166"]="&brvbar;";k["167"]="&sect;";k["168"]="&uml;";k["169"]="&copy;";k["170"]="&ordf;";k["171"]="&laquo;";k["172"]="&not;";k["173"]="&shy;";k["174"]="&reg;";k["175"]="&macr;";k["176"]="&deg;";k["177"]="&plusmn;";k["178"]="&sup2;";k["179"]="&sup3;";k["180"]="&acute;";k["181"]="&micro;";k["182"]="&para;";k["183"]="&middot;";k["184"]="&cedil;";k["185"]="&sup1;";k["186"]="&ordm;";k["187"]="&raquo;";k["188"]="&frac14;";k["189"]="&frac12;";k["190"]="&frac34;";k["191"]="&iquest;";k["192"]="&Agrave;";k["193"]="&Aacute;";k["194"]="&Acirc;";k["195"]="&Atilde;";k["196"]="&Auml;";k["197"]="&Aring;";k["198"]="&AElig;";k["199"]="&Ccedil;";k["200"]="&Egrave;";k["201"]="&Eacute;";k["202"]="&Ecirc;";k["203"]="&Euml;";k["204"]="&Igrave;";k["205"]="&Iacute;";k["206"]="&Icirc;";k["207"]="&Iuml;";k["208"]="&ETH;";k["209"]="&Ntilde;";k["210"]="&Ograve;";k["211"]="&Oacute;";k["212"]="&Ocirc;";k["213"]="&Otilde;";k["214"]="&Ouml;";k["215"]="&times;";k["216"]="&Oslash;";k["217"]="&Ugrave;";k["218"]="&Uacute;";k["219"]="&Ucirc;";k["220"]="&Uuml;";k["221"]="&Yacute;";k["222"]="&THORN;";k["223"]="&szlig;";k["224"]="&agrave;";k["225"]="&aacute;";k["226"]="&acirc;";k["227"]="&atilde;";k["228"]="&auml;";k["229"]="&aring;";k["230"]="&aelig;";k["231"]="&ccedil;";k["232"]="&egrave;";k["233"]="&eacute;";k["234"]="&ecirc;";k["235"]="&euml;";k["236"]="&igrave;";k["237"]="&iacute;";k["238"]="&icirc;";k["239"]="&iuml;";k["240"]="&eth;";k["241"]="&ntilde;";k["242"]="&ograve;";k["243"]="&oacute;";k["244"]="&ocirc;";k["245"]="&otilde;";k["246"]="&ouml;";k["247"]="&divide;";k["248"]="&oslash;";k["249"]="&ugrave;";k["250"]="&uacute;";k["251"]="&ucirc;";k["252"]="&uuml;";k["253"]="&yacute;";k["254"]="&thorn;";k["255"]="&yuml;"}if(o!=="ENT_NOQUOTES"){k["34"]="&quot;"}if(o==="ENT_QUOTES"){k["39"]="&#39;"}k["60"]="&lt;";k["62"]="&gt;";for(j in k){if(k.hasOwnProperty(j)){m[String.fromCharCode(j)]=k[j]}}return m}var f={},e="",a="",b="";a=c.toString();if(false===(f=d("HTML_ENTITIES",g))){return false}delete (f["&"]);f["&"]="&amp;";for(e in f){b=f[e];a=a.split(b).join(e)}a=a.split("&#039;").join("'");a=t_str.split("&#39;").join("'");return a}});Ext.define("CWN2.I18n",{singleton:true,dict:{Scala:{en:"Scale"},"Coordinate:":{en:"Coordinates:"},Ricerche:{en:"Find"},Attenzione:{en:"Attention"},"Nessun indirizzo indicato":{en:"No Address"},"Il punto è fuori dai limiti geografici della mappa":{en:"Address is outside the map boundary"},Indirizzo:{en:"Address"},Vai:{en:"OK"},Annulla:{en:"Cancel"},"Aggiunta Livelli":{en:"Add Layers"},"Zoom alla massima estensione":{en:"Zoom to max extension"},"Zoom alla estensione iniziale":{en:"Zoom to initial extension"},Temi:{en:"Themes"},Aggiungi:{en:"Add"},"Nessun livello selezionato":{en:"No layer selected"},"Misure Areali":{en:"Measure Area"},Area:{en:"Area"},"Misure Lineari":{en:"Measure Line"},Distanza:{en:"Distance"},Pan:{en:"Pan"},"Togli Livelli":{en:"Remove Layers"},"Seleziona i livelli da eliminare":{en:"Select the layers to remove"},"Calcolo Percorsi":{en:"Route Planner"},Mezzo:{en:"Mode"},"In auto":{en:"Driving"},"A piedi":{en:"Walking"},Invio:{en:"OK"},"Inverti direzione":{en:"Swap"},"Seleziona punto di partenza sulla mappa":{en:"Select start point on map"},"Seleziona punto di arrivo sulla mappa":{en:"Select end point on map"},"Distanza totale":{en:"Distance"},"Durata totale":{en:"Duration"},Calcola:{en:"OK"},Reset:{en:"Reset"},"Zoom In":{en:"Zoom In"},"Zoom Successivo":{en:"Zoom Next"},"Zoom Out":{en:"Zoom Out"},"Zoom Precedente":{en:"Zoom Previous"},Trasparenza:{en:"Transparency"},Sfondi:{en:"Base Layer"},Livelli:{en:"Overlays"},"":{en:""}},get:function get(a){if(CWN2.I18n.dict[a]){return CWN2.I18n.dict[a][CWN2.Globals.language]||a}else{return a}}});Ext.define("CWN2.BaseLayersComboBox",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-base-layers-combobox",queryMode:"local",displayField:"legendLabel",valueField:"name",triggerAction:"all",editable:false,width:150,constructor:function(b){this.store=CWN2.app.map.layerManager.baseLayerStore;this.superclass.constructor.call(this,b);var a;Ext.each(CWN2.app.map.layerManager.baseLayersConfig,function(c){if(c.visible===true){a=c.name;return false}});this.setValue(a);this.on({select:this.onSelect,scope:this})},onSelect:function(c,a,b){CWN2.app.map.setBaseLayerOnMap(a[0].data.name)}});Ext.define("CWN2.Editor",{singleton:true,createEditingLayer:function createEditingLayer(e,d){CWN2.Util.log("CWN2.Editor.createEditingLayer ");var b=(d)?{filter:null,styleMaps:d}:c();var a=e.layerManager.createVectorLayer({name:"editingLayer",format:"GeoJSON",classes:b});a.events.on({beforefeaturemodified:function(){e.featureManager.deactivateControls()},afterfeaturemodified:function(){e.featureManager.activateControls()}});return a;function c(){var f=[{renderIntent:"default",style:{pointRadius:6,fillColor:"#ee9900",fillOpacity:0,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"}},{renderIntent:"select",style:{pointRadius:6,fillColor:"blue",fillOpacity:0,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer"}},{renderIntent:"hover",style:{pointRadius:6,fillColor:"blue",fillOpacity:0,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer"}},{renderIntent:"temporary",style:{fillColor:"#66cccc",fillOpacity:0,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"}}];return[{filter:null,styleMaps:f}]}},getEditingGeom:function getEditingGeom(g,f){CWN2.Util.log("CWN2.Editor.getEditingGeom ");var b=g.getLayerByName("editingLayer");if(b.features.length===0){return null}if(b.features.length===1){if(f==="WKT"){if(g.projection!==g.displayProjection){return b.features[0].geometry.clone().transform(g.projection,g.displayProjection).toString()}else{return b.features[0].geometry.toString()}}else{return e(g,b.features[0].geometry)}}if(b.features.length>1){var d=[],a=b.features.length;for(var c=0;c<a;c++){if(f==="WKT"){if(g.projection!==g.displayProjection){d.push(b.features[0].geometry.clone().transform(g.projection,g.displayProjection).toString())}else{d.push(b.features[0].geometry.toString())}}else{d.push(e(g,b.features[c].geometry))}}return d}function e(k,l){if(k.projection!==k.displayProjection){l=l.clone().transform(k.projection,k.displayProjection)}var j=new OpenLayers.Format.GeoJSON();var h=j.write(l);return Ext.JSON.decode(h)}},getAreaGeom:function getAreaGeom(e){var b=e.getLayerByName("editingLayer");var a=b.features.length;var d=0;for(var c=0;c<a;c++){d=d+b.features[0].geometry.getArea("m")}return d},getGeometryBounds:function getGeometryBounds(c){var a=c.getLayerByName("editingLayer");if(a.features.length===1){var b=a.features[0].geometry.bounds;if(c.projection!==c.displayProjection){return b.transform(new OpenLayers.Projection(c.projection),c.displayProjection)}else{return b}}else{return null}}});Ext.define("CWN2.FeatureLoader",{singleton:true,loadFeatures:function(f){CWN2.Util.log("CWN2.FeatureLoader.loadFeatures");try{CWN2.Util.assert(f,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatures: oggetto di configurazione deve essere valorizzato",level:1});CWN2.Util.assert(f.layer,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatures: Layer non trovato",level:1});CWN2.Util.assert(f.url||f.features,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatures: url o features devono essere valorizzati",level:1})}catch(h){throw h}var c=f.features,b,g=f.layer;if(f.layerLegendUrl){var l=g.styleMap.styles;for(var j in l){var k=l[j].rules[0];k.symbolizer.externalGraphic=f.layerLegendUrl}}if(f.customFeatureImg){var a=new OpenLayers.Style({externalGraphic:"${img}",graphicTitle:g.styleMap.styles["default"].rules[0].symbolizer.graphicTitle,graphicWidth:g.styleMap.styles["default"].rules[0].symbolizer.graphicWidth,graphicHeight:g.styleMap.styles["default"].rules[0].symbolizer.graphicHeight,graphicOpacity:g.styleMap.styles["default"].rules[0].symbolizer.graphicOpacity,graphicXOffset:g.styleMap.styles["default"].rules[0].symbolizer.graphicXOffset,graphicYOffset:g.styleMap.styles["default"].rules[0].symbolizer.graphicYOffset});g.styleMap=new OpenLayers.StyleMap(a)}g.loadend=false;try{if(c){CWN2.FeatureLoader.loadFeaturesCB(c,f)}if(f.url){CWN2.Util.ajaxRequest({type:"JSONP",url:f.url,callBack:function(e){CWN2.FeatureLoader.loadFeaturesCB(e,f)}})}}catch(d){CWN2.Util.handleException(d)}},loadFeatureByAddress:function(a){CWN2.Util.log("CWN2.FeatureLoader.loadFeatureByAddress");try{CWN2.Util.assert(a,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatureByAddress: oggetto di configurazione deve essere valorizzato",level:1});CWN2.Util.assert(a.layer,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatureByAddress: Layer non trovato",level:1});CWN2.Util.assert(a.address,{name:"BadParameter",message:"CWN2.FeatureLoader.loadFeatureByAddress: indirizzo deve essere valorizzato",level:1})}catch(c){throw c}a.layer.loadend=false;try{CWN2.Util.geoCode(a.address,{infoPopUp:a.html,label:a.address,tooltip:a.address},function(d){CWN2.FeatureLoader.loadFeaturesCB(d,a)})}catch(b){CWN2.Util.handleException(b)}},loadMarker:function(a){var c,g=a.label||null,h=a.x,f=a.y,e=a.epsgCode,b=a.map,d=a.zoomLevel,j=new OpenLayers.Geometry.Point(h,f);if(e&&e!==b.projection){j.transform(new OpenLayers.Projection(e),new OpenLayers.Projection(b.projection))}var k=new OpenLayers.Feature.Vector(j,{label:g},{cursor:"pointer",pointRadius:10,externalGraphic:"http://geoportale.regione.liguria.it/geoviewer/stili/default/icons/marker_blue.png",graphicTitle:g,label:g,graphicOpacity:1,graphicWidth:25,graphicHeight:41,graphicYOffset:-41});c=b.layerManager.createVectorLayer({name:"findLayer"});c.destroyFeatures();c.addFeatures([k]);c.redraw();c.map.zoomToFeatures([k],d)},loadFeaturesCB:function(e,b){try{var a=b.options||{zoom:true,zoomLevel:16,clean:false},d=b.layer,f=new OpenLayers.Format.GeoJSON({internalProjection:new OpenLayers.Projection(d.map.projection),externalProjection:d.projection}).read(e);if(a.clean){d.destroyFeatures()}d.addFeatures(f);d.redraw();if(a.zoom){d.map.zoomToFeatures(f,a.zoomLevel)}if(a.setInitialExtent){d.map.initialExtent=d.map.getExtent()}}catch(c){throw {name:"BadFeatureFormat",message:"CWN2.FeatureLoader.loadFeatures: Non sono riuscito a caricare le feature",level:1}}finally{d.events.triggerEvent("loadend")}}});Ext.define("CWN2.FeatureManager",{selectFeatureControl:null,hoverFeatureControl:null,map:null,registeredCallbacks:{onFeatureSelect:[],onFeatureUnselect:[],onFeatureOver:[],onFeatureOut:[]},registerCallback:function(a,b){this.registeredCallbacks[a].push(b)},getRegisteredCallbacks:function(a){return this.registeredCallbacks[a]},activateHoverFeatureControl:function(e){var b=function(f,g){Ext.each(g,function(h){if(typeof h==="function"){h(f)}})};var c=function(f,g){Ext.each(g,function(h){if(typeof h==="function"){h(f)}})};var d=this.getRegisteredCallbacks("onFeatureOut");var a=this.getRegisteredCallbacks("onFeatureOver");this.hoverFeatureControl=new OpenLayers.Control.SelectFeature(e,{hover:true,renderIntent:"hover",highlightOnly:true,eventListeners:{featurehighlighted:function(f){b(f.feature,a)},featureunhighlighted:function(f){c(f.feature,d)}}});this.hoverFeatureControl.name="hoverFeatureControl";this.map.addControl(this.hoverFeatureControl);this.hoverFeatureControl.activate()},activateSelectFeatureControl:function(c){var b=function(f,g){CWN2.InfoPopupManager.onFeatureSelect(f);Ext.each(g,function(h){if(typeof h==="function"){h(f)}})};var a=function(f,g){CWN2.InfoPopupManager.onFeatureUnselect(f);Ext.each(g,function(h){if(typeof h==="function"){h(f)}})};var d=this.getRegisteredCallbacks("onFeatureSelect");var e=this.getRegisteredCallbacks("onFeatureUnselect");this.selectFeatureControl=new OpenLayers.Control.SelectFeature(c);this.selectFeatureControl.onSelect=function(f){b(f,d)};this.selectFeatureControl.onUnselect=function(f){a(f,e)};this.selectFeatureControl.name="selectFeatureControl";this.map.addControl(this.selectFeatureControl);this.selectFeatureControl.activate()},registerLayerAction:function(a){var d=this,c,e,f,b;Ext.each(a,function(g){if(g.actions&&g.actions.length>0){Ext.each(g.actions,function(h){c=g.action.event;if(!c){b={name:"BadAction",message:"CWN2.FeatureManager.registerLayerAction: event non definito",level:1};CWN2.util.handleException(b);return false}e=g.action.callback;if(!e){b={name:"BadAction",message:"CWN2.FeatureManager.registerLayerAction: calback non definito",level:1};CWN2.util.handleException(b);return false}f=CWN2.FeatureManager.layerActionsRegistry[e];if(typeof f!=="function"){b={name:"BadCallbackName",message:"CWN2.FeatureManager.registerLayerAction: funzione di callback "+e+" non esiste",level:1};CWN2.util.handleException(b);return false}d.registerCallback(g.action.event,f)})}})},updateControlLayer:function(){var a=this.map.getLayersByClass("OpenLayers.Layer.Vector");this.hoverFeatureControl.setLayer(a);this.selectFeatureControl.setLayer(a)},activateControls:function(){this.hoverFeatureControl.activate();this.selectFeatureControl.activate()},deactivateControls:function(){this.hoverFeatureControl.deactivate();this.selectFeatureControl.deactivate()},constructor:function(b){this.map=b;var a=b.getLayersByClass("OpenLayers.Layer.Vector");this.activateHoverFeatureControl(a);this.activateSelectFeatureControl(a);this.registerLayerAction(b.layerManager.getLayersConfig())},statics:{layerActionsRegistry:{testOver:function(a){CWN2.Util.log(a)},testOut:function(a){CWN2.Util.log(a)},testSelect:function(a){CWN2.Util.log(a)},testUnselect:function(a){CWN2.Util.log(a)}}}});Ext.define("CWN2.FeatureSelecter",{singleton:true,selectFeature:function selectFeature(k,o){try{CWN2.Util.assert(k,{name:"BadParameter",message:"CWN2.featureSelected.selectFeature: selectConfig deve essere valorizzato",level:1});CWN2.Util.assert(k.layer,{name:"BadParameter",message:"CWN2.featureSelected.selectFeature: layer deve essere valorizzato",level:1});CWN2.Util.assert(o||k.attrName,{name:"BadParameter",message:"CWN2.featureSelected.selectFeature: attrName (oppure feature) deve essere valorizzato",level:1});CWN2.Util.assert((o||(k.item!==null&&k.item!==undefined)),{name:"BadParameter",message:"CWN2.featureSelected.selectFeature: item (oppure feature) deve essere valorizzato",level:1})}catch(g){throw g}var d=k.layer,h=k.attrName,m=k.item,p=k.options||{zoom:false,hiliteOnly:false},n=p.zoom,a=p.maxZoomLevel,l=p.hiliteOnly,c=p.multiSelect,b,f;if(o){f=o}else{b=d.getFeaturesByAttribute(h,m);if(b.length>0){f=b[0]}}if(f){if(l){d.map.featureManager.hoverFeatureControl.highlight(f)}else{var j=d.map.featureManager.selectFeatureControl;if(!c){j.unselectAll()}j.select(f)}if(n){d.map.zoomToFeatures([f],a)}}},unselectFeature:function unselectFeature(h,l){try{CWN2.Util.assert(h,{name:"BadParameter",message:"CWN2.featureSelected.unselectFeature: selectConfig deve essere valorizzato",level:1});CWN2.Util.assert(h.layer,{name:"BadParameter",message:"CWN2.featureSelected.unselectFeature: layer deve essere valorizzato",level:1});CWN2.Util.assert(l||h.attrName,{name:"BadParameter",message:"CWN2.featureSelected.unselectFeature: attrName (oppure feature) deve essere valorizzato",level:1});CWN2.Util.assert(l||h.item,{name:"BadParameter",message:"CWN2.featureSelected.unselectFeature: item (oppure feature) deve essere valorizzato",level:1})}catch(f){throw f}var c=h.layer,g=h.attrName,j=h.item,m=h.options||{hiliteOnly:false},k=m.hiliteOnly,a,d,b={};if(l){d=l}else{a=c.getFeaturesByAttribute(g,j);if(a.length>0){d=a[0]}}if(d){if(k){c.map.featureManager.hoverFeatureControl.unhighlight(d);if(d.isSelected()){b.layer=h.layer;b.attrName=h.attrName;b.item=h.item;b.options={hiliteOnly:false};selectFeature(b,d)}}else{c.map.featureManager.selectFeatureControl.unselect(d)}}}});Ext.define("CWN2.GeocoderComboBox",{extend:"GeoExt.form.field.GeocoderComboBox",alias:"widget.cwn2-geocoder-combobox",constructor:function(b){var a=b.service;if(a==="google"){this.url=CWN2.Globals.GOOGLE_GEOCODE_PROXY;this.queryParam="address";this.store=Ext.create("Ext.data.Store",{root:"results",fields:[{name:"name",convert:function(d,e){if(e.raw.results&&e.raw.results[0]){return e.raw.results[0].formatted_address}else{return null}}},{name:"lonlat",convert:function(d,f){if(f.raw.results&&f.raw.results[0]){var e=f.raw.results[0].geometry.location;return[e.lng,e.lat]}else{return null}}},{name:"bounds",convert:function(e,g){if(g.raw.results&&g.raw.results[0]){var f=g.raw.results[0].geometry.viewport.northeast,d=g.raw.results[0].geometry.viewport.southwest;return[d.lng,d.lat,f.lng,f.lat]}else{return null}}}],proxy:Ext.create("Ext.data.proxy.JsonP",{url:this.url,type:"JsonP",callbackKey:"callback"})})}this.minChars=4;b.emptyText="Ricerca indirizzo...";if(b.hilite!==false){var c=new OpenLayers.Layer.Vector("Location",{styleMap:new OpenLayers.Style({externalGraphic:(b.configOptions&&b.configOptions.externalGraphics)?b.configOptions.externalGraphics:"http://geoportale.regione.liguria.it/geoviewer/stili/default/icons/marker_blue.png",graphicYOffset:(b.configOptions&&b.configOptions.graphicYOffset)?b.configOptions.graphicYOffset:-27,graphicHeight:(b.configOptions&&b.configOptions.graphicHeight)?b.configOptions.graphicHeight:27,graphicWidth:(b.configOptions&&b.configOptions.graphicWidth)?b.configOptions.graphicWidth:17,graphicTitle:"${name}"})});if(b.map){b.map.addLayer(c)}this.layer=c}this.superclass.constructor.call(this,b);this.on({beforeselect:this.beforeSelect,scope:this})},beforeSelect:function(){if(this.layer){this.layer.destroyFeatures()}},handleSelect:function(c,d){if(this.map.restrictedExtent){var b=this.getValue();var a;if(b.length===4){a=OpenLayers.Bounds.fromArray(b).getCenterLonLat()}else{a=OpenLayers.LonLat.fromArray(b)}if(!this.map.isPointInMaxExtent(a.lat,a.lon)){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Il punto è fuori dai limiti geografici della mappa"));return}}this.superclass.handleSelect.call(this,c,d)},setMap:function(a){if(a instanceof GeoExt.panel.Map){a=a.map}this.map=a}});Ext.define("CWN2.Globals",{singleton:true,language:"it",debug:false,proxy:null,DEFAULT_PROXY:"/geoservices/proxy/proxy.jsp?url=",OL_IMG_PATH:"http://geoportale.regione.liguria.it/geoviewer/lib/OpenLayers/img/",BING_MAPS_KEY:"Agzh6x2xuNQ4qhwHW_yc0Yd8vhb-5pMRsAHjkneosLHLesOAGqxv35yqxZBlqqVa",RL_MAP_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/map/",RL_AG_REQUEST_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/ag_request/",RL_LAYER_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/layer/",RL_CREATE_SLD_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/create_sld/",GOOGLE_GEOCODE_PROXY:"http://geoportale.regione.liguria.it/geoservices/REST/proxy/google_geocode?region=it&language=it&sensor=false&bounds=7.43,43.75|10.00,44.70",INFO_WMS_MAX_FEATURES:10,BASE_RESOLUTIONS:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338],DEFAULT_CONFIG:{application:{mapOptions:{projection:"EPSG:3857",displayProjection:"EPSG:25832",initialExtent:"830036,5402959,1123018,5597635"},layout:{type:"viewport"}},baseLayers:[{type:"bing_aerial",legend:{label:"Bing Aerial",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/bing.jpeg"},visible:false}]},DEFAULT_BASE_LAYERS_LEGEND:{no_base:{label:"Sfondo Bianco",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/bianco.gif"},OSM:{label:"OpenStreetMap",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/openstreetmap.png"},google_roadmap:{label:"Google Stradario",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},google_hybrid:{label:"Google Ibrido",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},google_terrain:{label:"Google Terreno",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},google_satellite:{label:"Google Satellite",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},bing_road:{label:"Bing Road",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/bing.jpeg"},bing_hybrid:{label:"Bing Hybrid",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/bing.jpeg"},bing_aerial:{label:"Bing Aerial",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/bing.jpeg"},rl_ortofoto_2000:{label:"Ortofoto IT 2000",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/sfondi_rl.jpg"},rl_ortofoto_2007:{label:"Ortofoto 2007",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/sfondi_rl.jpg"},rl_ortofoto_2010:{label:"AGEA: Ortofoto 2010",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/sfondi_rl.jpg"},rl_ortofoto_2013:{label:"AGEA: Ortofoto 2013",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/sfondi_rl.jpg"},rl_carte_base:{label:"Carte di base regionali",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/sfondi_rl.jpg"}},DEFAULT_RENDER_INTENTS:["default","select","hover","temporary"],MAP_BASE_CONTROL_CONFIG:[{type:"control",name:"ArgParser"},{type:"control",name:"Attribution"},{type:"control",name:"KeyboardDefaults"},{type:"control",name:"Navigation"},{type:"control",name:"LoadingPanel"}],RUOLO:"PUBBLICO",COLOR_SCALES:{Rosso:{3:["#fee0d2","#fc9272","#de2d26"],4:["#fee5d9","#fcae91","#fb6a4a","#cb181d"],5:["#fee5d9","#fcae91","#fb6a4a","#de2d26","#a50f15"],6:["#fee5d9","#fcbba1","#fc9272","#fb6a4a","#de2d26","#a50f15"],7:["#fee5d9","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#99000d"],8:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#99000d"],9:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"]},Blu:{3:["#deebf7","#9ecae1","#3182bd"],4:["#eff3ff","#bdd7e7","#6baed6","#2171b5"],5:["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"],6:["#eff3ff","#c6dbef","#9ecae1","#6baed6","#3182bd","#08519c"],7:["#eff3ff","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#084594"],8:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#084594"],9:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"]},Verde:{3:["#e5f5e0","#a1d99b","#31a354"],4:["#edf8e9","#bae4b3","#74c476","#238b45"],5:["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"],6:["#edf8e9","#c7e9c0","#a1d99b","#74c476","#31a354","#006d2c"],7:["#edf8e9","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#005a32"],8:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#005a32"],9:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"]},Grigio:{3:["#f0f0f0","#bdbdbd","#636363"],4:["#f7f7f7","#cccccc","#969696","#525252"],5:["#f7f7f7","#cccccc","#969696","#636363","#252525"],6:["#f7f7f7","#d9d9d9","#bdbdbd","#969696","#636363","#252525"],7:["#f7f7f7","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525"],8:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525"],9:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"]},Random:{3:["#377eb8","#4daf4a","#e41a1c"],4:["#377eb8","#4daf4a","#e41a1c","#984ea3"],5:["#377eb8","#4daf4a","#e41a1c","#984ea3","#ff7f00"],6:["#377eb8","#4daf4a","#e41a1c","#984ea3","#ff7f00","#ffff33"],7:["#377eb8","#4daf4a","#e41a1c","#984ea3","#ff7f00","#ffff33","#a65628"],8:["#377eb8","#4daf4a","#e41a1c","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf"],9:["#377eb8","#4daf4a","#e41a1c","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"]}},set:function(a){CWN2.Globals.debug=((a.debug)||(CWN2.Util.getUrlParam("debug")==="true"));CWN2.Globals.proxy=a.proxy||CWN2.Globals.DEFAULT_PROXY;CWN2.Globals.language=a.language||"it";OpenLayers.ProxyHost=CWN2.Globals.proxy;OpenLayers.Layer.Vector.prototype.renderers=["SVG2","SVG","VML","Canvas"];OpenLayers.ImgPath=CWN2.Globals.OL_IMG_PATH}});Ext.define("CWN2.IframeWindow",{extend:"Ext.window.Window",alias:"widget.cwn2-iframe-window",layout:"fit",renderTo:window.document.body,renderSelectors:{iframeEl:"iframe"},loadDocument:function(b){var a=this.iframeEl;if(a){a.set({src:b})}},constructor:function(b){var a={height:b.height||400,width:b.width||600,items:[{xtype:"box",autoEl:{tag:"iframe",src:b.url}}],id:b.id,resizable:(b.resizable===false)?false:true,listeners:b.listeners};this.superclass.constructor.call(this,a);Ext.WindowManager.register(this);Ext.WindowManager.bringToFront(this)}});Ext.define("CWN2.InfoPopupManager",{singleton:true,onFeatureSelect:function(b){var a=CWN2.InfoPopupManager.getConfigOptions(b);if(a.infoPopUp){CWN2.InfoPopupManager.loadPopUp(b,a)}else{if(a.infoUrl){CWN2.InfoPopupManager.info(b,a)}}},onFeatureUnselect:function(a){CWN2.InfoPopupManager.destroyPopup(a)},getConfigOptions:function(b){var a={};a.layerName=b.layer.name;a.layerConfig=b.layer.map.layerManager.getLayerConfigByName(a.layerName)||{};a.infoOptions=a.layerConfig.infoOptions||{infoLabelAttr:null,infoUrl:null,infoTarget:null,infoWidth:null,infoHeight:null,infoPopUp:null};a.infoLabelAttr=b.attributes.infoLabelAttr||a.infoOptions.infoLabelAttr;a.infoUrl=b.attributes.infoUrl||a.infoOptions.infoUrl;a.infoTarget=b.attributes.infoTarget||a.infoOptions.infoTarget;a.infoWidth=b.attributes.infoWidth||a.infoOptions.infoWidth;a.infoHeight=b.attributes.infoHeight||a.infoOptions.infoHeight;a.infoPopUp=b.attributes.infoPopUp||a.infoOptions.infoPopUp;return a},info:function(d,a){var c=OpenLayers.Style.createLiteral(a.infoUrl,d.attributes,d);var f=d.layer.map;if(a.infoTarget){if(a.infoTarget==="panel"){var g="layerInfoMediaWin";var e=new CWN2.IframeWindow({url:c,width:a.infoWidth,height:a.infoHeight,id:g,resizable:false}).show();e.on("destroy",function(){f.featureManager.selectFeatureControl.unselect(this)},d)}else{var b="status=yes, toolbar=yes, menubar=no, width="+a.infoWidth+", height="+a.infoHeight+", resizable=yes, scrollbars=yes";window.open(c,a.infoTarget,b)}}else{window.document.location.href=c}},loadPopUp:function(j,g){var a=(g.infoPopUp==="simple")?CWN2.InfoPopupManager.buildSimplePopup(j,g):(g.infoPopUp==="default")?CWN2.InfoPopupManager.buildDefaultPopup(g):g.infoPopUp;var d=g.infoWidth||150,e=g.infoHeight||100,h=300,f=200,b=true,c;if(j.cluster){if(j.attributes.count>1){a=CWN2.InfoPopupManager.buildClusterPopup(g,j)}else{j.attributes=j.cluster[0].attributes;j.attributes.count=1}}a=OpenLayers.Style.createLiteral(a,j.attributes,j);a=CWN2.Util.unescapeHtmlEntities(a);c=new OpenLayers.Popup.FramedCloud("featurePopup",j.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(d,e),a,null,b,function(k){this.feature.layer.map.featureManager.selectFeatureControl.unselect(this.feature)});c.maxSize=new OpenLayers.Size(h,f);c.autoSize=false;if(!j.popup){j.popup=c;c.feature=j;c.panMapIfOutOfView=true;c.backgroundColor="#BBCCFF";c.opacity=0.9;j.layer.map.addPopup(c)}},buildDefaultPopup:function(a){var b="<div class='defaultPopUpTitle'>"+a.layerConfig.legend.label+"<br><br></div>";b+="<div class='defaultPopUpLabel'>${"+a.infoLabelAttr+"}<br><br></div>";if(a.infoUrl){b+="<div class='defaultPopUpLink'><a href="+a.infoUrl;if(a.infoTarget){b+=" target='"+a.infoTarget+"'"}b+=">Dettagli</a></div>"}return b},buildSimplePopup:function(c,a){var b="<div class='defaultPopUpTitle'>"+a.layerConfig.legend.label+"<br><br></div>";b+="<div class='defaultPopUpLabel'>";Ext.iterate(c.attributes,function(d,e){b+=d+":"+e+"<br>"});b+="</div>";return b},buildClusterPopup:function(a,c){var d=c.layer.map.appId;var b=c.layer.name;var e=c.id;var f="<div class='defaultPopUpTitle'>"+a.layerConfig.legend.label+"<br><br></div>";f+="<div class='defaultPopUpLabel'>"+c.attributes.count+" Elementi<br><br></div>";f+="<div class='defaultPopUpLink'>";f+="<a href=javascript:CWN2.InfoPopupManager.zoomClusterPopup("+d+","+c.geometry.x+","+c.geometry.y+",'"+b+"','"+e+"')>Zoom</a></div>";return f},zoomClusterPopup:function(d,a,f,b,e){var c=CWN2.app.map;CWN2.InfoPopupManager.destroyPopup(c.getLayerByName(b).getFeatureById(e));c.setCenter(new OpenLayers.LonLat(a,f),c.zoom+2)},destroyPopup:function(b){if(b.popup){var c=b.layer.map;var a=b.popup;a.feature=null;c.removePopup(b.popup);b.popup.destroy();b.popup=null}}});Ext.define("CWN2.LayerFactory",{singleton:true,create:function create(a,d){try{var c=CWN2.LayerFactory[a.type](a,d);c.legend=a.legend;if(!a.legend){c.displayInLayerSwitcher=false}c.config=a;return c}catch(b){throw {name:"BadLayerConfig",message:"CWN2.LayerFactory.create: Errore creazione layer "+a.name+" di tipo "+a.type,level:1}}},setLayerOptions:function(a,c){var b={};b.projection=a.projection||c.projection;b.opacity=a.opacity||1;b.attribution=a.attribution;b.transitionEffect="resize";b.metadata=a.metadata;b.minScale=a.minScale||null;b.maxScale=a.maxScale||null;b.infoOptions=a.infoOptions;return b},createGoogleLayer:function(c,b){var a=(c===google.maps.MapTypeId.TERRAIN)?15:20;return new OpenLayers.Layer.Google(b.name,{type:c,resolutions:CWN2.Globals.BASE_RESOLUTIONS,serverResolutions:CWN2.Globals.BASE_RESOLUTIONS,minZoomLevel:0,maxZoomLevel:a,isBaseLayer:false})},google_roadmap:function(a){CWN2.Util.log("CWN2.LayerFactory.create google_roadmap");return CWN2.LayerFactory.createGoogleLayer(google.maps.MapTypeId.ROADMAP,a)},google_satellite:function(a){CWN2.Util.log("CWN2.LayerFactory.create google_satellite");return CWN2.LayerFactory.createGoogleLayer(google.maps.MapTypeId.SATELLITE,a)},google_hybrid:function(a){CWN2.Util.log("CWN2.LayerFactory.create google_hybrid");return CWN2.LayerFactory.createGoogleLayer(google.maps.MapTypeId.HYBRID,a)},google_terrain:function(a){CWN2.Util.log("CWN2.LayerFactory.create google_terrain");return CWN2.LayerFactory.createGoogleLayer(google.maps.MapTypeId.TERRAIN,a)},bing_hybrid:function bing_hybrid(){return new OpenLayers.Layer.Bing({name:"bing_hybrid",key:CWN2.Globals.BING_MAPS_KEY,type:"AerialWithLabels",resolutions:CWN2.Globals.BASE_RESOLUTIONS,isBaseLayer:false})},bing_aerial:function bing_aerial(){return new OpenLayers.Layer.Bing({name:"bing_aerial",key:CWN2.Globals.BING_MAPS_KEY,type:"Aerial",resolutions:CWN2.Globals.BASE_RESOLUTIONS,isBaseLayer:false})},bing_road:function bing_road(){return new OpenLayers.Layer.Bing({name:"bing_road",key:CWN2.Globals.BING_MAPS_KEY,type:"Road",resolutions:CWN2.Globals.BASE_RESOLUTIONS,isBaseLayer:false})},no_base:function no_base(a){CWN2.Util.log("CWN2.LayerFactory.create no_base");return new OpenLayers.Layer(a.name,{resolutions:CWN2.Globals.BASE_RESOLUTIONS,serverResolutions:CWN2.Globals.BASE_RESOLUTIONS,alwaysInRange:true,isBaseLayer:false})},OSM:function OSM(a){CWN2.Util.log("CWN2.LayerFactory.create OSM");return new OpenLayers.Layer.OSM(a.name,null,{transitionEffect:"resize",isBaseLayer:false})},rl_ortofoto_2013:function(a,c){var b={wmsParams:{url:"http://geoservizi.regione.liguria.it/geoserver/M1661/wms?",name:"L4419",transparent:false,format:"image/jpeg"},flagGeoserver:true,type:"WMS",name:"rl_ortofoto_2013",projection:"EPSG:3857",geomType:"RASTER",geomSubType:"RASTER",legend:{label:"Carte di base regionali",icon:"/geoviewer/img/legend/raster.gif"},attribution:"Immagine di proprietà AGEA",visible:false,cacheMinZoomLevel:7,cacheMaxZoomLevel:17};return this.WMS(b,c)},rl_carte_base:function(a,c){var b={wmsParams:{url:"http://geoservizi.regione.liguria.it/geoserver/M1623/wms?",name:"C1623",transparent:false,format:"image/jpeg"},flagGeoserver:true,type:"WMS",name:"rl_carte_base",projection:"EPSG:3857",geomType:"RASTER",geomSubType:"RASTER",legend:{label:"Carte di base regionali",icon:"/geoviewer/img/legend/raster.gif"},visible:false,cacheMinZoomLevel:7,cacheMaxZoomLevel:17};return this.WMS(b,c)},rl_ortofoto_2010:function(a,c){var b={wmsParams:{url:"http://geoservizi.regione.liguria.it/geoserver/M1505/wms?",name:"L3861",transparent:false,format:"image/jpeg"},flagGeoserver:true,type:"WMS",name:"rl_ortofoto_2010",projection:"EPSG:3857",geomType:"RASTER",geomSubType:"RASTER",legend:{label:"Carte di base regionali",icon:"/geoviewer/img/legend/raster.gif"},attribution:"Immagine di proprietà AGEA",visible:false,cacheMinZoomLevel:7,cacheMaxZoomLevel:17};return this.WMS(b,c)},rl_ortofoto_2007:function(a,c){var b={wmsParams:{url:"http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ORTOFOTO/1361.asp?",name:"L3463",transparent:false,format:"image/jpeg"},flagGeoserver:false,type:"WMS",name:"rl_ortofoto_2007",projection:"EPSG:3857",geomType:"RASTER",geomSubType:"RASTER",legend:{label:"Ortofoto 2007",icon:"/geoviewer/img/legend/raster.gif"},visible:false};return this.WMS(b,c)},rl_ortofoto_2000:function(a,c){var b={wmsParams:{url:"http://www.cartografiarl.regione.liguria.it/mapfiles/repertoriocartografico/ORTOFOTO/48.asp?",name:"L48",transparent:false,format:"image/jpeg"},flagGeoserver:false,type:"WMS",name:"rl_ortofoto_2000",projection:"EPSG:3857",geomType:"RASTER",geomSubType:"RASTER",legend:{label:"Ortofoto IT 2000",icon:"/geoviewer/img/legend/raster.gif"},visible:false};return this.WMS(b,c)},base_layer:function(a,b){CWN2.Util.log("CWN2.LayerFactory.create base_layer");var c=new OpenLayers.Layer("base_layer",{resolutions:b.resolutions,serveResolutions:CWN2.Globals.BASE_RESOLUTIONS,alwaysInRange:true,isBaseLayer:true,order:0});return c},GeoJSON:function GeoJSON(a,c){CWN2.Util.log("CWN2.LayerFactory.create GeoJSON");var b=CWN2.LayerFactory.setLayerOptions(a,c);if(a.url){b.protocol=new OpenLayers.Protocol.HTTP({format:new OpenLayers.Format.GeoJSON({ignoreExtraDims:true}),url:a.url});b.strategies=CWN2.LayerFactory.createStrategies(a)}b.isBaseLayer=false;b.styleMap=CWN2.LayerFactory.createVectorStyleMap(a);return new OpenLayers.Layer.Vector(a.name,b)},KML:function KML(a,c){CWN2.Util.log("CWN2.LayerFactory.create KML");var b=CWN2.LayerFactory.setLayerOptions(a,c);if(a.url){b.protocol=new OpenLayers.Protocol.HTTP({format:new OpenLayers.Format.KML({extractStyles:true,extractAttributes:true,kvpAttributes:true}),url:a.url});b.strategies=CWN2.LayerFactory.createStrategies(a)}b.isBaseLayer=false;return new OpenLayers.Layer.Vector(a.name,b)},GPX:function GPX(a,c){CWN2.Util.log("CWN2.LayerFactory.create GPX");var b=CWN2.LayerFactory.setLayerOptions(a,c);if(a.url){b.protocol=new OpenLayers.Protocol.HTTP({format:new OpenLayers.Format.GPX({}),url:a.url});b.strategies=CWN2.LayerFactory.createStrategies(a)}b.isBaseLayer=false;b.styleMap=CWN2.LayerFactory.createVectorStyleMap(a);return new OpenLayers.Layer.Vector(a.name,b)},WFS:function WFS(a,d){CWN2.Util.log("CWN2.LayerFactory.create WFS");var c=CWN2.LayerFactory.setLayerOptions(a,d);if(a.wfsParams.method="GET"){var e={request:"GetFeature",service:"wfs",version:"1.0.0"};e.typeName=a.wfsParams.featureType;if(a.wfsParams.filter){e.filter=a.wfsParams.filter}var b={url:a.wfsParams.url,params:e,format:new OpenLayers.Format.GML({featureNS:"http://ng.org/sf",geometryName:"wkb_geometry"})};c.protocol=new OpenLayers.Protocol.HTTP(b)}else{c.protocol=new OpenLayers.Protocol.WFS(a.wfsParams)}c.strategies=CWN2.LayerFactory.createStrategies(a);c.styleMap=CWN2.LayerFactory.createVectorStyleMap(a);c.isBaseLayer=false;return new OpenLayers.Layer.Vector(a.name,c)},WMS:function WMS(b,d){CWN2.Util.log("CWN2.LayerFactory.create WMS "+b.name);var c=CWN2.LayerFactory.setLayerOptions(b,d),a,e;b.wmsParams.layers=b.wmsParams.name;a=Ext.clone(b.wmsParams);a.url=null;a.name=null;if(b.flagGeoserver&&!CWN2.Globals.NO_GWC_CACHE&&b.cacheMinZoomLevel&&b.cacheMaxZoomLevel){c.tiled=true;a.tiled=true;a.tilesorigin=[d.maxExtent.left,d.maxExtent.bottom];if(!a.format_options){a.format_options="antialias:text"}}else{c.singleTile=true}c.buffer=0;c.transitionEffect=null;c.isBaseLayer=false;e=new OpenLayers.Layer.WMS(b.name,b.wmsParams.url,a,c);e.events.register("tileerror",e,function(){var g=arguments[0].tile;var f=g.url;if(f.indexOf("WIDTH=1&HEIGHT=1")>0){return}Ext.Ajax.request({url:CWN2.Globals.proxy+f,method:"GET",success:function(j,l){var k=CWN2.Util.getXmlDoc(j.responseText);var h=Ext.DomQuery.selectValue("ServiceException",k);if(h){CWN2.Util.handleException({message:"Errore Servizio WMS <br>Layer "+b.legend.label+" ("+b.name+")<br>Service Exception:<br>"+h+"<br>URL: "+f+"<br><br>",level:0})}},failure:function(h,j){CWN2.Util.handleException({message:"WMSServerError - failure",level:0})}})});return e},JSONP:function JSONP(a,c){CWN2.Util.log("CWN2.LayerFactory.create JSONP");var b=CWN2.LayerFactory.setLayerOptions(a,c),d;if(a.url){b.protocol=new OpenLayers.Protocol.Script({format:new OpenLayers.Format.GeoJSON({ignoreExtraDims:true}),callbackKey:"format_options",callbackPrefix:"callback:",url:a.url});b.strategies=CWN2.LayerFactory.createStrategies(a)}b.styleMap=CWN2.LayerFactory.createVectorStyleMap(a);b.isBaseLayer=false;return new OpenLayers.Layer.Vector(a.name,b)},createVectorStyleMap:function(c){if(!c.classes){return null}var e=(c.classes instanceof Array)?c.classes:[c.classes],g={};Ext.each(CWN2.Globals.DEFAULT_RENDER_INTENTS,function(l){var m=[];var h=f(c.strategies);var k=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"count",value:1});var n=(h)?k:null;Ext.each(e,function(o){var p=(o.filter)?new OpenLayers.Format.CQL().read(o.filter):null;m.push(d(o.styleMaps,l,p,o.id))});var j=new OpenLayers.Style();if(h){m.push(a(h));j.context={radius:function(o){return Math.min(o.attributes.count,7)+7}}}j.addRules(m);g[l]=j});return new OpenLayers.StyleMap(g);function d(l,h,j,k){return new OpenLayers.Rule({name:k,symbolizer:b(l,h)||b(l,"default"),filter:j})}function b(l,k){var h=l.length;for(var j=0;j<h;j++){if(l[j].renderIntent===k){return Ext.clone(l[j].style)}}return null}function f(k){if(k&&k.length){var h=k.length;for(var j=0;j<h;j++){if(k[j].name==="Cluster"&&k[j].style){return k[j].style}}}return false}function a(j){var q={},l=1,k,p,m,h,o;if(j.externalGraphic){q.externalGraphic=j.externalGraphic;q.graphicOpacity=j.graphicOpacity||1;q.graphicWidth=j.graphicWidth;q.graphicHeight=j.graphicHeight;q.graphicYOffset=j.graphicYOffset||-(j.graphicHeight/2);q.graphicXOffset=j.graphicXOffset||-(j.graphicWidth/2);q.graphicTitle=j.graphicTitle||"${count} Elementi"}else{q.pointRadius="${radius}";q.fillColor=j.fillColor||"#ff7700";q.fillOpacity=j.fillOpacity||0.9;q.strokeColor=j.strokeColor||"#ff7700";q.strokeOpacity=j.strokeOpacity||0.5;q.strokeWidth=j.strokeWidth||12}if(j.label){q.label="${count}";q.fontColor=j.fontColor||"#000000";q.fontOpacity=j.fontOpacity||1;q.fontSize=j.fontSize||"12px";q.fontWeight=j.fontWeight||"bold";q.fontFamily=j.fontFamily||"Verdana";q.labelOutlineWidth=j.labelOutlineWidth||0;q.labelAlign=j.labelAlign||"cm"}if(q){var n=new OpenLayers.Rule({symbolizer:q,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN,property:"count",value:1})})}return n}},createStrategies:function(c){var f=c.strategies;var d=[];if(f){var b=f.length;var g=false;for(var e=0;e<b;e++){d.push(a(f[e]));if(f[e]&&f[e].name==="BBOX"){g=true}}if(!g){d.push(new OpenLayers.Strategy.Fixed())}}else{d.push(new OpenLayers.Strategy.Fixed())}return d;function a(j){if(j.name==="BBOX"){return new OpenLayers.Strategy.BBOX()}if(j.name==="Fixed"){return new OpenLayers.Strategy.Fixed()}if(j.name==="Cluster"){var h={};if(j.options&&j.options.distance){h.distance=j.options.distance}if(j.options&&j.options.threshold){h.threshold=j.options.threshold}return new OpenLayers.Strategy.Cluster(h)}return null}}});Ext.define("CWN2.LayerManager",{overlayLayerStore:null,baseLayerStore:null,overlayLayersConfig:null,baseLayersConfig:null,map:null,setBaseLayers:function(){var c=false,b,a=this.baseLayersConfig.length;for(b=0;b<a;b++){if(this.baseLayersConfig[b].visible&&!c){c=true}this.baseLayersConfig[b].order=0}if(!c){this.baseLayersConfig[a-1].visible=true}},getLayerConfigByName:function(b){var a=null;Ext.each(this.overlayLayersConfig,function(c){if(c.name===b){a=c;return false}});if(a){return a}Ext.each(this.baseLayersConfig,function(c){if(c.name===b){a=c;return false}});if(a){return a}},getLayerIndexByName:function(b){var a=-1;Ext.each(this.overlayLayersConfig,function(c,d){if(c.name===b){a=d;return false}});return a},isBaseLayerInConfig:function(a){var b=false;Ext.each(this.baseLayersConfig,function(c){if(a===c.name){b=true;return false}});return b},isLayerInConfigWithTitle:function(b){var a=b.name,d=(b.legend&&b.legend.label)?b.legend.label:null;var c=false;Ext.each(this.overlayLayersConfig,function(f){if(a===f.name){c=true;return false}var e=(f.legend&&f.legend.label)?f.legend.label:null;if(d&&e&&d===e){c=true;return false}});return c},isLayerInConfig:function(a){var b=false;Ext.each(this.overlayLayersConfig,function(c){if(a===c.name){b=true;return false}});return b},getFieldFromLayerConfig:function(a,c){var b=null;Ext.each(this.overlayLayersConfig,function(d){if(a===d.name){b=d[c];return false}});return b},buildLayerStoreByType:function(c){var f=[],b=(c==="overlay")?this.overlayLayersConfig:this.baseLayersConfig,e=c+"-layer-store",a,d=this;if(b){Ext.each(b,function(g){if((g.showInLegend===undefined)||(g.showInLegend===true)){f.push(d.buildLayerRecord(g))}})}f.reverse();a=new Ext.data.Store({storeId:e,data:f,model:"CWN2.LayerModel"});if(c==="overlay"){this.overlayLayerStore=a}else{this.baseLayerStore=a}},removeLayerFromStore:function(b){CWN2.Util.log("CWN2.LayerManager.removeLayerFromStore");var d=this.overlayLayerStore.data.items,c,a=d.length,e;for(c=0;c<a;c++){if(d[c]){if(d[c].data.name===b){e=this.overlayLayerStore.getAt(c);this.overlayLayerStore.remove(e)}}}},addLayerToStore:function(a){CWN2.Util.log("CWN2.LayerManager.addLayerToStore");if((a.showInLegend===undefined)||(a.showInLegend===true)){if(this.overlayLayerStore){this.overlayLayerStore.insert(0,this.buildLayerRecord(a))}else{this.initStore()}}},addBaseLayerToStore:function(a){CWN2.Util.log("CWN2.LayerManager.addBaseLayerToStore");if((a.showInLegend===undefined)||(a.showInLegend===true)){if(this.baseLayerStore){this.baseLayerStore.insert(0,this.buildLayerRecord(a))}else{this.initStore()}}},buildLayerRecord:function(a){a.legend=a.legend||{};return{id:a.name,name:a.name,legendIcon:(a.legend.popUpUrl&&!a.legend.popUpFlag)?a.legend.popUpUrl:a.legend.icon,legendLabel:a.legend.label,legendPopUpFlag:a.legend.popUpFlag,minScale:a.minScale,maxScale:a.maxScale,legendPopUpUrl:a.legend.popUpUrl,multiClasse:a.multiClasse,visible:a.visible,inRange:(this.map&&this.map.getLayerByName(a.name)&&this.map.getLayerByName(a.name).calculateInRange())?true:false,config:a}},getOverlayLayersNameFromStore:function(){CWN2.Util.log("CWN2.LayerManager.getOverlayLayersNameFromStore");if(this.overlayLayerStore){var b=[],d=this.overlayLayerStore.data.items,c,a=d.length;for(c=0;c<a;c++){b.push(d[c].data.name)}return b}},getLayerStore:function(a){CWN2.Util.log("CWN2.LayerManager.getLayerStore");if(a==="base"){return this.baseLayerStore}else{return this.overlayLayerStore}},updateSelectControls:function(a){if(this.map){this.map.featureManager.hoverFeatureControl.setLayer(a);this.map.featureManager.selectFeatureControl.setLayer(a)}},addLayers:function(d){CWN2.Util.log("CWN2.LayerManager.addLayers");CWN2.Util.assert(d,{name:"BadParameter",message:"CWN2.LayerManager.addLayers: parametro deve essere valorizzato",level:1});var c=(d instanceof Array)?d:[d],b=this,a=[];Ext.each(c,function(e){if(!b.isLayerInConfigWithTitle(e)){b.overlayLayersConfig.push(e);var g=b.map.loadLayer(e);a.push(g);b.addLayerToStore(e);if(g.CLASS_NAME==="OpenLayers.Layer.Vector"){b.map.featureManager.registerLayerAction([e])}if(e.type==="WMS"&&e.queryable){var f=b.map.getControl("infoWmsControl");if(f){f.addLayers([g])}}}});if(b.map){b.map.featureManager.updateControlLayer()}b.map.setBaseLayerIndex();return a},addBaseLayers:function(c){CWN2.Util.log("CWN2.LayerManager.addBaseLayers");CWN2.Util.assert(c,{name:"BadParameter",message:"CWN2.LayerManager.addBaseLayers: parametro deve essere valorizzato",level:1});var b=(c instanceof Array)?c:[c],a=this;Ext.each(b,function(d){if(!a.isBaseLayerInConfig(d.name)){a.baseLayersConfig.push(d);a.map.loadLayer(d);a.addBaseLayerToStore(d)}})},remove:function(e){CWN2.Util.log("CWN2.LayerManager.remove");var f,a=e.length;for(f=0;f<a;f++){var d=this.getLayerIndexByName(e[f]);if(d!==-1){this.overlayLayersConfig.splice(d,1)}this.map.removeLayerByName(e[f]);var g=this.map.getControl("infoWmsControl");if(g){var c=g.layers;if(c){for(var b=0;b<c.length;b++){if(c[b].name===e[f]){c.splice(b,1)}}}}this.removeLayerFromStore(e[f])}if(this.map){this.map.featureManager.updateControlLayer()}},createVectorLayer:function(a){CWN2.Util.log("CWN2.LayerManager.createVectorLayer");var h="GeoJSON";var f=a.name;var d=a.classes;var e=a.infoOptions;var j=a.legend;var c=(j)?true:false;var b=(a.notVisible)?false:true;var g=a.projection||"EPSG:4326";return this.map.getLayerByName(f)||this.addLayers({type:"GeoJSON",name:f,projection:g,isBaseLayer:false,url:null,visible:b,showInLegend:c,classes:d,infoOptions:e,legend:j})[0]},createWMSLayer:function(a){CWN2.Util.log("CWN2.LayerManager.createWMSLayer");return this.map.getLayerByName(a.name)||this.addLayers(a)[0]},initStore:function(){CWN2.Util.log("CWN2.LayerManager.initStore");this.buildLayerStoreByType("base");this.buildLayerStoreByType("overlay")},getLayersConfig:function(){return this.overlayLayersConfig},getBaseLayersConfig:function(){return this.baseLayersConfig},getActiveBaseLayerConfig:function(){var a=null;Ext.each(this.baseLayersConfig,function(b){if(b.visible){a=b;return false}});return a},updateInRange:function(){var b,a;b=this.overlayLayerStore.data.items;if(b.length>0&&this.map){for(a=0;a<b.length;a++){(this.map.getLayerByName(b[a].data.name).calculateInRange())?b[a].data.inRange=true:b[a].data.inRange=false}}b=this.baseLayerStore.data.items;if(b.length>0&&this.map){for(a=0;a<b.length;a++){(this.map.getLayerByName(b[a].data.name).calculateInRange())?b[a].data.inRange=true:b[a].data.inRange=false}}b=this.overlayLayersConfig;if(b.length>0&&this.map){for(a=0;a<b.length;a++){(this.map.getLayerByName(b[a].name).calculateInRange())?b[a].inRange=true:b[a].inRange=false}}},constructor:function(){CWN2.Util.log("CWN2.LayerManager");CWN2.Util.assert(CWN2.app.configuration.baseLayers,{name:"BadConfiguration",message:"CWN2.LayerManager.init: baseLayers deve essere valorizzato",level:2});CWN2.Util.assert(CWN2.app.configuration.baseLayers.length>0,{name:"BadConfiguration",message:"CWN2.LayerManager.init: baseLayers deve contenere almeno un layer",level:2});this.overlayLayersConfig=CWN2.app.configuration.layers||[];this.baseLayersConfig=CWN2.app.configuration.baseLayers||[];this.map=CWN2.app.map;this.setBaseLayers();this.buildLayerStoreByType("base");this.buildLayerStoreByType("overlay")},setLayerVisible:function(c,e){var d=CWN2.app.map.getLayerByName(c),b=this.getLayerConfigByName(c),f=this.getHiliteLayers(c),a=this.overlayLayerStore.getById(c)||this.baseLayerStore.getById(c);if(d){d.setVisibility(e);for(i=0;i<f.length;i++){f[i].setVisibility(e)}}if(b){b.visible=e}if(a){a.set("visible",e);a.commit()}},getHiliteLayers:function(d){var c=[];var a=this.map.layers;for(var b=0;b<a.length;b++){if(a[b].hiliteLayer){Ext.each(a[b].hilitedLayers,function(e){if(e===d){c.push(a[b])}})}}return c},applyWmsParam:function(b,f,c){if(b){var d=this.map.getLayerByName(b);if(d){var e={};e[f]=c;d.mergeNewParams(e);var a=this.getLayerConfigByName(b);if(a){a.wmsParams[f]=c}}}},removeWmsParam:function(b,d){if(b){var c=this.map.getLayerByName(b);if(c){c.params[d]=null;var a=this.getLayerConfigByName(b);if(a){a.wmsParams[d]=null}}}}});Ext.define("CWN2.LayerModel",{extend:"Ext.data.Model",statics:{createFromLayer:function(a){return this.getProxy().reader.readRecords([a]).records[0]}},fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"legendIcon",type:"string"},{name:"legendLabel",type:"string"},{name:"legendPopUpFlag",type:"bool"},{name:"legendLabel",type:"string"},{name:"minScale",type:"int"},{name:"maxScale",type:"int"},{name:"legendPopUpUrl",type:"string"},{name:"multiClasse",type:"bool"},{name:"visible",type:"bool"},{name:"inRange",type:"bool"},{name:"config"}],proxy:{type:"memory",reader:{type:"json"}},getLayer:function(){return this.raw}});Ext.define("CWN2.Layout",{layout:null,mapPanel:null,mapTitle:null,setMapTitle:function(a){Ext.getCmp("cwn2-map-panel").setTitle(a)},constructor:function(b){CWN2.Util.log("CWN2.Layout");var c=this;var e=CWN2.app.configuration.application.layout;this.mapTitle=e.mapTitle;var d={id:"cwn2-container",layout:"border",hideBorders:false,forceLayout:true,items:a(e)};switch(e.type){case"viewport":c.layout=Ext.create("Ext.container.Viewport",d);break;case"panel":d.renderTo=b;if(e.height){d.height=e.height}if(e.width){d.width=e.width}c.layout=Ext.create("Ext.panel.Panel",d);break;case"window":d.closeAction="hide";if(e.height){d.height=e.height}if(e.width){d.width=e.width}c.layout=Ext.create("Ext.window.Window",d);break}function a(g){var f=[];if(CWN2.MapPanel){c.mapPanel=new CWN2.MapPanel();f.push(c.mapPanel)}if(g.legend){switch(g.legend.type){case"simple":f.push(new CWN2.SimpleLegendPanel());break;case"tree":f.push(new CWN2.TreeLegendPanel());break}}if(g.header){f.push({region:"north",height:g.header.height||80,id:"cwn2-layout-title",style:g.header.style||null,html:g.header.html||"Header",xtype:"container"})}if(g.toolsPanel){f.push({region:g.toolsPanel.position||"south",height:g.toolsPanel.height||80,autoScroll:true,split:true,collapsible:g.toolsPanel.collapsible,collapsed:g.toolsPanel.collapsed,id:"cwn2-layout-toolspanel",xtype:"panel"})}return f}}});OpenLayers.Control.LoadingPanel=OpenLayers.Class(OpenLayers.Control,{counter:0,maximized:false,visible:true,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a])},setVisible:function(a){this.visible=a;if(a){OpenLayers.Element.show(this.div)}else{OpenLayers.Element.hide(this.div)}},getVisible:function(){return this.visible},hide:function(){this.setVisible(false)},show:function(){this.setVisible(true)},toggle:function(){this.setVisible(!this.getVisible())},addLayer:function(a){if(a.layer){a.layer.events.register("loadstart",this,this.increaseCounter);a.layer.events.register("loadend",this,this.decreaseCounter)}},setMap:function(c){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("preaddlayer",this,this.addLayer);for(var b=0;b<this.map.layers.length;b++){var a=this.map.layers[b];a.events.register("loadstart",this,this.increaseCounter);a.events.register("loadend",this,this.decreaseCounter)}},increaseCounter:function(){this.counter++;if(this.counter>0){if(!this.maximized&&this.visible){this.maximizeControl()}}},decreaseCounter:function(){if(this.counter>0){this.counter--}if(this.counter==0){if(this.maximized&&this.visible){this.minimizeControl()}}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);return this.div},minimizeControl:function(a){this.div.style.display="none";this.maximized=false;if(a!=null){OpenLayers.Event.stop(a)}},maximizeControl:function(a){this.div.style.display="block";this.maximized=true;if(a!=null){OpenLayers.Event.stop(a)}},destroy:function(){if(this.map){this.map.events.unregister("preaddlayer",this,this.addLayer);if(this.map.layers){for(var b=0;b<this.map.layers.length;b++){var a=this.map.layers[b];a.events.unregister("loadstart",this,this.increaseCounter);a.events.unregister("loadend",this,this.decreaseCounter)}}}OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.LoadingPanel"});CWN2.Map=OpenLayers.Class(OpenLayers.Map,{mapOptions:null,baseLayerName:null,layerManager:null,featureManager:null,previousExtent:null,maxZoomLevel:null,appId:null,initialize:function(){CWN2.Util.log("CWN2.Map");var a=CWN2.app.configuration.application.mapOptions;this.mapOptions={};this.mapOptions.projection=a.projection;this.mapOptions.displayProjection=(a.displayProjection)?new OpenLayers.Projection(a.displayProjection):new OpenLayers.Projection(this.mapOptions.projection);this.mapOptions.units=a.units||"m";this.mapOptions.maxScale=a.maxScale;this.resolutions=this.calculateResolutions(null,this.mapOptions.maxScale,this.mapOptions.units);this.setExtent(a);this.mapOptions.controls=[];OpenLayers.Map.prototype.initialize.apply(this,[this.mapOptions]);this.load()},setExtent:function(a){this.mapOptions.maxExtent=OpenLayers.Bounds.fromString("-20037508, -20037508, 20037508, 20037508.34");if(a.restrictedExtent){this.mapOptions.restrictedExtent=new OpenLayers.Bounds.fromString(a.restrictedExtent)}this.setMapOptionsInitialExtent(a)},setMapOptionsInitialExtent:function(a){if(CWN2.Util.getUrlParam("initialExtent")){this.mapOptions.initialExtent=this.calculateInitialExtent(this.getInitialExtentFromUrlParam())}else{if(a.initialExtent){this.mapOptions.initialExtent=this.calculateInitialExtent(a.initialExtent)}}},getInitialExtentFromUrlParam:function(){var b=CWN2.Util.getUrlParam("initialExtent").split(",");var c=b.splice(0,1)[0];var a=b.join(",");if(this.mapOptions.projection!==c){a=CWN2.Util.transformStrBounds(c,this.mapOptions.projection,a)}return a},calculateInitialExtent:function(a){var c=new OpenLayers.Bounds.fromString(a);if(this.restrictedExtent&&!this.restrictedExtent.containsBounds(c)){var b={name:"BadInitialExtent",message:"CWN2.Map: initialExtent deve essere compreso in restrictedExtent",level:0};CWN2.Util.handleException(b);return this.maxExtent}else{return c}},load:function(){var a=CWN2.app.configuration.application.mapOptions;this.layerManager=new CWN2.LayerManager();this.layerManager.map=this;this.loadLayer({type:"base_layer",maxScale:a.maxScale,units:this.units});this.loadLayers(this.layerManager.getBaseLayersConfig());this.loadLayers(this.layerManager.getLayersConfig());this.setBaseLayerIndex();this.initControls(a);this.events.register("moveend",null,function(){if(this.restrictedExtent&&this.zoom<this.getZoomForExtent(this.restrictedExtent)){this.zoomToExtent(this.restrictedExtent)}if(this.maxZoomLevel&&this.zoom>this.maxZoomLevel){this.zoomTo(this.maxZoomLevel)}this.layerManager.updateInRange()});this.events.register("zoomend",null,function(){if(this.popups&&this.popups.length>0){for(var c=0;c<this.popups.length;c++){var b=this.popups[c];b.feature.popup=null;b.destroy()}}})},setFractionalZoom:function(){CWN2.Util.log("CWN2.Map.setFractionalZoom");var a=false;Ext.each(this.layerManager.getBaseLayersConfig(),function(b){if(b.type.indexOf("google_")!==-1||b.type.indexOf("TMS")!==-1){a=true;return false}});Ext.each(this.layerManager.getLayersConfig(),function(b){if(b.type.indexOf("google_")!==-1||b.type.indexOf("TMS")!==-1){a=true;return false}});if(!a){this.fractionalZoom=true}},setBaseLayerIndex:function(){CWN2.Util.log("CWN2.Map.setBaseLayerIndex");var b=this.layerManager.getBaseLayersConfig();for(var a=0;a<b.length;a++){this.setLayerIndex(this.getLayerByName(b[a].name),0)}},loadLayers:function(a){CWN2.Util.log("CWN2.Map.loadLayers");if(a){for(var b=0;b<a.length;b++){this.loadLayer(a[b])}}},loadLayer:function(a){CWN2.Util.log("CWN2.Map.loadLayer");var c;try{c=CWN2.LayerFactory.create(a,this)}catch(b){CWN2.Util.handleException(b)}if(c){this.addLayer(c);if(a.order||a.order===0){this.setLayerIndex(c,a.order)}c.setVisibility(a.visible);if(c.CLASS_NAME==="OpenLayers.Layer.Vector"){c.loadend=false;c.events.on({loadend:function(){c.loadend=true},scope:c})}return c}},initControls:function(c){this.featureManager=new CWN2.FeatureManager(this);this.loadControls(c.olControls);if(!this.mapOptions.noBaseControls){this.loadControls(CWN2.Globals.MAP_BASE_CONTROL_CONFIG)}if(c.disableScrollWheel){var b=this.getControlsByClass("OpenLayers.Control.Navigation");for(var a=0;a<b.length;++a){b[a].disableZoomWheel()}}},loadControls:function(a){CWN2.Util.log("CWN2.Map.loadControls");if(a){for(var b=0;b<a.length;b++){this.loadControl(a[b])}}},loadControl:function(a){CWN2.Util.log("CWN2.Map.loadControl");var c;try{c=new CWN2.Control[a.name](a.options)}catch(b){try{c=new OpenLayers.Control[a.name](a.options)}catch(b){CWN2.Util.handleException({name:"BadOLControl",message:"CWN2.Map.createControl: "+a.name+" non implementato",level:0});return null}this.addControl(c);return c}},getLayerByName:function(a){var b=this.getLayersByName(a);if(b.length>0){return b[0]}else{return null}},removeLayerByName:function(a){var b=this.getLayerByName(a);if(b){this.removeLayer(b)}},zoomToStringExtent:function(b,c){var a=b;if((c)&&(this.projection!==c)){a=CWN2.Util.transformStrBounds(c,this.projection,b)}var d=new OpenLayers.Bounds.fromString(a);this.zoomToExtent(d)},zoomToInitialExtent:function(){if(this.initialExtent){this.zoomToExtent(this.initialExtent);this.zoomToExtent(this.initialExtent)}},zoomToFeatures:function(b,e){var d,a,c;if(b&&b.length){d=b.length}if(d){c=b[0].geometry.getBounds().clone();for(a=1;a<d;a++){c.extend(b[a].geometry.getBounds())}this.zoomToExtent(c,false);if(e&&e<0){this.zoomTo(this.zoom+e)}else{if(e&&this.zoom>e){this.zoomTo(e)}}}},zoomToLonlat:function(d,b,a){var c=Ext.clone(d);if(a&&a!==this.projection){c.transform(new OpenLayers.Projection(a),new OpenLayers.Projection(this.projection))}this.setCenter(c,b)},isPointInMaxExtent:function(d,e,b){if(!this.restrictedExtent){return true}var c=b||"EPSG:4326";var a=new OpenLayers.LonLat(e,d);if(this.projection!==c){a.transform(new OpenLayers.Projection(c),this.getProjectionObject())}return this.restrictedExtent.containsLonLat(a)},setBaseLayerOnMap:function(a){var b=this;this.baseLayerName=a;Ext.each(this.layerManager.getBaseLayersConfig(),function(c,d){b.layerManager.setLayerVisible(c.name,c.name===a)})},calculateResolutions:function(f,g,d){var a=CWN2.Globals.BASE_RESOLUTIONS;if(g){var c=OpenLayers.Util.getResolutionFromScale(g,d||"m");a=a.slice(0,e(c))}if(f){var b=OpenLayers.Util.getResolutionFromScale(f,d||"m");a=a.slice(e(b),a.length)}return a;function e(h){var j;Ext.each(CWN2.Globals.BASE_RESOLUTIONS,function(l,k){if(l<h){j=k;return false}});return j}},CLASS_NAME:"CWN2.Map"});Ext.define("CWN2.MapCatalogueLoader",{singleton:true,loadRequest:function(b,c){CWN2.Util.log("CWN2.MapCatalogueLoader.loadRequest");var g=b.data;var f=g.map;CWN2.app.configuration.agRequest=g;if(g.valori.length>0){var a=[];Ext.each(g.valori,function(h){if(h.valorePkAlfa){a.push(h.valorePkAlfa)}});if(a.length>0){c=c||{};var e=[];Ext.each(g.livelli,function(h){e.push(h.codiceLivello)});Ext.apply(c,{flagFindQuery:g.flagFindQuery,layers:e,fields:g.livelli[0].nomeFkVersoAlfa,values:a,tipoFind:g.tipoFind,bounds:g.bounds})}if(g.valori[0].longitudine&&g.valori[0].latitudine){CWN2.FeatureLoader.loadMarker({x:g.valori[0].longitudine,y:g.valori[0].latitudine,map:CWN2.app.map,zoomLevel:14,zoom:true,epsgCode:"EPSG:3003"})}}if(g.modalita&&g.modalita!=="GENERICA"){var d=CWN2.app.configuration.application.layout.ag_toolbar[g.modalita];if(!d){CWN2.Util.handleException({message:"Configurazione bottoni per modalità "+g.modalita+" non presente",level:1});return}Ext.each(d,function(h){if(h.options&&h.options.preProcessing&&typeof(h.options.preProcessing)==="function"){h.options.preProcessing(h,g)}CWN2.app.layout.mapPanel.toolbar.addButton(h)})}return{mapConfig:f,findOptions:c}},loadQPGRequest:function(a){CWN2.Util.log("CWN2.MapCatalogueLoader.loadQPGRequest");var b=a.data;var c=b.map;c.name=b.titolo;CWN2.app.configuration.qpgRequest=b;return{mapConfig:c,tematismi:b.tematismi}},loadMap:function(a){var j=this,l=a.idMap,e=a.idRequest,c=a.qpgRequest,f=a.findOptions,h=a.loadBaseLayers,k=a.flagGeoserver,g=a.geoserverUrl;CWN2.Util.log("CWN2.MapCatalogueLoader.loadMap");var b=CWN2.Globals.RL_MAP_CONFIG_SERVICE+l+"?param=value";if(e){b=CWN2.Globals.RL_AG_REQUEST_CONFIG_SERVICE+e+"?map_projection="+CWN2.app.map.projection}if(c){b=CWN2.Globals.RL_QPG_REQUEST_CONFIG_SERVICE+c+"?map_projection="+CWN2.app.map.projection}if(h){b+="&loadBaseLayers=true"}if(k){b+="&geoserver=true"}if(g){b+="&geoserverUrl="+g}var d=function(n){CWN2.Util.log("CWN2.MapCatalogueLoader.calculateExtent");var m=(n.projection!==CWN2.app.map.projection)?CWN2.Util.transformStrBounds(n.projection,CWN2.app.map.projection,n.extent):n.extent;return m.split(",")};CWN2.Util.ajaxRequest({type:"JSON",url:b,callBack:function(n){var p;if(e){var o=j.loadRequest(n,f);p=o.mapConfig;f=o.findOptions}else{if(c){var o=j.loadQPGRequest(n);p=o.mapConfig}else{p=n.data}}if(a.setMapTitle){var m=Ext.fly(a.setMapTitle);if(m){m.update(p.name)}}else{CWN2.app.layout.setMapTitle(p.name)}CWN2.app.layout.mapTitle=p.name;CWN2.app.map.layerManager.addLayers(p.layers);if(c){CWN2.QPG.loadQPGLayers(CWN2.app.configuration.qpgRequest.tematismi);CWN2.app.configuration.qpgRequest.tematismi.reverse()}if(a.setDisplayProjection){CWN2.app.map.displayProjection=new OpenLayers.Projection(p.projection)}if(p.extent){CWN2.app.map.initialExtent=d(p)}CWN2.app.map.zoomToInitialExtent();if(p.type&&p.type=="R"){CWN2.app.map.setBaseLayerOnMap("no_base")}if((f&&f.values&&f.values!=="null")||(f&&f.sldFilter)){f.setInitialExtent=true;j.findWMS(f)}if(f&&f.address){f.setInitialExtent=true;j.findAddress(f)}CWN2.app.callback(a)}})},loadLayers:function(e){var f=e.idLayer,d=this,c=e.findOptions;CWN2.Util.log("CWN2.MapCatalogueLoader.loadLayers");if(!f||f==="null"){var b={};b.message="manca parametro layer";b.level=1;CWN2.Util.handleException(b);return}var a=CWN2.Globals.RL_LAYER_CONFIG_SERVICE+f;CWN2.Util.ajaxRequest({type:"JSONP",url:a,callBack:function(h){var g=h.data;if(e.sldUrl){g[0].wmsParams.SLD=e.sldUrl}CWN2.app.map.layerManager.addLayers(g);if(c){if((c.idList&&c.idList!=="null")||(c.sldFilter)){c.setInitialExtent=true;d.findWMS(c)}else{b={};b.message="Lista valori find non impostata";b.level=0;CWN2.Util.handleException(b)}}CWN2.app.callback(e)}})},findAddress:function(b){var a=b.address,c=this;CWN2.Util.log("CWN2.MapCatalogueLoader.findAddress");var d=CWN2.Globals.GOOGLE_GEOCODE_PROXY;d+="&address="+a;CWN2.Util.ajaxRequest({type:"JSON",url:d,callBack:function(e){var f=[];if(e.results){Ext.each(e.results,function(g){f.push({label:g.formatted_address,x:g.geometry.location.lng,y:g.geometry.location.lat,rilevanza:g.types[0],trovato:g.formatted_address})})}if(f.length>0){CWN2.FeatureLoader.loadMarker({x:f[0].x,y:f[0].y,map:CWN2.app.map,epsgCode:"EPSG:4326",label:"",zoomLevel:17})}else{CWN2.Util.msgBox("Indirizzo non trovato","INFO")}}})},findWMS:function(c){var e=c.layers,d=this;CWN2.Util.log("CWN2.MapCatalogueLoader.findWMS");var a=[];Ext.each(e,function(f){if(!CWN2.app.map.layerManager.isLayerInConfig(f)){a.push(f.replace("L",""))}});if(a.length===0){var b=CWN2.app.map.layerManager.getLayerConfigByName(e[0]);d.findLayer(c,b)}else{CWN2.Util.ajaxRequest({type:"JSONP",url:CWN2.Globals.RL_LAYER_CONFIG_SERVICE+a.join(","),callBack:function(g){var f=g.data[0];CWN2.app.map.layerManager.addLayers(f);d.findLayer(c,f)}})}},findLayer:function find(c,b){var e=this;CWN2.Util.log("CWN2.MapCatalogueLoader.findLayer");if(!Ext.isArray(c.values)){c.values=[c.values]}if(!c.sldFilter){c.sldFilter=this.buildSldFilter(c)}var f=function(g){if(c.flagFindQuery==="QUERY"){e.hiliteFeatureQuery(c,g,b.flagGeoserver)}e.hiliteFeatureFind(c,g)};if(c.bounds){var d=(typeof c.bounds==="string")?OpenLayers.Bounds.fromString(c.bounds):c.bounds;f(d)}else{if(c.layers.length===1){var a=c.layers[0];var d=this.getWFSBound({wfsUrl:CWN2.Globals.proxy+b.wmsParams.url+"VERSION=1.0.0&SERVICE=WFS&REQUEST=GetFeature&TYPENAME="+a+"&Filter="+c.sldFilter,callback:f})}}},buildSldFilter:function(b){if(!b.values||b.values==="null"){var a={};a.message="manca parametro values";a.level=0;CWN2.Util.handleException(a);return}return CWN2.WmsSldHiliter.getFilter(b.fields,b.values)},hiliteFeatureFind:function(a,b){Ext.each(a.layers,function(d){var c=new CWN2.WmsSldHiliter(CWN2.app.map,"_findWMS_"+d).hiliteFeature({layers:[d],fields:a.fields,values:a.values,sldFilter:a.sldFilter,bounds:b,zoomLevel:a.zoomLevel,maxZoomLevel:a.maxZoomLevel,callback:function(){if(a.setInitialExtent){CWN2.app.map.initialExtent=CWN2.app.map.getExtent()}}})})},hiliteFeatureQuery:function(f,g,c){if(c){CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,jsonData:{layers:f.layers,sldFilter:f.sldFilter},callBack:function(j){Ext.each(f.layers,function(l){CWN2.app.map.getLayerByName(l).params.LAYERS=null;CWN2.app.map.getLayerByName(l).params.TILED=false;var k="http://srvcarto.regione.liguria.it/geoservices/temp/"+j.data.sldFile;CWN2.app.map.layerManager.applyWmsParam(l,"SLD",k)});var h=f.maxZoomLevel||18;CWN2.WmsSldHiliter.zoomToFeatures(g,f.zoomLevel,h)},disableException:true})}else{var b=[];Ext.each(f.layers,function(h){b.push(CWN2.app.map.layerManager.getFieldFromLayerConfig(h,"geomSubType"))});var e=(((f.fields&&f.values&&f.values.length>0)||f.sldFilter)&&b.length>0)?CWN2.WmsSldHiliter.getStyle({layers:f.layers,geomType:b,fields:f.fields,values:f.values,sldFilter:f.sldFilter}):null;var d=CWN2.WmsSldHiliter.getStyle({layers:f.layers,geomType:b,fields:f.fields,values:null,sldFilter:null});CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,jsonData:{sldBody:e,sldCleanBody:d},callBack:function(h){Ext.each(f.layers,function(j){CWN2.app.map.layerManager.applyWmsParam(j,"sld",h.data.sldUrl)})},disableException:true});var a=f.maxZoomLevel||18;CWN2.WmsSldHiliter.zoomToFeatures(g,f.zoomLevel,a)}},getGeoserverSldFile:function(c,a,b){CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,callBack:b,jsonData:{layers:c,sldFilter:a},disableException:true})},getWFSBound:function(b){var a=b.wfsUrl;var c=b.callback;CWN2.Util.log("CWN2.MapCatalogueLoader.getWFSBound");CWN2.loadingScreen=Ext.getBody().mask("Interrogazione WFS","loadingscreen");CWN2.Util.ajaxRequest({type:"XML",url:a,callBack:function(e){var d,k,j,h,f;if(Ext.isIE){d=Ext.DomQuery.selectValue("ServiceException",e);if(d){CWN2.Util.handleException({message:"CWN2.Util.getWFSBound - Service Exception: "+d,level:2});return}k=e.childNodes[1].firstChild;if(!k){CWN2.Util.handleException({message:"CWN2.Util.getWFSBound - bbox non ritornato dal servizio ",level:2})}j=k.firstChild;if(!j){CWN2.Util.handleException({message:"CWN2.Util.getWFSBound - elemento non trovato ",level:2});return}h=(j.firstChild&&j.firstChild.firstChild)?j.firstChild.firstChild.data:null;if(!h){CWN2.Util.handleException({message:"CWN2.Util.getWFSBound - elemento non trovato ",level:2});return}f=(j.attributes)?j.attributes[0].text:null}else{d=Ext.DomQuery.selectValue("ServiceException",e);if(d){CWN2.Util.handleException({message:"CWN2.getWFSBound - Service Exception: "+d,level:2});return}k=Ext.DomQuery.select("gml|boundedBy",e)[0];if(!k){CWN2.Util.handleException({message:"CWN2.getWFSBound - elemento non trovato ",level:2});return}j=Ext.DomQuery.select("gml|Box",k)[0];if(!j){CWN2.Util.handleException({message:"CWN2.getWFSBound - elemento non trovato ",level:2});return}h=Ext.DomQuery.selectValue("gml|coordinates",j);if(!h){CWN2.Util.handleException({message:"CWN2.getWFSBound - elemento non trovato ",level:2});return}f=Ext.DomQuery.selectValue("gml|Box/@srsName",k)}if(h&&f){f=f.replace("http://www.opengis.net/gml/srs/epsg.xml#","EPSG:");var g=(f!==CWN2.app.map.projection)?OpenLayers.Bounds.fromString(CWN2.Util.transformStrBounds(f,CWN2.app.map.projection,h.replace(" ",","))):OpenLayers.Bounds.fromString(h.replace(" ",","));c(g)}}})},ag_bottoni_coordinate:function(b){var a=[{name:"coordinate",options:{pressed:true,projection:b,callBacks:{submit:function(c){CWN2.MapCatalogueLoader.ag_insertCoordinate(c.x,c.y)},cancel:function(c){Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(d){if(d==="yes"){CWN2.MapCatalogueLoader.ag_insertCoordinate("","")}})}}}}];return a},ag_bottoni_filtro:function(){var a=[{name:"selectfeature",options:{idLayer:"",iconCls:"selezioneOggetti",radius:5,preProcessing:function(c,d){var b=[];Ext.each(d.agLivelli,function(e){b.push(e.codiceLivello)});c.options.idLayer=b.join(",")},callBacks:{submit:function(b,c){CWN2.MapCatalogueLoader.ag_insertFeature(b)},cancel:function(b,c){c.getEl().dom.click()}}}},{name:"drawRegularPolygon",options:{id:"drawCircle",type:"circle",tooltip:"Inserisci un cerchio",iconCls:"selezioneCerchio",singleFeature:true,callback:function(c,b){CWN2.MapCatalogueLoader.ag_confermaFiltro("circle",c,b)}}},{name:"drawRegularPolygon",options:{id:"drawRectangle",type:"rectangle",tooltip:"Inserisci un rettangolo",iconCls:"selezioneRettangolo",singleFeature:true,callback:function(c,b){CWN2.MapCatalogueLoader.ag_confermaFiltro("rectangle",c,b)}}},{name:"drawPolygon",options:{singleFeature:true,iconCls:"selezionePoligono",callback:function(c,b){CWN2.MapCatalogueLoader.ag_confermaFiltro("polygon",c,b)}}},{name:"generic",options:{id:"annulla-filtro",iconCls:"selezioneAnnulla",tooltip:"Annulla",callback:function(){CWN2.MapCatalogueLoader.ag_ritorna("")}}}];return a},ag_ritorna:function(b){var a=CWN2.app.configuration.agRequest.chiamante;if(a.indexOf("?")>-1){a+="&idRichiesta="+b}else{a+="?idRichiesta="+b}window.location=a},ag_insertCoordinate:function(a,c){var b={modalita:"COORDINATE",applicazione:CWN2.app.configuration.agRequest.applicazione,idAlfaGis:CWN2.app.configuration.agRequest.idAlfaGis,longitudine:a,latitudine:c};CWN2.MapCatalogueLoader.ag_callInsertService(b)},ag_confermaFiltro:function(c,b,a){Ext.MessageBox.show({title:"Conferma",msg:"Confermi?",buttonText:{yes:"Conferma",no:"Annulla"},fn:function(d){switch(d){case"yes":CWN2.MapCatalogueLoader.ag_insertFiltro(c,b,a);break;case"no":a.feature.layer.removeAllFeatures();break}},animateTarget:"mb4",icon:Ext.MessageBox.QUESTION})},ag_insertFeature:function(a){var b={modalita:"FILTRO",filterType:"feature",applicazione:CWN2.app.configuration.agRequest.applicazione,idAlfaGis:CWN2.app.configuration.agRequest.idAlfaGis};b.idField=CWN2.app.configuration.agRequest.agLivelli[0].idField;b.valori=[];Ext.each(a,function(c){b.valori.push(c.data.ID)});CWN2.MapCatalogueLoader.ag_callInsertService(b)},ag_insertFiltro:function(c,b,a){var d={modalita:"FILTRO",filterType:c,applicazione:CWN2.app.configuration.agRequest.applicazione,idAlfaGis:CWN2.app.configuration.agRequest.idAlfaGis};if(c==="circle"){d.points=[[b.bounds.getCenterLonLat().lon,b.bounds.getCenterLonLat().lat]];d.radius=b.bounds.getWidth()/2}else{d.points=[];Ext.each(b.components[0].components,function(e){d.points.push([parseInt(e.x),parseInt(e.y)])});d.points[d.points.length-1]=d.points[0]}CWN2.MapCatalogueLoader.ag_callInsertService(d)},ag_callInsertService:function(a){CWN2.loadingScreen=Ext.getBody().mask("Caricamento Filtro","loadingscreen");CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_AG_REQUEST_CONFIG_SERVICE,callBack:function(b){CWN2.app.removeLoadingScreen();var c={};if(!b){c.message=b.responseText;c.level=2;CWN2.Util.handleException(c);return}if(b.success===false){c.message=b.message;c.level=2;CWN2.Util.handleException(c);return}CWN2.MapCatalogueLoader.ag_ritorna(b.data.idRichiesta)},jsonData:a,disableException:true})}});Ext.define("CWN2.MapPanel",{extend:"GeoExt.panel.Map",alias:"widget.cwn2-mappanel",region:"center",bodyStyle:"background-color:#FFFFFF",border:false,constructor:function(){CWN2.Util.log("CWN2.MapPanel");var f=CWN2.app.configuration.application.layout;this.map=CWN2.app.map=new CWN2.Map(CWN2.app);this.id="cwn2-map-panel";var a=[];if(f.statusBar){var e=new CWN2.Statusbar(f.widgets);a.push(e)}if(f.toolbar){this.pressedButton=f.toolbar.pressed||"pan";var d=new CWN2.Toolbar(f.toolbar,this);a.push(d)}var g=((CWN2.app.initOptions.idMap||CWN2.app.initOptions.idRequest)&&!CWN2.app.initOptions.setMapTitle)?"_":f.mapTitle||null;var c={id:this.id,title:g,map:this.map,dockedItems:a};this.superclass.constructor.call(this,c);var b=this;b.map.featureManager.registerCallback("onFeatureSelect",function(h){b.fireEvent("featureselect",h)})},getToolbar:function(){return Ext.ComponentQuery.query("cwn2-toolbar")[0]}});Ext.define("CWN2.MultiClassLegendWindow",{extend:"Ext.window.Window",constructor:function(a){CWN2.MultiClassLegendWindow.superclass.constructor.call(this,{title:a.legend.label,height:a.legend.popUpHeight||400,width:a.legend.popUpWidth||600,layout:"fit",items:[{xtype:"panel",bodyStyle:"padding:5px",autoScroll:true,items:[{xtype:"dataview",store:new Ext.data.Store({data:a.classes,fields:[{name:"icon",mapping:"legendIcon"},{name:"label",mapping:"legendLabel"}]}),tpl:new Ext.XTemplate("<table width=100% border=0>",'<tpl for=".">',"<tr>",'<td width=30><img src="{icon}"></td>',"<td>{label}</td>","</tpl>"),autoHeight:true,multiSelect:false,itemSelector:"div.thumb-wrap",emptyText:""}]}]})}});Ext.define("CWN2.OgcServicesMngr",{alias:"widget.cwn2-ogcservicemanager",addService:function(e,a,f,g){var d=g||CWN2.Globals.proxy;var c=d+f;var b=Ext.create("GeoExt.data.WmsCapabilitiesLayerStore",{storeId:"wmsCapStore",url:c,autoLoad:true,listeners:{load:function(j,h,k){CWN2.ogcServicesMngr.loadLayers(f,h)}}})},loadLayers:function(q,n){var o=n.length,k=OpenLayers.Util.removeTail(q),s,b,j=0,g=0,a,p=null,l=null,d=null,h=600,c=400;o=o-2;var e=[];for(var m=0;m<o;m++){var f=n[m].data;s=f.name;j=f.minScale;g=f.maxScale;a=f.title.replace(/_/g," ");l=CWN2.ogcServicesMngr.getLayerLegend(a,f);var r={name:s,type:"WMS",visible:true,projection:b,minScale:j,maxScale:g,opacity:1,legend:l,classes:[],wmsParams:{url:k,name:s,transparent:true},infoOptions:{}};e.push(r)}this.app.map.layerManager.addLayers(e)},getLayerLegend:function(c,b){var a={};a.label=c;if(b.styles.length>0){if((b.styles[0].legend)&&(b.styles[0].legend.href)){if(b.styles[0].name=="legenda"){a.icon=b.styles[0].legend.href}else{a.icon="http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif";a.popUpUrl=b.styles[0].legend.href;if((b.styles[0].legend.width)&&(b.styles[0].legend.height)){a.popUpWidth=parseInt(b.styles[0].legend.width)+parseInt(31);a.popUpHeight=parseInt(b.styles[0].legend.height)+parseInt(35)}}}if(a.popUpHeight){if(a.popUpHeight<100){a.popUpHeight=100}if(a.popUpHeight>400){a.popUpHeight=400}}}else{a.icon="http://geoportale.regione.liguria.it/geoviewer/img/legend/raster.gif"}return a},constructor:function(a){this.app=a}});OpenLayers.Layer.Vector.prototype.setOpacity=function(b){if(b!=this.opacity){this.opacity=b;for(var d=0,a=this.div.childNodes.length;d<a;++d){if(this.div.childNodes[d].firstChild){var c=this.div.childNodes[d].firstChild;OpenLayers.Util.modifyDOMElement(c,null,null,null,null,null,null,b)}else{var e=document.getElementById(this.id+"_root");if(e){OpenLayers.Util.modifyDOMElement(e,null,null,null,null,null,null,b)}}}if(this.map!=null){this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}}};OpenLayers.Feature.prototype.isSelected=function(){var b=this.layer.selectedFeatures;for(var a=0;a<b.length;a++){if(this===b[a]){return true}}return false};OpenLayers.Control.WMSGetFeatureInfo.prototype.findLayers=function(){var d=this.layers||this.map.layers;var e=[];var c,a;for(var b=d.length-1;b>=0;--b){c=d[b];if(c instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||c.getVisibility())&&c.inRange){a=OpenLayers.Util.isArray(c.url)?c.url[0]:c.url;if(this.drillDown===false&&!this.url){this.url=a}if(this.drillDown===true||this.urlMatches(a)){e.push(c)}}}return e};OpenLayers.Control.WMSGetFeatureInfo.prototype.buildWMSOptions=function(b,e,c,l){var j=[],m=[];for(var f=0,h=e.length;f<h;f++){if(e[f].params.LAYERS!=null){j=j.concat(e[f].params.LAYERS);m=m.concat(this.getStyleNames(e[f]))}}var a=e[0];var g=this.map.getProjection();var k=a.projection;if(k&&k.equals(this.map.getProjectionObject())){g=k.getCode()}var d=OpenLayers.Util.extend({service:"WMS",version:a.params.VERSION,sld:a.params.SLD,request:"GetFeatureInfo",exceptions:a.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,a.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:l,info_format:a.params.INFO_FORMAT||this.infoFormat},(parseFloat(a.params.VERSION)>=1.3)?{crs:g,i:parseInt(c.x),j:parseInt(c.y)}:{srs:g,x:parseInt(c.x),y:parseInt(c.y)});if(j.length!=0){d=OpenLayers.Util.extend({layers:j,query_layers:j,styles:m},d)}OpenLayers.Util.applyDefaults(d,this.vendorParams);return{url:b,params:OpenLayers.Util.upperCaseObject(d),callback:function(n){this.handleResponse(c,n,b)},scope:this}};OpenLayers.Control.WMSGetFeatureInfo.prototype.addLayers=function(b){if(!this.layers){this.layers=[]}for(var a=0;a<b.length;a++){this.layers.push(b[a])}};OpenLayers.Strategy.RuleCluster=OpenLayers.Class(OpenLayers.Strategy.Cluster,{rule:null,shouldCluster:function(a,c){var b=OpenLayers.Strategy.Cluster.prototype;return this.rule.evaluate(a.cluster[0])&&this.rule.evaluate(c)&&b.shouldCluster.apply(this,arguments)},CLASS_NAME:"OpenLayers.Strategy.RuleCluster"});OpenLayers.Bounds.transform=function(d,b){this.centerLonLat=null;var e=OpenLayers.Projection.transform({x:this.left,y:this.bottom},d,b);var a=OpenLayers.Projection.transform({x:this.right,y:this.bottom},d,b);var c=OpenLayers.Projection.transform({x:this.left,y:this.top},d,b);var f=OpenLayers.Projection.transform({x:this.right,y:this.top},d,b);this.left=Math.min(e.x,c.x);this.bottom=Math.min(e.y,a.y);this.right=Math.max(a.x,f.x);this.top=Math.max(c.y,f.y);if(d.projCode==="EPSG:3003"){this.top=this.top+parseInt(120);this.bottom=this.bottom+parseInt(120);this.left=parseInt(this.left)-parseInt(40);this.right=parseInt(this.right)-parseInt(40)}return this};OpenLayers.Format.Filter.v1_1_0.prototype.readers.ogc.Literal=function(a,b){b.value=this.getChildValue(a)};Ext.define("CWN2.QPG",{singleton:true,calculateStats:function(a,b){a.stat={};a.stat.serie=this.getSerie(a,b);if(a.idTipoClassificazione===0){a.scalaColore="Random"}a.stat.colors=CWN2.Globals.COLOR_SCALES[a.scalaColore][a.numClassi];a.stat.style=this.getStyle(a);a.stat.sldBody=new OpenLayers.Format.SLD().write({namedLayers:[{name:"QPG_"+a.livello.idLivello,userStyles:[a.stat.style]}]})},createQPGLayer:function(a){CWN2.Util.log("CWN2.QPG.createQPGLayer ");this.calculateStats(a);CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,callBack:function(b){CWN2.QPG.loadQPGLayer(a,b.data.sldUrl);if(a.tipoTematismo==="WMS"){CWN2.app.map.getControl("infoWmsControl").layers.push(a.olLayer)}else{var c=CWN2.app.map;c.featureManager.registerCallback("onFeatureSelect",function(d){CWN2.QPG.clearPopups(c);CWN2.QPG.addPopup(a,d)})}},jsonData:{sldBody:a.stat.sldBody,sldCleanBody:""},disableException:true})},addPopup:function(f,k){var c=f.livello.nomeCampoTooltip.replace("_"," ");var j=k.attributes[f.livello.nomeCampoTooltip].replace(/\s+$/,"");var a="VALORE";var g=k.attributes[a];var e="<b><br>&nbsp;"+c+": "+j+"<br>&nbsp;"+a+": "+g;var d=(c.length+j.length)*9+20;var h=new OpenLayers.Size(d,60);var b=new OpenLayers.Popup.Anchored("info",k.geometry.getBounds().getCenterLonLat(),h,e,null,false);b.feature=k;b.backgroundColor="#BBCCFF";b.panMapIfOutOfView=false;b.keepInMap=true;b.opacity=0.9;k.popup=b;CWN2.app.map.addPopup(b)},clearPopups:function(c){if(c.popups&&c.popups.length>0){for(var b=0;b<c.popups.length;b++){var a=c.popups[b];a.feature.popup=null;a.destroy()}}},getRules:function(b,a,c){var d=[];Ext.each(b.stat.style.rules,function(f,e){d.push({filter:new OpenLayers.Format.CQL().write(f.filter),legendIcon:a+"wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=QPG_TEMI:QPG_1&SLD="+c+"&RULE="+f.name,legendLabel:f.title,styleMaps:[{renderIntent:"default",style:f.symbolizer},{renderIntent:"hover",style:f.hoverSymbolizer},{renderIntent:"select",style:f.hoverSymbolizer}],from:Math.round(f.from*100)/100,to:Math.round(f.to*100)/100,count:f.count})});b.legendClasses=d;return d},loadQPGLayer:function(f,k){var e="QPG_"+f.livello.idLivello;var d=e+"_"+f.idTema;var a=(f.tipoTematismo==="WFS")?"GeoJSON":"WMS";var j=(f.tipoTematismo==="WFS")?null:"http://geoportale.regione.liguria.it/geoviewer/pages/apps/qpg/info.xsl";var c=CWN2.Globals.RL_QPG_OWS_SERVICE_URL;var b=c+"wms?VIEWPARAMS=ID_RICHIESTA:"+f.idRichiesta+";ID_TEMA:"+f.idTema+"&SLD="+k;var l=c+"wfs?service=WFS&version=1.3.0&request=GetFeature&srs=EPSG:3857&outputFormat=application/json&typeName="+e+"&VIEWPARAMS=ID_RICHIESTA:"+f.idRichiesta+";ID_TEMA:"+f.idTema;var h=this.getRules(f,c,k);var g={id:d,idMap:"QPG",type:a,name:d,visible:true,projection:f.livello.projection,attribution:null,geomType:"VECTOR",geomSubType:f.livello.tipoGeom,queryable:false,order:100+f.idTema,inRange:true,multiClasse:true,wmsParams:{url:b,transparent:true,format:"image/png",format_options:"antialias:none"},url:l,legend:{label:f.descrizione,icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif",popUpFlag:1,popUpUrl:null,popUpWidth:230,popUpHeight:270,popUpAlignTo:{position:"br-br",offsets:[230,0]}},infoOptions:{infoUrl:j,infoTarget:"panel",infoWidth:400,infoHeight:350,infoPopUp:"",infoIdAttr:f.livello.nomeCampoPk,infoLabelAttr:f.livello.nomeCampoTooltip},classes:h,flagGeoserver:false};f.layerConfig=g;f.olLayer=CWN2.app.map.layerManager.addLayers([g])[0]},loadQPGLayers:function(a){Ext.each(a,function(b){CWN2.QPG.createQPGLayer(b)})},getStyle:function getStyle(a){CWN2.Util.log("CWN2.QPG.getStyle ");var c=[];if(a.separatoreDecimale===","){numeral.language("it")}else{numeral.language("en")}Ext.each(a.stat.serie.counter,function(e,f){var h,n,j;switch(a.livello.tipoGeom){case"POLYGON":n={Polygon:{fillColor:a.stat.colors[f],strokeColor:"#000000",fillOpacity:1,fillStroke:1}};j={Polygon:{fillColor:a.stat.colors[f],strokeColor:"#FF9900",strokeWidth:3,fillOpacity:1,fillStroke:1}};break;case"LINE":n={Line:{strokeColor:a.stat.colors[f],strokeWidth:3,fillStroke:1}};break;default:n={Point:{graphicName:"circle",pointRadius:4,fillColor:a.stat.colors[f],fillOpacity:1,fillStroke:1}}}if(a.idTipoClassificazione===0){var k=a.stat.serie.bounds[f];if(typeof k==="number"){k=numeral(k).format("0000.00")}h=new OpenLayers.Rule({name:"R"+f,title:k,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"VALORE",value:k}),symbolizer:n,hoverSymbolizer:j});h.value=a.stat.serie.bounds[f]}else{var m=a.stat.serie.bounds[f],d=a.stat.serie.bounds[f+1],g=numeral(m).format("0000.00"),l=numeral(d).format("0000.00");h=new OpenLayers.Rule({name:"R"+f,title:"da "+g+" a "+l+" ("+e+")",filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:"VALORE_NUM",lowerBoundary:m,upperBoundary:d}),symbolizer:n,hoverSymbolizer:j});h.from=m;h.to=d;h.count=e}c.push(h)});var b=new OpenLayers.Style();b.addRules(c);return b},getSerie:function getSerie(b,d){CWN2.Util.log("CWN2.QPG.getRanges ");var c=new geostats(b.valori);c.setPrecision(2);var a;switch(b.idTipoClassificazione){case 0:a=c.getClassUniqueValues(b.numClassi);break;case 1:a=c.getClassEqInterval(b.numClassi);break;case 2:a=c.getClassQuantile(b.numClassi);break;case 3:a=c.setClassManually(d);break;default:}c.doCount();return c}});Ext.define("CWN2.SimpleLegendGridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-simplelegend-grid",constructor:function(f){CWN2.Util.log("CWN2.SimpleLegendGridPanel");var b=CWN2.app.map.layerManager.getLayerStore(f),d="white-space:normal; text-align:left",e="white-space:normal; opacity:0.3; filter: alpha(opacity = 30); zoom: 1";function c(l,k,j){return(j.data.inRange)?"<div style='"+d+"'>"+j.data.legendLabel+" </div>":"<div style='"+e+"'>"+j.data.legendLabel+" </div>"}function a(l,k,j){return(j.data.inRange)?"<img id='legend_img_"+j.internalId+"' src='"+j.data.legendIcon+"' >":"<img id='legend_img_"+j.internalId+"' src='"+j.data.legendIcon+"' style='"+e+"' >"}function g(m,k,j){var l=(j.data.visible)?"CHECKED":"",n="CWN2.app.map.setBaseLayerOnMap('"+m+"');";return(j.data.inRange)?"<input type='radio' onClick="+n+" "+l+">":null}function h(m,k,j){var l=(j.data.visible)?"CHECKED":"",n="CWN2.app.map.layerManager.setLayerVisible('"+m+"',this.checked);";return(j.data.inRange)?"<input type='checkbox' onClick="+n+" "+l+">":null}CWN2.SimpleLegendGridPanel.superclass.constructor.call(this,{store:b,viewConfig:{forceFit:true,getRowClass:function(k,j){return(k.data.inRange)?"inrange-row":"outrange-row"}},width:230,title:(f=="base")?"Sfondi":"Livelli",hideHeaders:true,disableSelection:true,columns:[{xtype:"actioncolumn",dataIndex:"legendIcon",renderer:a,width:30},{dataIndex:"name",renderer:f==="base"?g:h,width:25},{dataIndex:"legendLabel",renderer:c,width:170}],autoScroll:true,frame:false})}});Ext.define("CWN2.controller.SimpleLegendGridPanel",{extend:"Ext.app.Controller",views:["CWN2.SimpleLegendGridPanel"],refs:[],init:function(a){CWN2.Util.log("CWN2.controller.button.simplelegend: init");this.control({"cwn2-simplelegend-grid":{itemmouseenter:this.onItemMouseEnter},"cwn2-simplelegend-grid actioncolumn":{click:this.onLegendIconClick}})},onLegendIconClick:function(b,a,d){var c=b.store.data.items[d].data;if(c.inRange&&(c.multiClasse||c.legendPopUpFlag)){this.showLegendWindow(c.config)}},showLegendWindow:function(a){if(a.legend.popUpUrl&&a.legend.popUpFlag){var c=new CWN2.IframeWindow({url:a.legend.popUpUrl,width:a.legend.popUpWidth||600,height:a.legend.popUpHeight||400,resizable:false})}else{if(a.multiClasse){if(a.flagGeoserver){var b=a.wmsParams.url+"LAYER="+a.name+"&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&";var c=new CWN2.IframeWindow({url:b,width:500,height:400,resizable:false})}else{var d=new CWN2.MultiClassLegendWindow(a).show();if(a.legend.popUpAlignTo){d.alignTo(CWN2.app.layout.mapPanel.body,a.legend.popUpAlignTo.position,a.legend.popUpAlignTo.offsets)}}}}},onItemMouseEnter:function(b,a,c){var f=a.data.maxScale||1,e=a.data.minScale,d=(!a.data.inRange&&(e||f>1))?"Livello visibile da 1:"+f+" a 1:"+e:(a.data.multiClasse||a.data.legendPopUpFlag)?"Seleziona <img src = '"+a.data.legendIcon+"'> per visualizzare la legenda":"";Ext.fly(c).set({"data-qtip":d})}});Ext.define("CWN2.SimpleLegendPanel",{extend:"Ext.panel.Panel",constructor:function(b){CWN2.Util.log("CWN2.SimpleLegendPanel");var e=(b)?b.flagBtn:false,d=(b)?b.noBaseLayerGrid:false;var a=CWN2.app.configuration.application.layout.legend,c=(e)?"cwn2-legend-panel-btn":"cwn2-legend-panel";var h,f,n,j,m;if(a){h=a.position||"east";f=(e)?false:a.collapsed||false;n=(!e);d=a.noBaseLayerGrid}j=new CWN2.SimpleLegendGridPanel("overlay");if(!d){m=new CWN2.SimpleLegendGridPanel("base")}CWN2.app.map.events.register("zoomend",CWN2.app.map,function(o){j.getView().refresh();if(!d){m.getView().refresh()}});var g=[j];if(!d){g.push(m)}if(CWN2.app.configuration.qpgRequest){var l=CWN2.app.configuration.qpgRequest.tematismi;if(l.length===1){var k=l[0].layerConfig;g.push({xtype:"panel",bodyStyle:"padding:5px",autoScroll:true,items:[{xtype:"dataview",store:new Ext.data.Store({data:k.classes,fields:[{name:"icon",mapping:"legendIcon"},{name:"label",mapping:"legendLabel"}]}),tpl:new Ext.XTemplate("<table width=100% border=0>",'<tpl for=".">',"<tr>",'<td width=30><img src="{icon}"></td>',"<td>{label}</td>","</tpl>"),autoHeight:true,multiSelect:false,itemSelector:"div.thumb-wrap",emptyText:""}]})}}var b={id:c,width:230,autoScroll:true,height:100,region:h,border:false,collapsible:n,collapsed:f,items:g};CWN2.SimpleLegendPanel.superclass.constructor.call(this,b)}});Ext.define("CWN2.Statusbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.cwn2-statusbar",constructor:function(a,c){CWN2.Util.log("CWN2.Toolbar");CWN2.Statusbar.superclass.constructor.call(this,{id:"cwn2-statusbar",cls:"x-statusbar",dock:"bottom"});var b=this;Ext.each(a,function(e){var d=new CWN2.Widget[e.name](e,b);if(d){b.add(d)}})},addStatusbarItem:function(a){if(a&&!Ext.getCmp(a.id)){this.add(a)}},setStatusbarItemText:function(a,b){if(Ext.getCmp(a)){Ext.getCmp(a).setText(b)}}});Ext.define("CWN2.Toolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.cwn2-toolbar",constructor:function(b,g){CWN2.Util.log("CWN2.Toolbar");this.config=b;var d=this;var c=[];var a=b.itemGroups;var f=b.scale||"small";Ext.each(a,function(l,h){if(l){var j=false;if(a[h+1]&&a[h+1].align&&a[h+1].align=="right"){j=true}var k=(h>=(a.length-1));e(l.items,k,j)}});function e(h,j,k){if(h){Ext.each(h,function(m,l){if(typeof(m)!=="function"){c.push(d.checkButton(m,f))}});if(!j){if(k){c.push("->")}else{c.push("-")}}}}CWN2.Toolbar.superclass.constructor.call(this,{id:"cwn2-toolbar",items:c});g.toolbar=this},getButtonOptions:function(b){var a=this.config.itemGroups,c=null;a.map(function(d){d.items.map(function(e){if(e.name===b&&e.options){c=e.options}})});return c},checkButton:function(c,d){CWN2.Util.log("CWN2.Toolbar: Bottone "+c.name);if(c!=="-"&&c!=="->"){var b=c.type||"button";c.xtype="cwn2-"+b+"-"+c.name.toLowerCase();c.scale=d;if(!a(c.xtype)){CWN2.Util.handleException({message:"CWN2.Toolbar - Bottone con name: "+c.name.toLowerCase()+" non definito in libreria. Bottone custom?",level:0})}return c}else{return c}function a(f){var e=false;Ext.iterate(CWN2.button,function(g,h){if(h.xtype===f){e=true;return false}});return e}},addButton:function(a){this.add(this.checkButton(a))}});Ext.define("CWN2.TreeLegendGridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-simplelegend-grid",constructor:function(f){CWN2.Util.log("CWN2.TreeLegendGridPanel");var b=CWN2.app.map.layerManager.getLayerStore(f),d="white-space:normal; text-align:left",e="white-space:normal; opacity:0.3; filter: alpha(opacity = 30); zoom: 1";function c(l,k,j){return(j.data.inRange)?"<div style='"+d+"'>"+j.data.legendLabel+" </div>":"<div style='"+e+"'>"+j.data.legendLabel+" </div>"}function a(l,k,j){return(j.data.inRange)?"<img id='legend_img_"+j.internalId+"' src='"+j.data.legendIcon+"' >":"<img id='legend_img_"+j.internalId+"' src='"+j.data.legendIcon+"' style='"+e+"' >"}function g(m,k,j){var l=(j.data.visible)?"CHECKED":"",n="CWN2.app.map.setBaseLayerOnMap('"+m+"');";return(j.data.inRange)?"<input type='radio' onClick="+n+" "+l+">":null}function h(m,k,j){var l=(j.data.visible)?"CHECKED":"",n="CWN2.app.map.layerManager.setLayerVisible('"+m+"',this.checked);";return(j.data.inRange)?"<input type='checkbox' onClick="+n+" "+l+">":null}CWN2.TreeLegendGridPanel.superclass.constructor.call(this,{store:b,viewConfig:{forceFit:true,getRowClass:function(k,j){return(k.data.inRange)?"inrange-row":"outrange-row"}},width:230,title:(f=="base")?"Sfondi":"Livelli",hideHeaders:true,disableSelection:true,columns:[{xtype:"actioncolumn",dataIndex:"legendIcon",renderer:a,width:30},{dataIndex:"name",renderer:f==="base"?g:h,width:25},{dataIndex:"legendLabel",renderer:c,width:170}],autoScroll:true,frame:false})}});Ext.define("CWN2.controller.TreeLegendGridPanel",{extend:"Ext.app.Controller",views:["CWN2.TreeLegendGridPanel"],refs:[],init:function(a){CWN2.Util.log("CWN2.controller.button.treelegend: init");this.control({"cwn2-simplelegend-grid":{itemmouseenter:this.onItemMouseEnter},"cwn2-simplelegend-grid actioncolumn":{click:this.onLegendIconClick}})},onLegendIconClick:function(b,a,d){var c=b.store.data.items[d].data;if(c.inRange&&(c.multiClasse||c.legendPopUpFlag)){this.showLegendWindow(c.config)}},showLegendWindow:function(a){if(a.legend.popUpUrl&&a.legend.popUpFlag){var c=new CWN2.IframeWindow({url:a.legend.popUpUrl,width:a.legend.popUpWidth||600,height:a.legend.popUpHeight||400,resizable:false}).show()}else{if(a.multiClasse){if(a.flagGeoserver){var b=a.wmsParams.url+"LAYER="+a.name+"&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&";var c=new CWN2.IframeWindow({url:b,width:500,height:400,id:"multi-class-win",resizable:false}).show()}else{var d=new CWN2.MultiClassLegendWindow(a).show();if(a.legend.popUpAlignTo){d.alignTo(CWN2.app.layout.mapPanel.body,a.legend.popUpAlignTo.position,a.legend.popUpAlignTo.offsets)}}}}},onItemMouseEnter:function(b,a,c){var f=a.data.maxScale||1,e=a.data.minScale,d=(!a.data.inRange&&(e||f>1))?"Livello visibile da 1:"+f+" a 1:"+e:(a.data.multiClasse||a.data.legendPopUpFlag)?"Seleziona <img src = '"+a.data.legendIcon+"'> per visualizzare la legenda":"";Ext.fly(c).set({"data-qtip":d})}});Ext.define("CWN2.TreeLegendPanel",{extend:"Ext.panel.Panel",constructor:function(b){CWN2.Util.log("CWN2.TreeLegendPanel");var e=(b)?b.flagBtn:false,d=(b)?b.noBaseLayerGrid:false;var a=CWN2.app.configuration.application.layout.legend,c=(e)?"cwn2-legend-panel-btn":"cwn2-legend-panel";var h,f,n,j,m;if(a){h=a.position||"east";f=(e)?false:a.collapsed||false;n=(!e);d=a.noBaseLayerGrid}j=new CWN2.TreeLegendGridPanel("overlay");if(!d){m=new CWN2.TreeLegendGridPanel("base")}CWN2.app.map.events.register("zoomend",CWN2.app.map,function(o){j.getView().refresh();if(!d){m.getView().refresh()}});var g=[j];if(!d){g.push(m)}if(CWN2.app.configuration.qpgRequest){var l=CWN2.app.configuration.qpgRequest.tematismi;if(l.length===1){var k=l[0].layerConfig;g.push({xtype:"panel",bodyStyle:"padding:5px",autoScroll:true,items:[{xtype:"dataview",store:new Ext.data.Store({data:k.classes,fields:[{name:"icon",mapping:"legendIcon"},{name:"label",mapping:"legendLabel"}]}),tpl:new Ext.XTemplate("<table width=100% border=0>",'<tpl for=".">',"<tr>",'<td width=30><img src="{icon}"></td>',"<td>{label}</td>","</tpl>"),autoHeight:true,multiSelect:false,itemSelector:"div.thumb-wrap",emptyText:""}]})}}var b={id:c,width:230,autoScroll:true,height:100,region:h,border:false,collapsible:n,collapsed:f,items:g};CWN2.TreeLegendPanel.superclass.constructor.call(this,b)}});Ext.define("CWN2.WmsSldHiliter",{hiliteLayerName:null,map:null,hilitedLayerName:null,polygonSymbolizer:"",createHiliteLayer:function(f,l,d){var j=this;var h=this.map.layerManager.getFieldFromLayerConfig(f[0],"projection");var c=this.map.layerManager.getFieldFromLayerConfig(f[0],"wmsParams").url;var k=this.map.layerManager.getFieldFromLayerConfig(f[0],"flagGeoserver");var a=[];Ext.each(f,function(m){a.push(j.map.layerManager.getFieldFromLayerConfig(m,"wmsParams").name)});var g=a.join(",");var e={type:"WMS",name:this.hiliteLayerName,visible:true,projection:h,minScale:0,maxScale:0,opacity:0.7,showInLegend:false,legend:{},classes:[],wmsParams:{url:c,transparent:true,sld:l}};if(!k){e.wmsParams.name=g}var b=this.map.layerManager.createWMSLayer(e);b.hiliteLayer=true;b.sldUrl=l;b.sldCleanUrl=d;b.hilitedLayers=f;return b},hiliteFeature:function(c){CWN2.Util.log("CWN2.WmsSldHiliter.hiliteFeature");var g=this,e=c.layers,f=c.fields,k=c.values,b=c.bounds,m=c.sldFilter,d=c.zoomLevel,l=c.callback,a=c.maxZoomLevel;var j=[];Ext.each(e,function(o){j.push(CWN2.app.map.layerManager.getFieldFromLayerConfig(o,"geomSubType"))});var h=(((f&&k&&k.length>0)||m)&&j.length>0)?CWN2.WmsSldHiliter.getStyle({layers:e,geomType:j,fields:f,values:k,sldFilter:m}):null;var n=CWN2.WmsSldHiliter.getStyle({layers:e,geomType:j,fields:f,values:null,sldFilter:null});this.map.layerManager.remove([this.hiliteLayerName]);CWN2.WmsSldHiliter.createSldFile(h,n,function(o){var p="http://srvcarto.regione.liguria.it/geoservices/temp/"+o.data.sldFile;var r="http://srvcarto.regione.liguria.it/geoservices/temp/"+o.data.sldCleanFile;var q=g.createHiliteLayer(e,p,r);q.setVisibility(true)});CWN2.WmsSldHiliter.zoomToFeatures(b,d,a);if(l){l()}},cleanHiliteLayer:function(){var a=this.hiliteLayerName;var b=this.map.getLayerByName(a);if(b){this.map.layerManager.applyWmsParam(a,"sld",b.sldCleanUrl)}},constructor:function(b,a){CWN2.Util.log("CWN2.WmsSldHiliter");CWN2.Util.assert(b,{name:"BadConfiguration",message:"CWN2.WmsSldHiliter.init: map deve essere valorizzato",level:2});CWN2.Util.assert(a,{name:"BadConfiguration",message:"CWN2.WmsSldHiliter.init: hiliteLayerName deve essere valorizzato",level:2});this.map=b;this.hiliteLayerName=a;b.wmsSldHiliter=this},statics:{defaultSymbolizers:function(){var d="";d+="<sld:PolygonSymbolizer>";d+="<sld:Stroke>";d+='<sld:CssParameter name="stroke">#FFCC00</sld:CssParameter>';d+='<sld:CssParameter name="stroke-width">6.0</sld:CssParameter>';d+="</sld:Stroke>";d+="</sld:PolygonSymbolizer>";var c="";c+="<sld:LineSymbolizer>";c+="<sld:Stroke>";c+='<sld:CssParameter name="stroke">#FFCC00</sld:CssParameter>';c+='<sld:CssParameter name="stroke-width">6.0</sld:CssParameter>';c+="</sld:Stroke>";c+="</sld:LineSymbolizer>";var a="";a+="<sld:PointSymbolizer>";a+="<sld:Graphic>";a+="<sld:Mark>";a+="<sld:WellKnownName>circle</sld:WellKnownName>";a+="<sld:Fill>";a+='<sld:CssParameter name="fill">#FFCC00</sld:CssParameter>';a+="</sld:Fill>";a+="</sld:Mark>";a+="<sld:Size>10.0</sld:Size>";a+="</sld:Graphic>";a+="</sld:PointSymbolizer>";var b={polygonSymbolizer:d,lineSymbolizer:c,pointSymbolizer:a};return b},getFilter:function(a,c){var d=a.split(","),b="<Filter>";if(c){if(c.length>1){b+="<Or>"}Ext.each(c,function(e){var f=e.split(",");if(d.length>1){b+="<And>"}Ext.each(d,function(h,g){b+="<PropertyIsEqualTo><PropertyName>"+h+"</PropertyName><Literal>"+f[g]+"</Literal></PropertyIsEqualTo>"});if(d.length>1){b+="</And>"}});if(c.length>1){b+="</Or>"}}else{Ext.each(d,function(f,e){b+="<PropertyIsEqualTo><PropertyName>"+f+"</PropertyName><Literal>0</Literal></PropertyIsEqualTo>"})}b+="</Filter>";return b},zoomToFeatures:function(b,c,a){if(b){CWN2.app.map.zoomToExtent(b);if(c){CWN2.app.map.zoomTo(c)}if(a&&CWN2.app.map.zoom>a){CWN2.app.map.zoomTo(a)}}},getStyle:function(e){var g=e.layers,b=e.geomType,a=e.fields,d=e.values,c=e.sldFilter;var f='<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor xmlns="http://www.opengis.net/sld" xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" version="1.0.0">';Ext.each(g,function(k,j){var h=CWN2.app.map.layerManager.getFieldFromLayerConfig(k,"wmsParams").name;var l;if(!b){l=CWN2.WmsSldHiliter.defaultSymbolizers()["polygonSymbolizer"]}else{switch(b[j]){case"POLYGON":l=CWN2.WmsSldHiliter.defaultSymbolizers()["polygonSymbolizer"];break;case"LINE":l=CWN2.WmsSldHiliter.defaultSymbolizers()["lineSymbolizer"];break;case"POINT":l=CWN2.WmsSldHiliter.defaultSymbolizers()["pointSymbolizer"];break}}f+="<sld:NamedLayer> <sld:Name>"+h+"</sld:Name>";f+="<sld:UserStyle> <sld:Name>default</sld:Name>";f+="<sld:FeatureTypeStyle> <sld:Rule>";f+=(c)?c:CWN2.WmsSldHiliter.getFilter(a,d);f+=l;f+="</sld:Rule></sld:FeatureTypeStyle>";f+="</sld:UserStyle> </sld:NamedLayer>"});f+="</sld:StyledLayerDescriptor>";return f},createSldFile:function(b,a,c){CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,callBack:c,jsonData:{sldBody:b,sldCleanBody:a},disableException:true})}}});Ext.define("CWN2.ZoomifyPanel",{constructor:function(a){var f=a.imgUrl,e=a.win,d=a.logo,b=a.alignTo;CWN2.Util.log("CWN2.ZoomifyPanel");CWN2.Util.ajaxRequest({type:"XML",url:CWN2.Globals.proxy+f+"ImageProperties.xml",callBack:function(j){var h=Ext.DomQuery.selectValue("IMAGE_PROPERTIES/@WIDTH",j);var g=Ext.DomQuery.selectValue("IMAGE_PROPERTIES/@HEIGHT",j);c(h,g,f)}});function c(h,g,l){e.removeAll();var j=new OpenLayers.Layer.Zoomify("Zoomify",l,new OpenLayers.Size(h,g));j.attribution=d?"<img src="+d+">":"";var k=new OpenLayers.Map("map",{maxExtent:new OpenLayers.Bounds(0,0,h,g),maxResolution:Math.pow(2,j.numberOfTiers-1),numZoomLevels:j.numberOfTiers,units:"pixels",fractionalZoom:true});k.addLayer(j);k.setBaseLayer(j);e.add(new GeoExt.MapPanel({id:"zoomify-panel",xtype:"gx_mappanel",region:"center",border:false,map:k}));e.doLayout();e.show();if(b){e.alignTo(b.element,b.position,b.offset)}k.zoomToMaxExtent()}}});CWN2.Control.DeleteFeature=OpenLayers.Class(OpenLayers.Control.SelectFeature,{initialize:function(c,b){var a=this;function d(e){Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro di voler cancellare la feature?"),function(f){if(f==="yes"){c.destroyFeatures([e])}else{a.unselect(e)}})}OpenLayers.Control.SelectFeature.prototype.initialize.apply(this,[c,{onSelect:d}])},CLASS_NAME:"CWN2.Control.DrawPoint"});CWN2.Control.DrawLine=OpenLayers.Class(OpenLayers.Control.DrawFeature,{singleFeature:false,initialize:function(b,a){OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[b,OpenLayers.Handler.Path,a]);if(a&&a.singleFeature){this.singleFeature=true}},activate:function(a){this.params=a;return OpenLayers.Control.prototype.activate.apply(this,arguments)},drawFeature:function(c){var a=new OpenLayers.Feature.Vector(c),b=this.layer.events.triggerEvent("sketchcomplete",{feature:a});if(b!==false){if(this.singleFeature){this.layer.removeAllFeatures()}a.state=OpenLayers.State.INSERT;this.layer.addFeatures([a]);this.featureAdded(a);this.events.triggerEvent("featureadded",{feature:a})}},CLASS_NAME:"CWN2.Control.DrawLine"});CWN2.Control.DrawPoint=OpenLayers.Class(OpenLayers.Control.DrawFeature,{singleFeature:false,callback:null,initialize:function(b,a){a.id="cwn2-control-drawpoint";OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[b,OpenLayers.Handler.Point,a]);if(a&&a.singleFeature){this.singleFeature=true}if(a&&a.callback){this.callback=a.callback}},activate:function(a){this.params=a;return OpenLayers.Control.prototype.activate.apply(this,arguments)},drawFeature:function(c){var a=new OpenLayers.Feature.Vector(c),b=this.layer.events.triggerEvent("sketchcomplete",{feature:a});if(b!==false){if(this.singleFeature){this.layer.removeAllFeatures()}a.state=OpenLayers.State.INSERT;this.layer.addFeatures([a]);this.featureAdded(a);this.events.triggerEvent("featureadded",{feature:a})}},CLASS_NAME:"CWN2.Control.DrawPoint"});CWN2.Control.DrawPolygon=OpenLayers.Class(OpenLayers.Control.DrawFeature,{singleFeature:false,initialize:function(b,a){OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[b,OpenLayers.Handler.Polygon,a]);if(a&&a.singleFeature){this.singleFeature=true}},activate:function(a){this.params=a;return OpenLayers.Control.prototype.activate.apply(this,arguments)},drawFeature:function(c){var a=new OpenLayers.Feature.Vector(c),b=this.layer.events.triggerEvent("sketchcomplete",{feature:a});if(b!==false){if(this.singleFeature){this.layer.removeAllFeatures()}a.state=OpenLayers.State.INSERT;this.layer.addFeatures([a]);this.featureAdded(a);this.events.triggerEvent("featureadded",{feature:a})}},CLASS_NAME:"CWN2.Control.DrawLine"});CWN2.Control.DrawRegularPolygon=OpenLayers.Class(OpenLayers.Control.DrawFeature,{singleFeature:false,initialize:function(b,a){OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[b,OpenLayers.Handler.RegularPolygon,a]);if(a&&a.singleFeature){this.singleFeature=true}},activate:function(a){this.params=a;return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(a){this.params=a;return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},drawFeature:function(c){var a=new OpenLayers.Feature.Vector(c),b=this.layer.events.triggerEvent("sketchcomplete",{feature:a});if(b!==false){if(this.singleFeature){this.layer.removeAllFeatures()}a.state=OpenLayers.State.INSERT;this.layer.addFeatures([a]);this.featureAdded(a);this.events.triggerEvent("featureadded",{feature:a})}},CLASS_NAME:"CWN2.Control.DrawLine"});CWN2.Control.GetMapCoordinatesOnClick=OpenLayers.Class(OpenLayers.Control,{callback:null,params:{},initialize:function(c){try{CWN2.Util.assert((typeof c==="function"),{name:"NotFunction",message:"CWN2.Control.GetMapCoordinatesOnClick: parametro deve essere una funzione",level:1})}catch(a){CWN2.Util.handleException(a);return null}this.callback=c;OpenLayers.Control.prototype.initialize.apply(this,[c]);var b={};b.click=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,b)},activate:function(a){this.params=a;return OpenLayers.Control.prototype.activate.apply(this,arguments)},getInfoForClick:function(a){var d,c,b;d=this.map.getLonLatFromPixel(a.xy);c=d.clone();b=d.clone();if(this.map.getProjectionObject()!==this.map.displayProjection){c=c.transform(this.map.getProjectionObject(),this.map.displayProjection)}if(this.map.projection!=="EPSG:4326"){b=b.transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"))}if(typeof this.callback==="function"){this.callback(d,c,b,this.params)}},CLASS_NAME:"CWN2.Control.GetMapCoordinatesOnClick"});CWN2.Control.ZoomToInitialExtent=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){if(this.map){this.map.zoomToInitialExtent()}},CLASS_NAME:"OpenLayers.Control.ZoomToExtent"});Ext.define("CWN2.button.BaseLayersCombo",{alias:"widget.cwn2-combo-base-layers",constructor:function(a){return Ext.create("CWN2.BaseLayersComboBox",{id:"combo-base-layers"})}});Ext.define("CWN2.button.Coordinate",{extend:"Ext.button.Button",alias:"widget.cwn2-button-coordinate",constructor:function(b){var a=b.options,f="coordinate",e=CWN2.app.map,c=this,d=new CWN2.Control.DrawPoint(CWN2.Editor.createEditingLayer(e),{singleFeature:true});this.config=b;d.events.register("featureadded",this,function(g){c.fireEvent("featureadded",g)});e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:CWN2.I18n.get("Coordinate Punto"),iconCls:(a&&a.iconCls)?a.iconCls:"drawPoint",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:d,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.Coordinate.Win",{extend:"Ext.window.Window",alias:"widget.cwn2-coordinate-win",title:" Coordinate selezionate",width:300,height:120,layout:"fit",resizable:false,items:[{xtype:"panel",id:"cwn2-coordinate-panel",bodyPadding:10}],geometry:null,closable:false,fbar:[{text:CWN2.I18n.get("Conferma"),action:"coordinate-submit"},{text:CWN2.I18n.get("Annulla"),action:"coordinate-cancel"}]});Ext.define("CWN2.controller.button.coordinate",{extend:"Ext.app.Controller",views:["CWN2.button.Coordinate"],refs:[{ref:"button",selector:"cwn2-button-coordinate"},{ref:"win",selector:"cwn2-coordinate-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.coordinate: init");this.control({"cwn2-button-coordinate":{toggle:this.onButtonPress,featureadded:this.onFeatureAdded},"button[action=coordinate-submit]":{click:this.onSubmitButtonClick},"button[action=coordinate-cancel]":{click:this.onCancelButtonClick}})},onSubmitButtonClick:function(){var b=this.getWin(),a=this.getButton().config.options;if(a&&a.callBacks&&a.callBacks.submit){if(b.geometry){a.callBacks.submit(b.geometry)}else{CWN2.Util.handleException({message:"Nessun punto selezionato",level:1})}}else{CWN2.Util.log("Funzione di callback 'submit' non definita",1)}},onCancelButtonClick:function(){var b=this.getWin(),a=this.getButton().config.options;if(a&&a.callBacks&&a.callBacks.cancel){a.callBacks.cancel()}else{CWN2.Util.log("Funzione di callback 'cancel' non definita",1)}},onButtonPress:function(){var b=this.getWin(),a=this.getButton().config.options;if(!b){b=Ext.create("CWN2.button.Coordinate.Win")}this.showHideWin(b,CWN2.app.layout.mapPanel)},onFeatureAdded:function(d){var f=this.getWin();var a=this.getButton().config.options.projection;var c=CWN2.app.map.projection;if(a&&a!==c){var e="/geoservices/REST/coordinate/transform_point/"+c.replace("EPSG:","")+"/"+a.replace("EPSG:","")+"/"+d.feature.geometry.x+","+d.feature.geometry.y;CWN2.Util.ajaxRequest({type:"JSON",url:e,callBack:function(j,h){var g=j.points[0].split(",");b(g[0],g[1])}})}else{b(d.feature.geometry.x,d.feature.geometry.y)}function b(h,m){h=parseFloat(h);m=parseFloat(m);f.geometry={x:h,y:m};var g=(CWN2.app.map.displayProjection.getUnits()==="m")?0:6;var l=(CWN2.app.map.displayProjection.getUnits()==="m")?"X":"lon";var k=(CWN2.app.map.displayProjection.getUnits()==="m")?"Y":"lat";var j="<b>"+l+" = "+h.toFixed(g)+"<br> "+k+" = "+m.toFixed(g);Ext.ComponentQuery.query('panel[id="cwn2-coordinate-panel"]')[0].update(j)}},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.button.DeleteFeature",{extend:"Ext.button.Button",alias:"widget.cwn2-button-deletefeature",constructor:function(c){var b=c.options,e=CWN2.app.map,a=CWN2.Editor.createEditingLayer(e),d=new CWN2.Control.DeleteFeature(a),f="deleteFeature";e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:CWN2.I18n.get("Cancella Geometria"),iconCls:(b&&b.iconCls)?b.iconCls:f,text:(b&&b.text)?b.text:"",width:(b&&b.width)?b.width:26,control:d,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.DragFeature",{extend:"Ext.button.Button",alias:"widget.cwn2-button-dragfeature",constructor:function(c){var b=c.options,e=CWN2.app.map,a=CWN2.Editor.createEditingLayer(e),d=new OpenLayers.Control.DragFeature(a),f="dragFeature";e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:CWN2.I18n.get("Sposta Geometria"),iconCls:(b&&b.iconCls)?b.iconCls:f,text:(b&&b.text)?b.text:"",width:(b&&b.width)?b.width:26,control:d,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.DrawLine",{extend:"Ext.button.Button",alias:"widget.cwn2-button-drawline",constructor:function(b){var a=b.options||{},d=CWN2.app.map,e="drawLine",c=new CWN2.Control.DrawLine(CWN2.Editor.createEditingLayer(d,a.styleMap),a);c.events.register("featureadded",this,function(f){if(a.callback&&typeof a.callback=="function"){a.callback(f.feature.geometry,f)}});d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:e,tooltip:CWN2.I18n.get("Inserisci Linea"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:c,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.DrawPoint",{extend:"Ext.button.Button",alias:"widget.cwn2-button-drawpoint",constructor:function(b){var a=b.options||{},d=CWN2.app.map,e="drawPoint",c=new CWN2.Control.DrawPoint(CWN2.Editor.createEditingLayer(d,a.styleMap),a);c.events.register("featureadded",this,function(f){if(a.callback&&typeof a.callback=="function"){a.callback(f.feature.geometry,f)}});d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:e,tooltip:CWN2.I18n.get("Inserisci Punto"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:c,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.DrawPolygon",{extend:"Ext.button.Button",alias:"widget.cwn2-button-drawpolygon",constructor:function(b){var a=b.options||{},d=CWN2.app.map,e="drawPolygon",c=new CWN2.Control.DrawPolygon(CWN2.Editor.createEditingLayer(d,a.styleMap),a);c.events.register("featureadded",this,function(f){if(a.callback&&typeof a.callback=="function"){a.callback(f.feature.geometry,f)}});d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:e,tooltip:(a&&a.tooltip)?CWN2.I18n.get(a.tooltip):CWN2.I18n.get("Inserisci Poligono"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:c,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.DrawRegularPolygon",{extend:"Ext.button.Button",alias:"widget.cwn2-button-drawregularpolygon",constructor:function(c){var b=c.options||{},a,e=CWN2.app.map,f=b.id||"drawRegularPolygon";b.type=b.type||"rectangle";switch(b.type){case"rectangle":a={sides:4,irregular:true};break;case"circle":a={sides:40};break;case"triangle":a={sides:3};break;case"pentagon":a={sides:5};break;case"hexagon":a={sides:6};break}b.handlerOptions=a;var d=new CWN2.Control.DrawRegularPolygon(CWN2.Editor.createEditingLayer(e,b.styleMap),b);d.events.register("featureadded",this,function(g){if(b.callback&&typeof b.callback=="function"){b.callback(g.feature.geometry,g)}});e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:(b&&b.tooltip)?CWN2.I18n.get(b.tooltip):CWN2.I18n.get("Inserisci un poligono"),iconCls:(b&&b.iconCls)?b.iconCls:"drawPolygon",text:(b&&b.text)?b.text:"",width:(b&&b.width)?b.width:26,control:d,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.Find",{extend:"Ext.button.Button",alias:"widget.cwn2-button-find",constructor:function(b){var a=b.options,c="find";this.config=b;this.superclass.constructor.call(this,{tooltip:CWN2.I18n.get("Ricerche"),pressed:false,id:c,iconCls:(a&&a.iconCls)?a.iconCls:c,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26})}});Ext.define("CWN2.button.Find.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-find-win",title:CWN2.I18n.get("Ricerche"),height:205,width:335,resizable:false,layout:"fit",closeAction:"hide"});Ext.define("CWN2.button.Find.TabPanel",{extend:"Ext.tab.Panel",alias:"widget.cwn2-btn-find-tab-panel",activeTab:0,bodyBorder:false,deferredRender:false,layoutOnTabChange:true,border:false,flex:1,plain:true});Ext.define("CWN2.button.Find.AddressPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-find-address-panel",frame:true,labelWidth:1,bodyStyle:"padding:5px 5px 0",height:215});Ext.define("CWN2.button.Find.LayerPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-find-layer-panel",frame:true,labelWidth:1,bodyStyle:"padding:5px 5px 0",height:215});Ext.define("CWN2.button.Find.CoordPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-find-coord-panel",frame:true,labelWidth:1,bodyStyle:"padding:5px 5px 0",height:215});Ext.define("CWN2.button.Find.LayerCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-find-layer-combo",mode:"local",typeAhead:true,triggerAction:"all",value:"Scegli un livello...",valueField:"name",displayField:"label",width:300,constructor:function(a){Ext.define("FindLayers",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"label",type:"string"},{name:"columns"}]});this.store=Ext.create("Ext.data.Store",{model:"FindLayers",data:{layers:a.layersConfig},proxy:{type:"memory",reader:{type:"json",root:"layers"}}});this.superclass.constructor.call(this);this.setValue(this.getStore().getAt(0).data.name)}});Ext.define("CWN2.button.Find.ColumnCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-find-column-combo",queryMode:"local",typeAhead:true,triggerAction:"all",width:300,valueField:"name",displayField:"label",constructor:function(a){var b=[];Ext.each(a.layersConfig[0].columns,function(f){var d=f.name,c=CWN2.Util.capitalizeString(f.name.replace(/_/g," ")),e=f.type;b.push({name:d,label:c,type:e})});Ext.define("FindColumns",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"label",type:"string"},{name:"type",type:"string"}]});this.store=Ext.create("Ext.data.Store",{model:"FindColumns",data:{columns:b},proxy:{type:"memory",reader:{type:"json",root:"columns"}}});this.superclass.constructor.call(this);if(this.getStore().getAt(0)){this.setValue(this.getStore().getAt(0).data.name)}}});Ext.define("CWN2.button.Find.OperatorCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-find-operator-combo",queryMode:"local",store:[["=","="],["!=","!="],["<","<"],[">",">"],["<=","<="],[">=",">="],["LIKE","LIKE"]],typeAhead:true,triggerAction:"all",value:"=",width:100});Ext.define("CWN2.button.Find.ValueField",{extend:"Ext.form.field.Text",alias:"widget.cwn2-btn-find-value-field",allowBlank:false,width:300});Ext.define("CWN2.button.Find.LayerSubmit",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-find-layer-submit",text:"Ricerca..."});Ext.define("CWN2.button.Find.LayerValueListButton",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-find-layer-value-list-btn",text:"Lista Valori"});Ext.define("CWN2.button.Find.LayerResultStore",{extend:"Ext.data.Store",storeId:"find-layer-result",autoLoad:false,fields:["id","label","bbox"]});Ext.define("CWN2.button.Find.LayerValueListStore",{extend:"Ext.data.Store",storeId:"find-layer-value-list",autoLoad:false,fields:["value"]});Ext.define("CWN2.button.Find.LayerResultWindow",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-find-layer-result-win",title:CWN2.I18n.get("Risultato ricerca"),width:335,height:360,layout:"fit",closable:true,closeAction:"hide",items:[{xtype:"cwn2-btn-find-layer-result-grid"}]});Ext.define("CWN2.button.Find.LayerValueListWindow",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-find-layer-value-list-win",title:CWN2.I18n.get("Lista valori"),width:335,height:360,layout:"fit",closable:true,closeAction:"hide",items:[{xtype:"cwn2-btn-find-layer-value-list-grid"}]});Ext.define("CWN2.button.Find.LayerValueListGrid",{extend:"Ext.grid.Panel",alias:"widget.cwn2-btn-find-layer-value-list-grid",frame:true,width:320,height:300,header:false,iconCls:"icon-grid",store:Ext.create("CWN2.button.Find.LayerValueListStore"),columns:[{header:"Valore",sortable:true,dataIndex:"value",width:290}]});Ext.define("CWN2.button.Find.LayerResultGrid",{extend:"Ext.grid.Panel",alias:"widget.cwn2-btn-find-layer-result-grid",frame:true,width:320,height:300,header:false,iconCls:"icon-grid",store:Ext.create("CWN2.button.Find.LayerResultStore"),columns:[{header:"ID",sortable:true,dataIndex:"id",width:70},{header:"LABEL",sortable:true,dataIndex:"label",width:220}]});Ext.define("CWN2.button.Find.SrsCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-find-srs-combo",fieldLabel:"",labelWidth:1,queryMode:"local",store:[["3003","Coordinate Piane - Gauss-Boaga - Fuso Ovest"],["25832","Coordinate Piane - ETRS - UTM - ETRF89 - Fuso 32"],["4806","Coordinate Geografiche - ROMA40"],["4258","Coordinate Geografiche - ETRS - ETRF89"]],typeAhead:true,triggerAction:"all",value:"3003",width:300});Ext.define("CWN2.button.Find.XField",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-find-x-field",allowBlank:false,fieldLabel:"X (Est)",decimalPrecision:0,minValue:1378000,maxValue:1586000,width:300});Ext.define("CWN2.button.Find.YField",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-find-y-field",allowBlank:false,fieldLabel:"Y (Nord)",decimalPrecision:0,minValue:4846000,maxValue:4948000,width:300});Ext.define("CWN2.button.Find.CoordSubmit",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-find-coord-submit",text:"Trova..."});Ext.define("CWN2.controller.button.find",{extend:"Ext.app.Controller",views:["CWN2.button.Find"],refs:[{ref:"button",selector:"cwn2-button-find"},{ref:"win",selector:"cwn2-find-win"},{ref:"layerCombo",selector:"cwn2-btn-find-layer-combo"},{ref:"columnCombo",selector:"cwn2-btn-find-column-combo"},{ref:"operatorCombo",selector:"cwn2-btn-find-operator-combo"},{ref:"valueField",selector:"cwn2-btn-find-value-field"},{ref:"layerResultWin",selector:"cwn2-btn-find-layer-result-win"},{ref:"layerResultGrid",selector:"cwn2-btn-find-layer-result-grid"},{ref:"layerValueListWin",selector:"cwn2-btn-find-layer-value-list-win"},{ref:"layerValueListGrid",selector:"cwn2-btn-find-layer-value-list-grid"},{ref:"srsCombo",selector:"cwn2-btn-find-srs-combo"},{ref:"xField",selector:"cwn2-btn-find-x-field"},{ref:"yField",selector:"cwn2-btn-find-y-field"}],layersConfig:[],init:function(a){CWN2.Util.log("CWN2.controller.button.find: init");this.control({"cwn2-button-find":{click:this.onClick},"cwn2-btn-find-layer-combo":{select:this.onLayerSelect},"cwn2-btn-find-column-combo":{select:this.onColumnSelect},"cwn2-btn-find-layer-submit":{click:this.onLayerSubmit},"cwn2-btn-find-coord-submit":{click:this.onCoordSubmit},"cwn2-btn-find-srs-combo":{select:this.onSrsSelect},"cwn2-btn-find-layer-result-grid":{select:this.onLayerGridSelect},"cwn2-btn-find-layer-value-list-btn":{click:this.onLayerValueListClick},"cwn2-btn-find-layer-value-list-grid":{select:this.onValueListGridSelect}})},onCoordSubmit:function(c,d,f){var j=this,b=this.getSrsCombo().value,a=this.getXField(),g=this.getYField(),l=a.value,k=g.value;if(!a.isValid()){Ext.MessageBox.alert("Attenzione","Coordinata X fuori dai limiti ammessi.<br>Posiziona il cursore sopra il campo per conoscere i valori ammessi");return false}if(!g.isValid()){Ext.MessageBox.alert("Attenzione","Coordinata Y fuori dai limiti ammessi.<br>Posiziona il cursore sopra il campo per conoscere i valori ammessi");return false}var h="/geoservices/REST/coordinate/transform_point/"+b+"/3857/"+l+","+k;CWN2.Util.ajaxRequest({type:"JSON",url:h,callBack:function(n,m){var e=n.points[0].split(",");CWN2.FeatureLoader.loadMarker({x:e[0],y:e[1],map:CWN2.app.map,label:"",zoomLevel:17})}})},onSrsSelect:function(f,a,c){var e=this.getXField();var d=this.getYField();var b=this.getSrsCombo().value;switch(b){case"3003":e.setMinValue(1378000);e.setMaxValue(1586000);d.setMinValue(4846000);d.setMaxValue(4948000);e.decimalPrecision=0;d.decimalPrecision=0;break;case"25832":e.setMinValue(377000);e.setMaxValue(586000);d.setMinValue(4845000);d.setMaxValue(4948000);e.decimalPrecision=0;d.decimalPrecision=0;break;case"4258":e.setMinValue(7.48416);e.setMaxValue(10.08478);d.setMinValue(43.756831);d.setMaxValue(44.680042);e.decimalPrecision=6;d.decimalPrecision=6;break;case"4806":e.setMinValue(-4.967781);e.setMaxValue(-2.366957);d.setMinValue(43.756193);d.setMaxValue(44.678726);e.decimalPrecision=6;d.decimalPrecision=6;break}},onLayerSubmit:function(d,g,h){var j=this,f=this.getLayerCombo().value,b=this.getColumnCombo().value,c=this.getColumnCombo().findRecordByValue(b).data.type,a=this.getOperatorCombo().value,k=this.getValueField().value;if(!k){Ext.Msg.show({msg:"Indicare un valore",icon:Ext.Msg.INFO,buttons:Ext.Msg.OK});return}if(c=="DATE"){if(!k.match(/^(0?[1-9]|[12][0-9]|3[01])[\/](0?[1-9]|1[012])[\/]\d{4}$/)){Ext.Msg.show({msg:"Valori di tipo data devono essere espressi nel formato: 'GG/MM/AAAA'",icon:Ext.Msg.INFO,buttons:Ext.Msg.OK});return}if(a=="LIKE"){Ext.Msg.show({msg:"Campi di tipo data non sono compatibili con l'operatore LIKE",icon:Ext.Msg.INFO,buttons:Ext.Msg.OK});return}}CWN2.loadingScreen=Ext.getBody().mask("Ricerca in corso","loadingscreen");CWN2.Util.ajaxRequest({type:"JSONP",url:"/geoservices/REST/config/query_layer/"+f.replace("L","")+"?column="+b+"&datatype="+c+"&operator="+a+"&value="+k+"&map_projection="+CWN2.app.map.projection,callBack:function(e){if(e&&!e.success){CWN2.Util.msgBox("Attenzione: - "+e.message);return}(e.data&&e.data.length>0)?j.onLayerDataResponse(f,e.data):CWN2.Util.msgBox("Nessun oggetto trovato")}})},columnComboChange:true,onLayerValueListClick:function(c,h,b){var g=this,a=this.getLayerCombo().value,f=this.getColumnCombo().value,d=this.getColumnCombo().findRecordByValue(f).data.type,f=this.getColumnCombo().value;if(this.columnComboChange){CWN2.loadingScreen=Ext.getBody().mask("Ricerca in corso","loadingscreen");CWN2.Util.ajaxRequest({type:"JSONP",url:"/geoservices/REST/config/query_layer_valuelist/"+a.replace("L","")+"?column="+f+"&datatype="+d,callBack:function(e){if(e&&!e.success){CWN2.Util.msgBox("Attenzione: - "+e.message);return}(e.data&&e.data.length>0)?g.onLayerValueListResponse(a,e.data):CWN2.Util.msgBox("Nessun oggetto trovato")}});this.columnComboChange=false}else{this.getLayerValueListWin().show()}},onLayerValueListResponse:function(c,e){var d=this,a=this.getWin(),f=this.getLayerValueListWin()||Ext.create("CWN2.button.Find.LayerValueListWindow"),b=this.getLayerValueListGrid().getStore();b.removeAll();Ext.each(e,function(g){b.add(g)});f.show();f.alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[10+a.getWidth()+10,10])},onLayerDataResponse:function(d,f){var e=this,c=CWN2.app.map.layerManager.getLayerConfigByName(d),a=this.getWin(),g=this.getLayerResultWin()||Ext.create("CWN2.button.Find.LayerResultWindow"),b=this.getLayerResultGrid().getStore();b.removeAll();Ext.each(f,function(h){b.add(h)});g.show();g.alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[10,10+a.getHeight()+10])},onLayerSelect:function(d,a,c){var e=this.getColumnCombo();var b=[];e.enable();e.clearValue();Ext.each(a[0].data.columns,function(j){var g=j.name,f=CWN2.Util.capitalizeString(j.name.replace(/_/g," ")),h=j.type;b.push({name:g,label:f,type:h})});e.store.loadData(b,false);e.setValue(e.getStore().getAt(0).data.name)},onColumnSelect:function(c,a,b){this.columnComboChange=true},buildLayersConfig:function(c){var b=this;var a=CWN2.app.map.layerManager.overlayLayersConfig;if(c&&c.layers){Ext.each(c.layers,function(e){var d=CWN2.Util.getArrayElementByAttribute(a,"name",e.name);b.layersConfig.push({name:e.name,label:d.legend.label,columns:(e.dbSchema&&e.dbSchema.columns)?e.dbSchema.columns:a.dbSchema.columns})})}else{Ext.each(a,function(d){if(d.dbSchema&&d.dbSchema.columns){b.layersConfig.push({name:d.name,label:d.legend.label,columns:d.dbSchema.columns})}})}},onValueListGridSelect:function(c,a,b){this.getValueField().setValue(a.data.value.toString());this.getLayerValueListWin().hide()},onLayerGridSelect:function(b,e,g){var h=this,f=this.getLayerCombo().value,j=CWN2.app.map.layerManager.getLayerConfigByName(f),d=j.infoOptions.infoIdAttr,c=e.data.id.toString(),a=new OpenLayers.Bounds.fromString(e.data.bbox);CWN2.MapCatalogueLoader.findLayer({layers:[f],fields:d,values:c,bounds:a,maxZoomLevel:18})},onClick:function(){var e=CWN2.app.layout.mapPanel,d=this.getWin(),b=this.getButton(),c=this;if(!d){var a=[];Ext.each(b.config.panels,function(f){switch(f.type){case"coordinate":a.push({xtype:"cwn2-btn-find-coord-panel",title:CWN2.I18n.get(f.name),items:[{xtype:"label",text:"Sistema di Riferimento:"},{xtype:"cwn2-btn-find-srs-combo"},{xtype:"cwn2-btn-find-x-field"},{xtype:"cwn2-btn-find-y-field"},{xtype:"cwn2-btn-find-coord-submit"}]});break;case"indirizzo":a.push({xtype:"cwn2-btn-find-address-panel",title:CWN2.I18n.get(f.name),items:[{xtype:"cwn2-geocoder-combobox",map:e.map,service:"google",configOptions:f.options,width:200}]});break;case"layer":c.buildLayersConfig(f.options);a.push({xtype:"cwn2-btn-find-layer-panel",title:CWN2.I18n.get(f.name),items:[{xtype:"cwn2-btn-find-layer-combo",layersConfig:c.layersConfig},{xtype:"cwn2-btn-find-column-combo",layersConfig:c.layersConfig},{xtype:"fieldcontainer",border:false,width:300,flex:1,layout:"hbox",items:[{xtype:"cwn2-btn-find-operator-combo"},{xtype:"tbfill"},{xtype:"cwn2-btn-find-layer-value-list-btn"}]},{xtype:"cwn2-btn-find-value-field"},{xtype:"cwn2-btn-find-layer-submit"}]});break}});d=Ext.create("CWN2.button.Find.Window",{items:[{xtype:"cwn2-btn-find-tab-panel",id:"find-tabpanel",items:a}]})}this.showHideWin(d,e)},showHideWin:function(a,b){if(a.isVisible()){a.hide()}else{a.show();a.alignTo(b.body,"tl-tl",[10,10])}}});Ext.define("CWN2.button.Fitall",{extend:"Ext.button.Button",alias:"widget.cwn2-button-fitall",constructor:function(b){var a=b.options,d=CWN2.app.map,c=new OpenLayers.Control.ZoomToMaxExtent();d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{tooltip:CWN2.I18n.get("Zoom alla massima estensione"),iconCls:(a&&a.iconCls)?a.iconCls:"fit",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false,control:c,id:"fitall"}))}});Ext.define("CWN2.button.Generic",{extend:"Ext.button.Button",alias:"widget.cwn2-button-generic",constructor:function(b){var a=b.options||{},c=CWN2.app.map,d="generic";this.options=a;this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:d,tooltip:(a&&a.tooltip)?a.tooltip:CWN2.I18n.get("Bottone Generico"),iconCls:(a&&a.iconCls)?a.iconCls:d,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26}))}});Ext.define("CWN2.controller.button.generic",{extend:"Ext.app.Controller",views:["CWN2.button.Generic"],refs:[{ref:"button",selector:"cwn2-button-generic"}],init:function(a){CWN2.Util.log("CWN2.controller.button.generic: init");this.control({"cwn2-button-generic":{click:this.onClick}})},onClick:function(){var a=this.getButton().options;if(a.callback&&typeof a.callback=="function"){a.callback()}else{CWN2.Util.log("CWN2.button.Generic: funzione di callback non definita",2)}}});Ext.define("Ext.picker.Color",{extend:"Ext.Component",requires:"Ext.XTemplate",alias:"widget.colorpicker",alternateClassName:"Ext.ColorPalette",componentCls:Ext.baseCSSPrefix+"color-picker",selectedCls:Ext.baseCSSPrefix+"color-picker-selected",itemCls:Ext.baseCSSPrefix+"color-picker-item",value:null,clickEvent:"click",allowReselect:false,colors:["000000","993300","333300","003300","003366","000080","333399","333333","800000","FF6600","808000","008000","008080","0000FF","666699","808080","FF0000","FF9900","99CC00","339966","33CCCC","3366FF","800080","969696","FF00FF","FFCC00","FFFF00","00FF00","00FFFF","00CCFF","993366","C0C0C0","FF99CC","FFCC99","FFFF99","CCFFCC","CCFFFF","99CCFF","CC99FF","FFFFFF"],colorRe:/(?:^|\s)color-(.{6})(?:\s|$)/,renderTpl:['<tpl for="colors">','<a href="#" class="color-{.} {parent.itemCls}" hidefocus="on">','<span class="{parent.itemCls}-inner" style="background:#{.}">&#160;</span>',"</a>","</tpl>"],initComponent:function(){var a=this;a.callParent(arguments);a.addEvents("select");if(a.handler){a.on("select",a.handler,a.scope,true)}},initRenderData:function(){var a=this;return Ext.apply(a.callParent(),{itemCls:a.itemCls,colors:a.colors})},onRender:function(){var b=this,a=b.clickEvent;b.callParent(arguments);b.mon(b.el,a,b.handleClick,b,{delegate:"a"});if(a!="click"){b.mon(b.el,"click",Ext.emptyFn,b,{delegate:"a",stopEvent:true})}},afterRender:function(){var a=this,b;a.callParent(arguments);if(a.value){b=a.value;a.value=null;a.select(b,true)}},handleClick:function(c,d){var b=this,a;c.stopEvent();if(!b.disabled){a=d.className.match(b.colorRe)[1];b.select(a.toUpperCase())}},select:function(b,a){var d=this,f=d.selectedCls,e=d.value,c;b=b.replace("#","");if(!d.rendered){d.value=b;return}if(b!=e||d.allowReselect){c=d.el;if(d.value){c.down("a.color-"+e).removeCls(f)}c.down("a.color-"+b).addCls(f);d.value=b;if(a!==true){d.fireEvent("select",d,b)}}},clear:function(){var b=this,c=b.value,a;if(c&&b.rendered){a=b.el.down("a.color-"+c);a.removeCls(b.selectedCls)}b.value=null},getValue:function(){return this.value||null}});Ext.define("Ext.menu.ColorPicker",{extend:"Ext.menu.Menu",alias:"widget.colormenu",requires:["Ext.picker.Color"],hideOnClick:true,pickerId:null,initComponent:function(){var b=this,a=Ext.apply({},b.initialConfig);delete a.listeners;Ext.apply(b,{plain:true,showSeparator:false,items:Ext.applyIf({cls:Ext.baseCSSPrefix+"menu-color-item",id:b.pickerId,xtype:"colorpicker"},a)});b.callParent(arguments);b.picker=b.down("colorpicker");b.relayEvents(b.picker,["select"]);if(b.hideOnClick){b.on("select",b.hidePickerOnSelect,b)}},hidePickerOnSelect:function(){Ext.menu.Manager.hideAll()}});Ext.define("Ext.ux.ColorField",{extend:"Ext.form.TriggerField",triggerConfig:{src:Ext.BLANK_IMAGE_URL,tag:"img",cls:"x-form-trigger x-form-color-trigger"},invalidText:"Colors must be in a the hex format #FFFFFF.",regex:/^\#[0-9A-F]{6}$/i,allowBlank:false,initComponent:function(){this.callParent();this.addEvents("select");this.on("change",function(b,a){this.onSelect(b,a)},this)},onDestroy:function(){Ext.destroy(this.menu);this.callParent()},afterRender:function(){this.callParent(arguments);this.inputEl.setStyle("background",this.value);this.detectFontColor()},onTriggerClick:function(a){if(this.disabled){return}this.menu=new Ext.ux.ColorPicker({shadow:true,autoShow:true,hideOnClick:false,value:this.value,fallback:this.fallback});this.menu.alignTo(this.inputEl,"tl-bl?");this.menuEvents("on");this.menu.show(this.inputEl)},menuEvents:function(a){this.menu[a]("select",this.onSelect,this);this.menu[a]("hide",this.onMenuHide,this);this.menu[a]("show",this.onFocus,this)},onSelect:function(a,b){b=Ext.isString(b)&&b.substr(0,1)!="#"?"#"+b:b;this.setValue(b);this.fireEvent("select",this,b);if(this.inputEl){this.inputEl.setStyle("background",b);this.detectFontColor()}},detectFontColor:function(){if(!this.menu||!this.menu.picker.rawValue){if(!this.value){b="FFFFFF"}else{var a=function(e){return parseInt(e,16)};var b=[a(this.value.slice(1,3)),a(this.value.slice(3,5)),a(this.value.slice(5))]}}else{var b=this.menu.picker.rawValue}var c=(b[0]+b[1]+b[2])/3;this.inputEl.setStyle("color",(c>128)?"#000":"#FFF")},onMenuHide:function(){this.focus(false,60);this.menuEvents("un")}});Ext.define("Ext.ux.CanvasPalette",{alias:"widget.canvaspalette",extend:"Ext.Component",itemCls:"x-color-picker",defaultValue:"#0000FF",width:200,height:200,initComponent:function(){this.callParent();this.addEvents("select");if(!this.value){this.value=this.defaultValue}},getValue:function(){return this.value},setValue:function(a){this.value=a},onRender:function(b,a){var c=document.createElement("div");c.className=this.itemCls;b.dom.insertBefore(c,null);Ext.get(c).setWidth(this.width);this.canvasdiv=Ext.get(c).createChild({tag:"div"});this.wheel=this.canvasdiv.dom.appendChild(document.createElement("canvas"));this.wheel.setAttribute("width","200");this.wheel.setAttribute("height","200");this.wheel.setAttribute("class","x-color-picker-wheel");this.wheel.getContext("2d").drawImage(this.wheelImage,0,0);this.drawGradient();Ext.get(this.wheel).on("click",this.select,this);this.callParent()},afterRender:function(){var b=this;b.callParent();var a=new Ext.dd.DragDrop(b.wheel);a.onDrag=function(d,c){b.select(d,this.DDMInstance.currentTarget)}},select:function(g,c){var b=this.wheel.getContext("2d");var f=[g.getX()-Ext.get(c).getLeft(),g.getY()-Ext.get(c).getTop()];try{var d=b.getImageData(f[0],f[1],1,1)}catch(g){return}var a=function(){this.color=new Ext.draw.Color(this.rawValue[0],this.rawValue[1],this.rawValue[2]);this.value=this.color.toString()};if(d.data[3]==0){var b=this.gradient.getContext("2d");var d=b.getImageData(f[0],f[1],1,1);if(d.data[3]==0){return}this.rawValue=d.data;a.call(this);this.fireEvent("select",this,this.value)}else{this.rawValue=d.data;a.call(this);this.drawGradient();this.fireEvent("select",this,this.value)}},drawGradient:function(){if(!this.gradient){this.gradient=this.canvasdiv.dom.appendChild(document.createElement("canvas"));this.gradient.setAttribute("width","200");this.gradient.setAttribute("height","200");this.gradient.setAttribute("class","x-color-picker-gradient");if(typeof G_vmlCanvasManager!="undefined"){this.gradient=G_vmlCanvasManager.initElement(this.gradient)}Ext.get(this.gradient).on("click",this.select,this)}var b=this.gradient.getContext("2d");var a=[97.5,98];b.clearRect(0,0,this.gradient.width,this.gradient.height);b.beginPath();b.fillStyle=this.value;b.strokeStyle=this.value;b.arc(a[0],a[0],65,0,2*Math.PI,false);b.closePath();b.fill();this.gradient.getContext("2d").drawImage(this.gradientImage,33,32)}},function(){var a=this.prototype;a.wheelImage=(function(){var b=new Image();b.onload=Ext.emptyFn;b.src="/geoviewer/stili/default/icons/wheel.png";return b})();a.gradientImage=(function(){var b=new Image();b.onload=Ext.emptyFn;b.src="/geoviewer/stili/default/icons/gradient.png";return b})()});Ext.define("Ext.ux.ColorPicker",{extend:"Ext.menu.ColorPicker",initComponent:function(){var a=this;if(!Ext.supports.Canvas||a.fallback==true){a.height=100;a.hideOnClick=true;a.callParent();return a.processEvent()}cfg=Ext.apply({},a.canvasCfg);delete cfg.listeners;Ext.apply(a,{plain:true,showSeparator:false,items:Ext.applyIf({cls:Ext.baseCSSPrefix+"menu-color-item",id:a.pickerId,value:a.value,xtype:"canvaspalette"},cfg)});Ext.menu.ColorPicker.superclass.initComponent.call(a);a.picker=a.down("canvaspalette");a.processEvent()},processEvent:function(){var a=this;a.picker.clearListeners();a.relayEvents(a.picker,["select"]);if(a.hideOnClick){a.on("select",a.hidePickerOnSelect,a)}}});Ext.define("CWN2.button.GeoStyler",{extend:"Ext.button.Button",alias:"widget.cwn2-button-geostyler",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{id:"geostyler",tooltip:CWN2.I18n.get("GeoStyler"),iconCls:(a&&a.iconCls)?a.iconCls:"styler",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false})}});Ext.define("CWN2.button.GeoStyler.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-geostyler-win",closeAction:"hide",title:CWN2.I18n.get("Stili"),height:700,width:500,layout:"fit",resizable:false,constructor:function(a){var b=this;this.items=[{xtype:"cwn2-btn-geostyler-panel",layersConfig:a.layersConfig}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.Panel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-panel",height:"auto",width:"auto",frame:true,buttons:[{text:CWN2.I18n.get("Salva"),action:"geostyler-submit"},{text:CWN2.I18n.get("Annulla"),action:"geostyler-cancel"}],autoScroll:true,constructor:function(a){this.items=[{xtype:"cwn2-btn-geostyler-layer-combo",layersConfig:a.layersConfig},{xtype:"cwn2-btn-geostyler-rule-fieldset",layer:a.layersConfig[0]},{xtype:"cwn2-btn-geostyler-tab-panel",rule:a.layersConfig[0].sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[0],labelRule:a.layersConfig[0].labelRule,columns:a.layersConfig[0].columns,geomType:a.layersConfig[0].geomType}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LayerCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-layer-combo",fieldLabel:"Layer",labelWidth:40,mode:"local",typeAhead:true,triggerAction:"all",value:"Scegli un livello...",valueField:"name",displayField:"label",width:300,constructor:function(a){Ext.define("GeostylerLayers",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"label",type:"string"},{name:"geomType",type:"string"},{name:"legendUrl",type:"string"},{name:"labelRule"},{name:"columns"},{name:"sld"}]});this.store=Ext.create("Ext.data.Store",{model:"GeostylerLayers",data:{layers:a.layersConfig},proxy:{type:"memory",reader:{type:"json",root:"layers"}}});this.superclass.constructor.call(this);this.setValue(this.getStore().getAt(0).data.name)}});Ext.define("CWN2.button.GeoStyler.RuleCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-rule-combo",fieldLabel:"Rule",labelWidth:40,queryMode:"local",typeAhead:true,triggerAction:"all",width:300,valueField:"Name",displayField:"Title",constructor:function(a){var b=[];Ext.each(a.layer.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule,function(c){if(c.name!=="LABEL"){b.push({Name:c.Name,Title:c.Title,legendUrl:a.layer.legendUrl+"&RULE="+c.Name,MinScaleDenominator:parseFloat(c.MinScaleDenominator),MaxScaleDenominator:parseFloat(c.MaxScaleDenominator),Filter:c.Filter,PointSymbolizer:c.PointSymbolizer,LineSymbolizer:c.LineSymbolizer,PolygonSymbolizer:c.PolygonSymbolizer})}});Ext.define("GeostylerRules",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"Title",type:"string"},{name:"legendUrl",type:"string"},{name:"MinScaleDenominator"},{name:"MaxScaleDenominator"},{name:"Filter"},{name:"PointSymbolizer"},{name:"LineSymbolizer"},{name:"PolygonSymbolizer"}]});this.store=Ext.create("Ext.data.Store",{model:"GeostylerRules",data:{rules:b},proxy:{type:"memory",reader:{type:"json",root:"rules"}}});this.superclass.constructor.call(this);this.setValue(this.getStore().getAt(0).data.Name)}});Ext.define("CWN2.button.GeoStyler.RuleFieldSet",{extend:"Ext.form.FieldSet",alias:"widget.cwn2-btn-geostyler-rule-fieldset",title:" ",border:false,layout:"vbox",padding:"0",constructor:function(a){this.items=[{xtype:"fieldset",border:false,flex:1,width:350,layout:"hbox",padding:"0",items:[{xtype:"cwn2-btn-geostyler-rule-combo",layer:a.layer},{xtype:"tbfill"},{xtype:"cwn2-btn-geostyler-rule-legend",legendUrl:a.layer.legendUrl+"&RULE="+a.layer.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[0].Name}]},{xtype:"fieldset",border:false,flex:1,width:350,layout:"hbox",padding:"0",items:[{xtype:"cwn2-btn-geostyler-add-rule"},{xtype:"tbfill"},{xtype:"cwn2-btn-geostyler-delete-rule"},{xtype:"tbfill"},{xtype:"cwn2-btn-geostyler-change-rule-order"},{xtype:"tbfill"},{xtype:"cwn2-btn-geostyler-generate-rules"}]}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.AddRule",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-geostyler-add-rule",text:"Add Rule",constructor:function(a){this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.DeleteRule",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-geostyler-delete-rule",text:"Delete Rule",constructor:function(a){this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.ChangeRuleOrder",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-geostyler-change-rule-order",text:"Cambia Ordine",constructor:function(a){this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.ChangeRuleOrder.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-geostyler-change-rule-order-window",closeAction:"destroy",title:CWN2.I18n.get("Cambia Ordine"),height:500,width:400,layout:"fit",resizable:false,constructor:function(a){var b=this;var c=[];Ext.each(a.rules,function(e,d){if(e.Name!=="LABEL"){c.push(e)}});this.items=[{xtype:"cwn2-btn-geostyler-change-rule-order-panel",rules:a.rules}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.ChangeRuleOrder.Panel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-btn-geostyler-change-rule-order-panel",hideHeaders:true,selModel:{mode:"MULTI"},viewConfig:{plugins:{ptype:"gridviewdragdrop"}},columns:[{dataIndex:"Title",width:380}],width:380,height:150,buttons:[{text:CWN2.I18n.get("Salva"),action:"change-rule-order-submit"},{text:CWN2.I18n.get("Annulla"),action:"change-rule-order-cancel"}],constructor:function(a){var b=[];Ext.each(a.rules,function(d,c){if(d.Name!=="LABEL"){b.push(d)}});this.store=Ext.create("Ext.data.Store",{fields:[{name:"Name",mapping:"Name"},{name:"Title",mapping:"Title"}],data:b});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GenerateRules",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-geostyler-generate-rules",text:"Genera Rules",constructor:function(a){this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GenerateRules.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-geostyler-generate-rules-window",closeAction:"destroy",title:CWN2.I18n.get("Genera Classificazione"),height:500,width:400,layout:"fit",resizable:false,constructor:function(a){var b=this;this.items=[{xtype:"cwn2-btn-geostyler-generate-rules-order-panel",columns:a.columns}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GenerateRules.Panel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-generate-rules-order-panel",frame:true,labelWidth:1,bodyStyle:"padding:5px 5px 0",height:215,buttons:[{text:CWN2.I18n.get("Salva"),action:"change-generate-rules-submit"},{text:CWN2.I18n.get("Annulla"),action:"change-rule-order-cancel"}],constructor:function(a){var b=this;this.items=[{xtype:"cwn2-btn-geostyler-generate-rules-columns-combo",columns:a.columns}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GenerateRules.ColumnCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-generate-rules-columns-combo",fieldLabel:"Campo",labelWidth:40,queryMode:"local",store:[],typeAhead:true,triggerAction:"all",width:300,previousValue:null,constructor:function(a){var b=[];Ext.each(a.columns,function(c){if(c.type==="VARCHAR2"){b.push(c.name)}});this.store=b;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.TabPanel",{extend:"Ext.tab.Panel",alias:"widget.cwn2-btn-geostyler-tab-panel",activeTab:0,bodyBorder:false,deferredRender:false,layoutOnTabChange:true,border:false,flex:1,plain:true,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-symbol-tab",rule:a.rule,geomType:a.geomType},{xtype:"cwn2-btn-geostyler-advanced-tab",rule:a.rule},{xtype:"cwn2-btn-geostyler-label-tab",labelRule:a.labelRule,columns:a.columns,geomType:a.geomType}];this.superclass.constructor.call(this);this.setActiveTab(a.activeTab)}});Ext.define("CWN2.button.GeoStyler.LabelTab",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-tab",frame:false,title:"Label",labelWidth:1,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-label-panel",labelRule:a.labelRule,columns:a.columns,geomType:a.geomType}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-panel",frame:true,title:"",items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-label-columns-combo",columns:a.columns,labelRule:a.labelRule},{xtype:"cwn2-btn-geostyler-label-font-panel",labelRule:a.labelRule},{xtype:"cwn2-btn-geostyler-label-placement-panel",labelRule:a.labelRule,geomType:a.geomType}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelColumnsCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-label-columns-combo",fieldLabel:"Campo",labelWidth:40,queryMode:"local",store:[],typeAhead:true,triggerAction:"all",width:400,previousValue:null,listeners:{select:function(b,a,c){if(b.getValue()==""||b.getValue()=="&nbsp;"){b.setValue(null)}}},constructor:function(a){var b=[];Ext.each(a.columns,function(c){b.push(c.name)});this.store=b;this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Label&&a.labelRule.TextSymbolizer.Label.PropertyName){this.setValue(a.labelRule.TextSymbolizer.Label.PropertyName)}}});Ext.define("CWN2.button.GeoStyler.LabelFontPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-font-panel",frame:true,items:[],constructor:function(c){var j=this,b=c.labelRule,k=null,m=null,g=null,l=null,h=null,e=null,d=null,a=null,f=null;if(b&&b.TextSymbolizer){k=getCssParameter(b.TextSymbolizer.Font,"font-family");m=getCssParameter(b.TextSymbolizer.Font,"font-size");g=getCssParameter(b.TextSymbolizer.Font,"font-style");l=getCssParameter(b.TextSymbolizer.Font,"font-weight");f=getCssParameter(b.TextSymbolizer.Fill,"fill");d=parseFloat(b.MinScaleDenominator);a=parseFloat(b.MaxScaleDenominator);h=(b.TextSymbolizer.Halo)?getCssParameter(b.TextSymbolizer.Halo.Fill,"fill"):null;e=(b.TextSymbolizer.Halo)?b.TextSymbolizer.Halo.Radius:null}j.items=[{xtype:"cwn2-btn-geostyler-label-font-family-combo",fontFamily:k},{xtype:"cwn2-btn-geostyler-label-font-size",fontSize:m},{xtype:"cwn2-btn-geostyler-label-font-style-combo",fontStyle:g},{xtype:"cwn2-btn-geostyler-label-font-weight-combo",fontWeight:l},{xtype:"cwn2-btn-geostyler-label-fill-color-field",color:f},{xtype:"cwn2-btn-geostyler-label-halo-radius",haloRadius:e},{xtype:"cwn2-btn-geostyler-label-halo-color-field",haloColor:h},{xtype:"cwn2-btn-geostyler-label-min-scale",minScale:d},{xtype:"cwn2-btn-geostyler-label-max-scale",maxScale:a}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelPlacementPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-placement-panel",frame:true,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-label-point-placement-panel",labelRule:a.labelRule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelLinePlacementPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-line-placement-panel",frame:true,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-label-line-perpendicular-offset",labelRule:a.labelRule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelPerpendicularOffset",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-line-perpendicular-offset",fieldLabel:"Line Offset",labelWidth:80,minValue:1,width:130,constructor:function(a){this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.LinePlacement&&a.labelRule.TextSymbolizer.LabelPlacement.LinePlacement.PerpendicularOffset){this.setValue(a.labelRule.TextSymbolizer.LabelPlacement.LinePlacement.PerpendicularOffset)}}});Ext.define("CWN2.button.GeoStyler.LabelPointPlacementPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-label-point-placement-panel",frame:true,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-label-anchor-x",labelRule:a.labelRule},{xtype:"cwn2-btn-geostyler-label-anchor-y",labelRule:a.labelRule},{xtype:"cwn2-btn-geostyler-label-displacement-x",labelRule:a.labelRule},{xtype:"cwn2-btn-geostyler-label-displacement-y",labelRule:a.labelRule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LabelFontSize",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-font-size",fieldLabel:"Size",labelWidth:40,minValue:1,width:100,constructor:function(a){this.superclass.constructor.call(this);if((a.fontSize)){this.setValue(parseInt(a.fontSize))}}});Ext.define("CWN2.button.GeoStyler.LabelFontFamilyCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-label-font-family-combo",fieldLabel:"Font",labelWidth:40,queryMode:"local",store:[],typeAhead:true,triggerAction:"all",width:250,previousValue:null,constructor:function(a){this.store=GeoStyler.app.geoServerFontList;this.superclass.constructor.call(this);if(a.fontFamily){this.setValue(a.fontFamily)}}});Ext.define("CWN2.button.GeoStyler.LabelFontStyleCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-label-font-style-combo",fieldLabel:"Stile",labelWidth:40,queryMode:"local",store:["normal","italic","oblique"],typeAhead:true,triggerAction:"all",value:"normal",width:150,previousValue:null,constructor:function(a){this.superclass.constructor.call(this);if(a.fontStyle){this.setValue(a.fontStyle)}}});Ext.define("CWN2.button.GeoStyler.LabelFontWeightCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-label-font-weight-combo",fieldLabel:"Peso",labelWidth:40,queryMode:"local",store:["normal","bold"],typeAhead:true,triggerAction:"all",value:"normal",width:150,previousValue:null,constructor:function(a){this.superclass.constructor.call(this);if(a.fontWeight){this.setValue(a.fontWeight)}}});Ext.define("CWN2.button.GeoStyler.LabelFillColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-label-fill-color-field",fieldLabel:"Color",labelWidth:40,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.color){this.setValue(a.color)}}});Ext.define("CWN2.button.GeoStyler.LabelHaloColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-label-halo-color-field",fieldLabel:"Halo Color",labelWidth:60,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.haloColor){this.setValue(a.haloColor)}}});Ext.define("CWN2.button.GeoStyler.LabelHaloRadius",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-halo-radius",fieldLabel:"Halo",labelWidth:60,minValue:0,width:120,constructor:function(a){this.superclass.constructor.call(this);if((a.haloRadius)){this.setValue(parseInt(a.haloRadius))}}});Ext.define("CWN2.button.GeoStyler.LabelMinScaleDenominator",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-min-scale",fieldLabel:"Denom. Scala Min.",labelWidth:120,minValue:1,width:300,constructor:function(a){this.superclass.constructor.call(this);if((a.minScale)){this.setValue(a.minScale)}}});Ext.define("CWN2.button.GeoStyler.LabelMaxScaleDenominator",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-max-scale",fieldLabel:"Denom. Scala Max.",labelWidth:120,minValue:1,width:300,constructor:function(a){this.superclass.constructor.call(this);if((a.maxScale)){this.setValue(a.maxScale)}}});Ext.define("CWN2.button.GeoStyler.LabelAnchorX",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-anchor-x",fieldLabel:"Anchor X",labelWidth:60,minValue:0,maxValue:1,width:110,constructor:function(a){this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint){this.setValue(a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint.AnchorPointX)}}});Ext.define("CWN2.button.GeoStyler.LabelAnchorY",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-anchor-y",fieldLabel:"Anchor Y",labelWidth:60,minValue:0,maxValue:1,width:110,constructor:function(a){this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint){this.setValue(a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint.AnchorPointY)}}});Ext.define("CWN2.button.GeoStyler.LabelDisplacementX",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-displacement-x",fieldLabel:"Displacement X",labelWidth:90,minValue:0,maxValue:100,width:140,constructor:function(a){this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement){this.setValue(a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement.DisplacementX)}}});Ext.define("CWN2.button.GeoStyler.LabelDisplacementY",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-label-displacement-y",fieldLabel:"Displacement Y",labelWidth:90,minValue:0,maxValue:100,width:140,constructor:function(a){this.superclass.constructor.call(this);if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement){this.setValue(a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement.DisplacementY)}}});Ext.define("CWN2.button.GeoStyler.AdvancedTab",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-advanced-tab",frame:false,title:"Avanzate",labelWidth:1,items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-advanced-panel",rule:a.rule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.AdvancedPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-advanced-panel",frame:true,title:"",items:[],buttons:[{text:CWN2.I18n.get("Validazione"),action:"geostyler-validate-cql"}],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-rule-title",rule:a.rule},{xtype:"cwn2-btn-geostyler-min-scale",rule:a.rule},{xtype:"cwn2-btn-geostyler-max-scale",rule:a.rule},{xtype:"cwn2-btn-geostyler-cql-filter",rule:a.rule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.RuleTitle",{extend:"Ext.form.field.Text",alias:"widget.cwn2-btn-geostyler-rule-title",fieldLabel:"Titolo",labelWidth:70,width:300,value:"Classe Base",constructor:function(a){this.superclass.constructor.call(this);if((a.rule.Title)){this.setValue(a.rule.Title)}}});Ext.define("CWN2.button.GeoStyler.MinScaleDenominator",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-min-scale",fieldLabel:"Denom. Scala Min.",labelWidth:120,minValue:1,width:300,constructor:function(a){this.superclass.constructor.call(this);if((a.rule.MinScaleDenominator)){this.setValue(a.rule.MinScaleDenominator)}}});Ext.define("CWN2.button.GeoStyler.MaxScaleDenominator",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-max-scale",fieldLabel:"Denom. Scala Max.",labelWidth:120,minValue:1,width:300,constructor:function(a){this.superclass.constructor.call(this);if((a.rule.MaxScaleDenominator)){this.setValue(a.rule.MaxScaleDenominator)}}});Ext.define("CWN2.button.GeoStyler.CQLFilter",{extend:"Ext.form.field.TextArea",alias:"widget.cwn2-btn-geostyler-cql-filter",fieldLabel:"Filtro",labelWidth:50,width:450,rows:10,constructor:function(a){this.superclass.constructor.call(this);if((a.rule.Filter)){var b=CWN2.Util.transformFilterJson2CQL(a.rule.Filter);this.setValue(b)}}});Ext.define("CWN2.button.GeoStyler.SymbolTab",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-symbol-tab",frame:false,title:"Simbologia",labelWidth:1,items:[],constructor:function(b){var c=this,a=b.geomType,d=null;switch(a){case"POLYGON":d="cwn2-btn-geostyler-polygon-panel";break;case"LINE":d="cwn2-btn-geostyler-line-panel";break;case"POINT":d="cwn2-btn-geostyler-point-panel";break}c.items=[{xtype:d,rule:b.rule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.PointPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-point-panel",frame:true,title:"POINT",items:[],constructor:function(a){var b=this,c=a.rule,e,d;if(!c.PointSymbolizer){console.log("Manca elemento <PointSymbolizer>");return}if(!c.PointSymbolizer.Graphic){console.log("Manca elemento <Graphic>");return}if(c.PointSymbolizer.Graphic.ExternalGraphic){e="Graphic";d={xtype:"cwn2-btn-geostyler-graphic-point-panel",rule:c}}if(c.PointSymbolizer.Graphic.Mark){e="WKN";d={xtype:"cwn2-btn-geostyler-wkn-point-panel",rule:c}}b.items=[{xtype:"cwn2-btn-geostyler-point-type-combo",rule:c,pointType:e},d];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GraphicPointPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-graphic-point-panel",frame:true,items:[],constructor:function(a){var b=this,c=a.rule.PointSymbolizer.Graphic;b.items=[{xtype:"cwn2-btn-geostyler-external-graphic-url",externalGraphic:c.ExternalGraphic.OnlineResource["_xlink:href"]},{xtype:"cwn2-btn-geostyler-graphic-format-combo",graphicFormat:c.ExternalGraphic.Format},{xtype:"cwn2-btn-geostyler-symbol-size",size:c.Size},{xtype:"cwn2-btn-geostyler-external-graphic-img",externalGraphic:c.ExternalGraphic.OnlineResource["_xlink:href"],size:c.Size}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.WknPointPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-wkn-point-panel",frame:true,items:[],constructor:function(b){var d=this,h=b.rule.PointSymbolizer.Graphic.Mark;setDefaultMark(h,"POINT");var g=getCssParameter(h.Fill,"fill");var a=getCssParameter(h.Fill,"fill-opacity")||"1";var e=getCssParameter(h.Stroke,"stroke");var f=getCssParameter(h.Stroke,"stroke-width");var c=getCssParameter(h.Stroke,"stroke-opacity");d.items=[{xtype:"cwn2-btn-geostyler-symbol-combo",symbol:h.WellKnownName},{xtype:"cwn2-btn-geostyler-symbol-size",size:b.rule.PointSymbolizer.Graphic.Size},{xtype:"cwn2-btn-geostyler-fill-color-field",color:g},{xtype:"cwn2-btn-geostyler-fill-opacity-slider",opacity:a},{xtype:"cwn2-btn-geostyler-stroke-color-field",color:e},{xtype:"cwn2-btn-geostyler-stroke-width",width:f},{xtype:"cwn2-btn-geostyler-stroke-opacity-slider",opacity:c}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.LinePanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-line-panel",frame:false,title:"LINE",items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-stroke-panel",rule:a.rule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.PolygonPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-polygon-panel",frame:false,title:"POLYGON",items:[],constructor:function(a){var b=this;b.items=[{xtype:"cwn2-btn-geostyler-stroke-panel",rule:a.rule},{xtype:"cwn2-btn-geostyler-polygon-fill-panel",rule:a.rule}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.PolygonFillPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-polygon-fill-panel",frame:true,items:[],constructor:function(a){var d=this,e=a.rule,c=e.PolygonSymbolizer;var f,b=null;if(!c.Fill){f="None";b=null}else{if(!c.Fill.GraphicFill){f="Simple";b={xtype:"cwn2-btn-geostyler-simple-fill-panel",rule:e}}else{if(c.Fill.GraphicFill.Graphic.ExternalGraphic){f="Graphic";b={xtype:"cwn2-btn-geostyler-graphic-fill-panel",rule:e}}if(c.Fill.GraphicFill.Graphic.Mark){f="Hatch";b={xtype:"cwn2-btn-geostyler-hatch-fill-panel",rule:e}}}}d.items=[{xtype:"cwn2-btn-geostyler-fill-type-combo",rule:e,fillType:f},b];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.SimpleFillPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-simple-fill-panel",frame:true,items:[],constructor:function(b){var d=this,e=b.rule,c=e.PolygonSymbolizer;var f=getCssParameter(c.Fill,"fill");var a=getCssParameter(c.Fill,"fill-opacity")||"1";d.items=[{xtype:"cwn2-btn-geostyler-fill-color-field",color:f},{xtype:"cwn2-btn-geostyler-fill-opacity-slider",opacity:a}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.HatchFillPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-hatch-fill-panel",frame:true,items:[],constructor:function(c){var g=this,h=c.rule,n=h.PolygonSymbolizer,a=n.Fill.GraphicFill.Graphic;setDefaultMark(a.Mark,"POLYGON");var e=a.Mark.WellKnownName;var d=a.Size;var b=getCssParameter(a.Mark.Fill,"fill");var k=getCssParameter(a.Mark.Fill,"fill-opacity")||"1";var m=getCssParameter(a.Mark.Stroke,"stroke");var j=getCssParameter(a.Mark.Stroke,"stroke-width");var f=getCssParameter(a.Mark.Stroke,"stroke-opacity");var l=getCssParameter(n.Stroke,"stroke-dasharray");g.items=[{xtype:"cwn2-btn-geostyler-hatch-combo",symbol:e},{xtype:"cwn2-btn-geostyler-symbol-size",size:d},{xtype:"cwn2-btn-geostyler-hatch-stroke-color-field",color:m},{xtype:"cwn2-btn-geostyler-hatch-stroke-width",width:j},{xtype:"cwn2-btn-geostyler-hatch-stroke-opacity-slider",opacity:f},{xtype:"cwn2-btn-geostyler-hatch-fill-color-field",color:b},{xtype:"cwn2-btn-geostyler-hatch-fill-opacity-slider",opacity:k}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.GraphicFillPanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-graphic-fill-panel",frame:true,items:[],constructor:function(a){var b=this,c=a.rule,d=c.PolygonSymbolizer.Fill.GraphicFill.Graphic;b.items=[{xtype:"cwn2-btn-geostyler-external-graphic-url",externalGraphic:d.ExternalGraphic.OnlineResource["_xlink:href"]},{xtype:"cwn2-btn-geostyler-graphic-format-combo",graphicFormat:d.ExternalGraphic.Format},{xtype:"cwn2-btn-geostyler-symbol-size",size:d.Size},{xtype:"cwn2-btn-geostyler-external-graphic-img",externalGraphic:d.ExternalGraphic.OnlineResource["_xlink:href"],size:d.Size}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.StrokePanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-stroke-panel",frame:true,items:[],constructor:function(b){var d=this,f=b.rule,c=f.LineSymbolizer||f.PolygonSymbolizer;var e,a=null;if(c.Stroke||c.Stroke===""){if(c.Stroke.GraphicStroke){e="WKN";a={xtype:"cwn2-btn-geostyler-wkn-stroke-panel",rule:f}}else{e="Simple";a={xtype:"cwn2-btn-geostyler-simple-stroke-panel",rule:f}}}else{e="None";a=null}d.items=[{xtype:"cwn2-btn-geostyler-stroke-type-combo",strokeType:e,rule:f},a];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.SimpleStrokePanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-simple-stroke-panel",frame:true,items:[],constructor:function(b){var e=this,g=b.rule,d=g.LineSymbolizer||g.PolygonSymbolizer;if(d.Stroke===""){d.Stroke={CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-width",__text:"1"}]}}var f=getCssParameter(d.Stroke,"stroke")||"#000000";var h=getCssParameter(d.Stroke,"stroke-width");var c=getCssParameter(d.Stroke,"stroke-opacity");var a=getCssParameter(d.Stroke,"stroke-dasharray");e.items=[{xtype:"cwn2-btn-geostyler-stroke-color-field",color:f},{xtype:"cwn2-btn-geostyler-stroke-width",width:h},{xtype:"cwn2-btn-geostyler-stroke-opacity-slider",opacity:c},{xtype:"cwn2-btn-geostyler-stroke-dasharray",strokeDashstyle:a}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.WknStrokePanel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-geostyler-wkn-stroke-panel",frame:true,items:[],constructor:function(c){var g=this,h=c.rule,n=h.LineSymbolizer||h.PolygonSymbolizer,a=n.Stroke.GraphicStroke.Graphic;setDefaultMark(a.Mark,"LINE");var e=a.Mark.WellKnownName;var d=a.Size;var b=getCssParameter(a.Mark.Fill,"fill");var k=getCssParameter(a.Mark.Fill,"fill-opacity")||"1";var m=getCssParameter(a.Mark.Stroke,"stroke");var j=getCssParameter(a.Mark.Stroke,"stroke-width");var f=getCssParameter(a.Mark.Stroke,"stroke-opacity");var l=getCssParameter(n.Stroke,"stroke-dasharray");g.items=[{xtype:"cwn2-btn-geostyler-symbol-combo",symbol:e},{xtype:"cwn2-btn-geostyler-symbol-size",size:d},{xtype:"cwn2-btn-geostyler-fill-color-field",color:b},{xtype:"cwn2-btn-geostyler-stroke-color-field",color:m},{xtype:"cwn2-btn-geostyler-stroke-width",width:j},{xtype:"cwn2-btn-geostyler-stroke-dasharray",strokeDashstyle:l}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.FillColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-fill-color-field",fieldLabel:"Fill Color",labelWidth:50,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.color){this.setValue(a.color)}}});Ext.define("CWN2.button.GeoStyler.HatchFillColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-hatch-fill-color-field",fieldLabel:"Fill Color",labelWidth:50,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.color){this.setValue(a.color)}}});Ext.define("CWN2.button.GeoStyler.FillOpacitySlider",{extend:"Ext.slider.Single",alias:"widget.cwn2-btn-geostyler-fill-opacity-slider",fieldLabel:"Fill Opacity",labelWidth:50,width:200,value:100,minValue:0,maxValue:100,constructor:function(a){this.superclass.constructor.call(this);if(a.opacity){this.setValue(100*parseFloat(a.opacity))}}});Ext.define("CWN2.button.GeoStyler.HatchFillOpacitySlider",{extend:"Ext.slider.Single",alias:"widget.cwn2-btn-geostyler-hatch-fill-opacity-slider",fieldLabel:"Fill Opacity",labelWidth:50,width:200,value:100,minValue:0,maxValue:100,constructor:function(a){this.superclass.constructor.call(this);if(a.opacity){this.setValue(100*parseFloat(a.opacity))}}});Ext.define("CWN2.button.GeoStyler.StrokeColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-stroke-color-field",fieldLabel:"Stroke Color",labelWidth:50,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.color){this.setValue(a.color)}}});Ext.define("CWN2.button.GeoStyler.HatchStrokeColorField",{extend:"Ext.ux.ColorField",alias:"widget.cwn2-btn-geostyler-hatch-stroke-color-field",fieldLabel:"Stroke Color",labelWidth:50,width:200,value:"#ffffff",msgTarget:"qtip",constructor:function(a){this.superclass.constructor.call(this);if(a.color){this.setValue(a.color)}}});Ext.define("CWN2.button.GeoStyler.StrokeOpacitySlider",{extend:"Ext.slider.Single",alias:"widget.cwn2-btn-geostyler-stroke-opacity-slider",fieldLabel:"Stroke Opacity",labelWidth:50,width:200,value:100,minValue:0,maxValue:100,constructor:function(a){this.superclass.constructor.call(this);if(a.opacity){this.setValue(100*parseFloat(a.opacity))}}});Ext.define("CWN2.button.GeoStyler.HatchStrokeOpacitySlider",{extend:"Ext.slider.Single",alias:"widget.cwn2-btn-geostyler-hatch-stroke-opacity-slider",fieldLabel:"Stroke Opacity",labelWidth:50,width:200,value:100,minValue:0,maxValue:100,constructor:function(a){this.superclass.constructor.call(this);if(a.opacity){this.setValue(100*parseFloat(a.opacity))}}});Ext.define("CWN2.button.GeoStyler.StrokeTypeCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-stroke-type-combo",fieldLabel:"Stroke",labelWidth:40,queryMode:"local",store:[],typeAhead:true,triggerAction:"all",value:"Simple",width:200,previousValue:null,constructor:function(a){if(a.rule.LineSymbolizer){this.store=[["Simple","Simple"],["WKN","WKN"]]}else{this.store=[["None","None"],["Simple","Simple"]]}this.superclass.constructor.call(this);this.setValue(a.strokeType);this.previousValue=a.strokeType}});Ext.define("CWN2.button.GeoStyler.StrokeWidth",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-stroke-width",fieldLabel:"Width",labelWidth:50,width:100,maxValue:99,minValue:0,constructor:function(a){this.superclass.constructor.call(this);this.setValue(parseFloat(a.width))}});Ext.define("CWN2.button.GeoStyler.HatchStrokeWidth",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-hatch-stroke-width",fieldLabel:"Width",labelWidth:50,width:100,maxValue:99,minValue:0.5,constructor:function(a){this.superclass.constructor.call(this);this.setValue(parseFloat(a.width))}});Ext.define("CWN2.button.GeoStyler.StrokeDashStyle1",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-stroke-dashstyle1",width:45,flex:1,constructor:function(a){this.superclass.constructor.call(this);this.setValue(parseFloat(a.value))}});Ext.define("CWN2.button.GeoStyler.StrokeDashStyle2",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-stroke-dashstyle2",width:45,constructor:function(a){this.superclass.constructor.call(this);this.setValue(parseFloat(a.value))}});Ext.define("CWN2.button.GeoStyler.StrokeDashArray",{extend:"Ext.form.FieldContainer",alias:"widget.cwn2-btn-geostyler-stroke-dasharray",fieldLabel:"Dash",labelWidth:50,width:190,layout:"hbox",items:[],constructor:function(d){var c,b,a;if(d.strokeDashstyle){c=d.strokeDashstyle.split(" ");b=c[0];a=c[1]}this.items=[{xtype:"cwn2-btn-geostyler-stroke-dashstyle1",flex:1,value:b},{xtype:"tbfill"},{xtype:"cwn2-btn-geostyler-stroke-dashstyle2",flex:1,value:a}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.GeoStyler.SymbolCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-symbol-combo",fieldLabel:"Symbol",labelWidth:40,queryMode:"local",store:[["circle","circle"],["square","square"],["triangle","triangle"],["star","star"],["cross","cross"],["x","x"]],typeAhead:true,triggerAction:"all",value:"Simple",width:200,constructor:function(a){this.superclass.constructor.call(this);if(a.symbol){this.setValue(a.symbol)}else{this.setValue("circle")}}});Ext.define("CWN2.button.GeoStyler.ExternalGraphicUrl",{extend:"Ext.form.field.TextArea",alias:"widget.cwn2-btn-geostyler-external-graphic-url",fieldLabel:"Url",labelWidth:50,width:400,value:"http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/point-black.png",constructor:function(a){this.superclass.constructor.call(this);if((a.externalGraphic)){this.setValue(a.externalGraphic)}}});Ext.define("CWN2.button.GeoStyler.RuleLegend",{extend:"Ext.Img",alias:"widget.cwn2-btn-geostyler-rule-legend",width:20,height:20,value:"",constructor:function(a){this.superclass.constructor.call(this);if(a.legendUrl){this.setSrc(a.legendUrl)}}});Ext.define("CWN2.button.GeoStyler.ExternalGraphicImg",{extend:"Ext.Img",alias:"widget.cwn2-btn-geostyler-external-graphic-img",fieldLabel:"Img",labelWidth:50,width:20,height:20,value:"http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/point-black.png",constructor:function(a){this.superclass.constructor.call(this);if(a.externalGraphic){this.setSrc(a.externalGraphic)}if(a.size){this.setHeight(parseInt(a.size));this.setWidth(parseInt(a.size))}}});Ext.define("CWN2.button.GeoStyler.GraphicFormatCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-graphic-format-combo",fieldLabel:"Formato",labelWidth:50,queryMode:"local",store:[["image/png","png"],["image/jpeg","jpeg"],["image/gif","gif"],["image/svg+xml","svg"]],typeAhead:true,triggerAction:"all",value:"Simple",width:120,constructor:function(a){this.superclass.constructor.call(this);if(a.graphicFormat){this.setValue(a.graphicFormat)}else{this.setValue("image/png")}}});Ext.define("CWN2.button.GeoStyler.HatchCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-hatch-combo",fieldLabel:"Symbol",labelWidth:40,queryMode:"local",store:[["circle","circle"],["square","square"],["triangle","triagle"],["star","star"],["cross","cross"],["x","x"],["shape://vertline","shape://vertline"],["shape://horline","shape://horline"],["shape://slash","shape://slash"],["shape://backslash","shape://backslash"],["shape://dot","shape://dot"],["shape://plus","shape://plus"],["shape://times","shape://times"]],typeAhead:true,triggerAction:"all",value:"Simple",width:200,constructor:function(a){this.superclass.constructor.call(this);this.setValue(a.symbol)}});Ext.define("CWN2.button.GeoStyler.SymbolSize",{extend:"Ext.form.field.Number",alias:"widget.cwn2-btn-geostyler-symbol-size",fieldLabel:"Size",labelWidth:50,width:100,maxValue:99,minValue:0.5,constructor:function(a){this.superclass.constructor.call(this);this.setValue(parseFloat(a.size))}});Ext.define("CWN2.button.GeoStyler.PointTypeCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-point-type-combo",fieldLabel:"Type",labelWidth:40,queryMode:"local",store:[["WKN","WKN"],["Graphic","Graphic"]],typeAhead:true,triggerAction:"all",value:"Simple",width:200,constructor:function(a){this.superclass.constructor.call(this);this.setValue(a.pointType)}});Ext.define("CWN2.button.GeoStyler.FillTypeCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-geostyler-fill-type-combo",fieldLabel:"Fill",labelWidth:40,queryMode:"local",store:[["None","None"],["Simple","Simple"],["Graphic","Graphic"],["Hatch","Hatch"]],typeAhead:true,triggerAction:"all",value:"Simple",width:200,previousValue:null,constructor:function(a){this.superclass.constructor.call(this);this.setValue(a.fillType);this.previousValue=a.fillType}});Ext.define("CWN2.controller.button.geostyler",{extend:"Ext.app.Controller",views:["CWN2.button.GeoStyler"],refs:[{ref:"button",selector:"cwn2-button-geostyler"},{ref:"win",selector:"cwn2-btn-geostyler-win"},{ref:"panel",selector:"cwn2-btn-geostyler-panel"},{ref:"layerCombo",selector:"cwn2-btn-geostyler-layer-combo"},{ref:"ruleCombo",selector:"cwn2-btn-geostyler-rule-combo"},{ref:"ruleFieldset",selector:"cwn2-btn-geostyler-rule-fieldset"},{ref:"tabPanel",selector:"cwn2-btn-geostyler-tab-panel"},{ref:"labelPanel",selector:"cwn2-btn-geostyler-label-panel"},{ref:"labelFontPanel",selector:"cwn2-btn-geostyler-label-font-panel"},{ref:"labelPlacementPanel",selector:"cwn2-btn-geostyler-label-placement-panel"},{ref:"pointTypeCombo",selector:"cwn2-btn-geostyler-point-type-combo"},{ref:"strokeTypeCombo",selector:"cwn2-btn-geostyler-stroke-type-combo"},{ref:"strokePanel",selector:"cwn2-btn-geostyler-stroke-panel"},{ref:"fillTypeCombo",selector:"cwn2-btn-geostyler-fill-type-combo"},{ref:"fillPanel",selector:"cwn2-btn-geostyler-polygon-fill-panel"},{ref:"pointPanel",selector:"cwn2-btn-geostyler-point-panel"},{ref:"dashLine",selector:"cwn2-btn-geostyler-stroke-dashstyle1"},{ref:"dashSpace",selector:"cwn2-btn-geostyler-stroke-dashstyle2"},{ref:"externalGraphicImg",selector:"cwn2-btn-geostyler-external-graphic-img"},{ref:"cqlFilter",selector:"cwn2-btn-geostyler-cql-filter"},{ref:"ruleLegend",selector:"cwn2-btn-geostyler-rule-legend"},{ref:"changeRuleOrderWin",selector:"cwn2-btn-geostyler-change-rule-order-window"},{ref:"changeRuleOrderPanel",selector:"cwn2-btn-geostyler-change-rule-order-panel"},{ref:"generateRulesWin",selector:"cwn2-btn-geostyler-generate-rules-window"},{ref:"generateRulesColumnCombo",selector:"cwn2-btn-geostyler-generate-rules-columns-combo"}],init:function(a){CWN2.Util.log("CWN2.controller.button.geostyler: init");this.control({"button[action=geostyler-submit]":{click:this.onSubmitButtonClick},"button[action=geostyler-cancel]":{click:this.onCancelButtonClick},"button[action=geostyler-validate-cql]":{click:this.onValidateCQLButtonClick},"button[action=change-rule-order-submit]":{click:this.onChangeRuleOrderSubmitButtonClick},"button[action=change-rule-order-cancel]":{click:this.onChangeRuleOrderCancelButtonClick},"button[action=change-generate-rules-submit]":{click:this.onChangeGenerateRulesSubmitButtonClick},"cwn2-btn-geostyler-layer-combo":{select:this.onLayerSelect},"cwn2-btn-geostyler-rule-combo":{select:this.onRuleSelect},"cwn2-btn-geostyler-rule-title":{change:this.onRuleTitleChange},"cwn2-btn-geostyler-min-scale":{change:this.onMinScaleChange},"cwn2-btn-geostyler-max-scale":{change:this.onMaxScaleChange},"cwn2-btn-geostyler-point-type-combo":{select:this.onPointTypeSelect},"cwn2-btn-geostyler-stroke-type-combo":{select:this.onStrokeTypeSelect},"cwn2-btn-geostyler-fill-type-combo":{select:this.onFillTypeSelect},"cwn2-button-geostyler":{click:this.onClick},"cwn2-btn-geostyler-add-rule":{click:this.onAddRuleClick},"cwn2-btn-geostyler-delete-rule":{click:this.onDeleteRuleClick},"cwn2-btn-geostyler-change-rule-order":{click:this.onChangeRuleOrderClick},"cwn2-btn-geostyler-generate-rules":{click:this.onGenerateRulesClick},"cwn2-btn-geostyler-symbol-combo":{select:this.onSymbolComboSelect},"cwn2-btn-geostyler-hatch-combo":{select:this.onHatchComboSelect},"cwn2-btn-geostyler-symbol-size":{change:this.onSymbolSizeChange},"cwn2-btn-geostyler-fill-color-field":{select:this.onFillColorFieldChange},"cwn2-btn-geostyler-hatch-fill-color-field":{select:this.onHatchFillColorFieldChange},"cwn2-btn-geostyler-stroke-color-field":{select:this.onStrokeColorFieldChange},"cwn2-btn-geostyler-hatch-stroke-color-field":{select:this.onHatchStrokeColorFieldChange},"cwn2-btn-geostyler-stroke-width":{change:this.onStrokeWidthChange},"cwn2-btn-geostyler-hatch-stroke-width":{change:this.onHatchStrokeWidthChange},"cwn2-btn-geostyler-stroke-dashstyle1":{change:this.onStrokeDashStyleChange},"cwn2-btn-geostyler-stroke-dashstyle2":{change:this.onStrokeDashStyleChange},"cwn2-btn-geostyler-stroke-opacity-slider":{change:this.onStrokeOpacitySliderChange},"cwn2-btn-geostyler-hatch-stroke-opacity-slider":{change:this.onHatchStrokeOpacitySliderChange},"cwn2-btn-geostyler-fill-opacity-slider":{change:this.onFillOpacitySliderChange},"cwn2-btn-geostyler-hatch-fill-opacity-slider":{change:this.onHatchFillOpacitySliderChange},"cwn2-btn-geostyler-external-graphic-url":{change:this.onExternalGraphicUrlChange},"cwn2-btn-geostyler-graphic-format-combo":{select:this.onGraphicFormatSelect},"cwn2-btn-geostyler-cql-filter":{change:this.onCQLFilterChange},"cwn2-btn-geostyler-label-font-size":{change:this.onLabelFontSizeChange},"cwn2-btn-geostyler-label-font-family-combo":{select:this.onLabelFontFamilySelect},"cwn2-btn-geostyler-label-font-style-combo":{select:this.onLabelFontStyleSelect},"cwn2-btn-geostyler-label-font-weight-combo":{select:this.onLabelFontWeightSelect},"cwn2-btn-geostyler-label-fill-color-field":{select:this.onLabelFillColorFieldChange},"cwn2-btn-geostyler-label-halo-color-field":{select:this.onLabelHaloColorFieldChange},"cwn2-btn-geostyler-label-halo-radius":{change:this.onLabelHaloRadiusChange},"cwn2-btn-geostyler-label-min-scale":{change:this.onLabelMinScaleChange},"cwn2-btn-geostyler-label-max-scale":{change:this.onLabelMaxScaleChange},"cwn2-btn-geostyler-label-anchor-x":{change:this.onLabelAnchorXChange},"cwn2-btn-geostyler-label-anchor-y":{change:this.onLabelAnchorYChange},"cwn2-btn-geostyler-label-displacement-x":{change:this.onLabelDisplacementXChange},"cwn2-btn-geostyler-label-displacement-y":{change:this.onLabelDisplacementYChange},"cwn2-btn-geostyler-label-line-perpendicular-offset":{change:this.onLabelPerpendicularOffsetChange},"cwn2-btn-geostyler-label-columns-combo":{change:this.onLabelColumnSelect}})},onAddRuleClick:function(g,h,j){var k=this;var f=k.layersConfig[k.selectedLayer];var o=f.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var d=0;var b=o.length;Ext.each(o,function(p,e){if(p.Name!=="LABEL"){d=parseInt(p.Name.replace("R",""))}else{b=e}});var m="R"+parseInt(d+1);var c=null,a=null,n=null,l={Name:m,Title:"Nuova Rule"};switch(f.geomType){case"POLYGON":l.PolygonSymbolizer={Stroke:this.defaultSimpleStrokeStyle};break;case"LINE":l.LineSymbolizer={Stroke:this.defaultSimpleStrokeStyle};break;case"POINT":l.PointSymbolizer={Graphic:this.defaultWKNPointStyle};break}o.splice(b,0,l);k.selectedRule=k.getSelectedRuleIndex(k.selectedLayer,m);this.reloadRuleCombo();this.getRuleCombo().setValue(m);this.reloadTabPanel()},getNumRules:function(b){var a=0;Ext.each(b,function(d,c){if(d.Name!=="LABEL"){a++}});return a},onChangeRuleOrderClick:function(c,f,g){var h=this;var b=h.layersConfig[h.selectedLayer];var j=b.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var a=j.length;var k=h.getNumRules(j);if(k<2){CWN2.Util.msgBox("Attenzione: Non posso riordinare le rule perchè unica");return}var d=this.getChangeRuleOrderWin();if(!d){d=Ext.create("CWN2.button.GeoStyler.ChangeRuleOrder.Window",{rules:j})}this.showHideWin(d,CWN2.app.layout.mapPanel)},onGenerateRulesClick:function(d,h,c){var f=this;var a=f.layersConfig[f.selectedLayer];var b=a.columns;var g=this.getGenerateRulesWin();if(!g){g=Ext.create("CWN2.button.GeoStyler.GenerateRules.Window",{columns:b})}this.showHideWin(g,CWN2.app.layout.mapPanel)},onDeleteRuleClick:function(d,h,c){var f=this;var b=f.layersConfig[f.selectedLayer];var j=b.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var g=j.length;var a=f.getNumRules(j);if(a<2){CWN2.Util.msgBox("Attenzione: Non posso cancellare la rule perchè unica");return}Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(e){if(e==="yes"){j.splice(f.selectedRule,1);f.selectedRule=0;f.reloadRuleCombo();f.reloadTabPanel()}})},onLabelColumnSelect:function(f,b,c){var e=b;var d=this;var a=d.layersConfig[d.selectedLayer];if(e==="&nbsp;"){return}if(e===null){Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(g){if(g==="yes"){d.deleteLabelRule();d.reloadLabelPanel();d.setEditedLayerFlag(a.name)}})}else{if(!a.labelRule){d.createLabelRule();d.reloadLabelPanel()}a.labelRule.TextSymbolizer.Label.PropertyName=e;d.setEditedLayerFlag(a.name)}},reloadLabelPanel:function(){var c=this;var b=c.layersConfig[c.selectedLayer];Ext.suspendLayouts();var a=this.getLabelPanel();a.remove(this.getLabelFontPanel());a.remove(this.getLabelPlacementPanel());a.add({xtype:"cwn2-btn-geostyler-label-font-panel",labelRule:b.labelRule});a.add({xtype:"cwn2-btn-geostyler-label-placement-panel",labelRule:b.labelRule,geomType:b.geomType});Ext.resumeLayouts(true)},createLabelRule:function(){var b=this;var a=b.layersConfig[b.selectedLayer];a.labelRule=Ext.clone(b.defaultLabel);Ext.each(b.layersConfig,function(c){if(c.name===a.name){c.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.push(a.labelRule)}})},deleteLabelRule:function(){var b=this;var a=b.layersConfig[b.selectedLayer];delete a.labelRule;Ext.each(b.layersConfig,function(c){if(c.name===a.name){delete c.labelRule;var d=-1;Ext.each(c.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule,function(f,e){if(f.Name==="LABEL"){d=e}});if(d>-1){c.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule.splice(d,1)}}})},onLabelPerpendicularOffsetChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.LinePlacement){a.labelRule.TextSymbolizer.LabelPlacement.LinePlacement.PerpendicularOffset=e}this.setEditedLayerFlag(a.name)},onLabelDisplacementXChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement){a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement.DisplacementX=e}this.setEditedLayerFlag(a.name)},onLabelDisplacementYChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement){a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.Displacement.DisplacementY=e}this.setEditedLayerFlag(a.name)},onLabelAnchorXChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement){a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint.AnchorPointX=e}this.setEditedLayerFlag(a.name)},onLabelAnchorYChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.LabelPlacement&&a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement){a.labelRule.TextSymbolizer.LabelPlacement.PointPlacement.AnchorPoint.AnchorPointY=e}this.setEditedLayerFlag(a.name)},onLabelMaxScaleChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(e){if(a.labelRule){a.labelRule.MaxScaleDenominator=e}}else{delete a.labelRule.MaxScaleDenominator}this.setEditedLayerFlag(a.name)},onLabelMinScaleChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(e){if(a.labelRule){a.labelRule.MinScaleDenominator=e}}else{delete a.labelRule.MinScaleDenominator}this.setEditedLayerFlag(a.name)},onLabelHaloRadiusChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Halo){a.labelRule.TextSymbolizer.Halo.Radius=e}this.setEditedLayerFlag(a.name)},onLabelHaloColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Halo){setCssParameter(a.labelRule.TextSymbolizer.Halo.Fill,"fill",e)}this.setEditedLayerFlag(a.name)},onLabelFillColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Fill){setCssParameter(a.labelRule.TextSymbolizer.Fill,"fill",e)}this.setEditedLayerFlag(a.name)},onSymbolComboSelect:function(e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var f=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];if(f.PointSymbolizer){f.PointSymbolizer.Graphic.Mark.WellKnownName=b[0].data.field1}if(f.LineSymbolizer){f.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.WellKnownName=b[0].data.field1}this.setEditedLayerFlag(a.name)},onLabelFontWeightSelect:function(f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var e=b[0].data.field1;if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Font){setCssParameter(a.labelRule.TextSymbolizer.Font,"font-weight",e)}this.setEditedLayerFlag(a.name)},onLabelFontStyleSelect:function(f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var e=b[0].data.field1;if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Font){setCssParameter(a.labelRule.TextSymbolizer.Font,"font-style",e)}this.setEditedLayerFlag(a.name)},onLabelFontFamilySelect:function(f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var e=b[0].data.field1;if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Font){setCssParameter(a.labelRule.TextSymbolizer.Font,"font-family",e)}this.setEditedLayerFlag(a.name)},onLabelFontSizeChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];if(a.labelRule&&a.labelRule.TextSymbolizer&&a.labelRule.TextSymbolizer.Font){setCssParameter(a.labelRule.TextSymbolizer.Font,"font-size",e)}this.setEditedLayerFlag(a.name)},onCQLFilterChange:function(g,f,b,d){var e=this;var a=e.layersConfig[e.selectedLayer];var h=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[e.selectedRule];try{if(f){h.Filter=CWN2.Util.transformFilterCQL2json(f)}else{delete h.Filter}}catch(c){}this.setEditedLayerFlag(a.name)},onExternalGraphicUrlChange:function(g,f,c,d){var e=this;var b=e.layersConfig[e.selectedLayer];var h=b.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[e.selectedRule];if(h.PointSymbolizer){h.PointSymbolizer.Graphic.ExternalGraphic.OnlineResource["_xlink:href"]=f}if(h.PolygonSymbolizer){h.PolygonSymbolizer.Fill.GraphicFill.Graphic.ExternalGraphic.OnlineResource["_xlink:href"]=f}var a=this.getExternalGraphicImg();if(a){a.setSrc(f)}this.setEditedLayerFlag(b.name)},onRuleTitleChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];g.Title=e;this.setEditedLayerFlag(a.name)},onMinScaleChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];if(e){g.MinScaleDenominator=e}else{delete g.MinScaleDenominator}this.setEditedLayerFlag(a.name)},onMaxScaleChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];if(e){g.MaxScaleDenominator=e}else{delete g.MaxScaleDenominator}this.setEditedLayerFlag(a.name)},setFillParam:function(e,c){var b=this;var a=b.layersConfig[b.selectedLayer];var d=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[b.selectedRule];if(d.PointSymbolizer){setCssParameter(d.PointSymbolizer.Graphic.Mark.Fill,e,c)}if(d.LineSymbolizer){setCssParameter(d.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.Fill,e,c)}if(d.PolygonSymbolizer){setCssParameter(d.PolygonSymbolizer.Fill,e,c)}this.setEditedLayerFlag(a.name)},onFillColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];this.setFillParam("fill",e);this.setEditedLayerFlag(a.name)},onHatchFillColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];setCssParameter(g.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Fill,"fill",e);this.setEditedLayerFlag(a.name)},onFillOpacitySliderChange:function(e,f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];this.setFillParam("fill-opacity",f/100);this.setEditedLayerFlag(a.name)},onHatchFillOpacitySliderChange:function(e,f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];setCssParameter(g.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Fill,"fill-opacity",f/100);this.setEditedLayerFlag(a.name)},onSymbolComboSelect:function(e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var f=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];if(f.PointSymbolizer){f.PointSymbolizer.Graphic.Mark.WellKnownName=b[0].data.field1}if(f.LineSymbolizer){f.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.WellKnownName=b[0].data.field1}this.setEditedLayerFlag(a.name)},onHatchComboSelect:function(e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var f=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];f.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.WellKnownName=b[0].data.field1;this.setEditedLayerFlag(a.name)},onGraphicFormatSelect:function(e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var f=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];if(f.PointSymbolizer){f.PointSymbolizer.Graphic.ExternalGraphic.Format=b[0].data.field1}if(f.PolygonSymbolizer){f.PolygonSymbolizer.Fill.GraphicFill.Graphic.ExternalGraphic.Format=b[0].data.field1}this.setEditedLayerFlag(a.name)},onSymbolSizeChange:function(g,f,c,d){var e=this;var b=e.layersConfig[e.selectedLayer];var h=b.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[e.selectedRule];if(h.PointSymbolizer){h.PointSymbolizer.Graphic.Size=f}if(h.LineSymbolizer){h.LineSymbolizer.Stroke.GraphicStroke.Graphic.Size=f}if(h.PolygonSymbolizer){}var a=this.getExternalGraphicImg();if(a){a.setWidth(f);a.setHeight(f)}this.setEditedLayerFlag(b.name)},setStrokeParam:function(e,c){var b=this;var a=b.layersConfig[b.selectedLayer];var d=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[b.selectedRule];if(d.PointSymbolizer){setCssParameter(d.PointSymbolizer.Graphic.Mark.Stroke,e,c)}if(d.LineSymbolizer&&d.LineSymbolizer.Stroke){if(d.LineSymbolizer&&d.LineSymbolizer.Stroke.GraphicStroke){setCssParameter(d.LineSymbolizer.Stroke.GraphicStroke.Graphic.Mark.Stroke,e,c)}else{setCssParameter(d.LineSymbolizer.Stroke,e,c)}}if(d.PolygonSymbolizer){setCssParameter(d.PolygonSymbolizer.Stroke,e,c)}},onStrokeColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];this.setStrokeParam("stroke",e);this.setEditedLayerFlag(a.name)},onHatchStrokeColorFieldChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];setCssParameter(g.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Stroke,"stroke",e);this.setEditedLayerFlag(a.name)},onStrokeWidthChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];this.setStrokeParam("stroke-width",e);this.setEditedLayerFlag(a.name)},onHatchStrokeWidthChange:function(f,e,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];setCssParameter(g.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Stroke,"stroke-width",e);this.setEditedLayerFlag(a.name)},onStrokeOpacitySliderChange:function(e,f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];this.setStrokeParam("stroke-opacity",f/100);this.setEditedLayerFlag(a.name)},onHatchStrokeOpacitySliderChange:function(e,f,b,c){var d=this;var a=d.layersConfig[d.selectedLayer];var g=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];setCssParameter(g.PolygonSymbolizer.Fill.GraphicFill.Graphic.Mark.Stroke,"stroke-opacity",f/100);this.setEditedLayerFlag(a.name)},onStrokeDashStyleChange:function(j,c,b,f){var d=this.getDashLine(),h=this.getDashSpace();var g=this;var e=g.layersConfig[g.selectedLayer];var a=e.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[g.selectedRule];if(d&&h){if(d.getValue()&&h.getValue()){var k=d.getValue()+" "+h.getValue();if(a.LineSymbolizer){setCssParameter(a.LineSymbolizer.Stroke,"stroke-dasharray",k)}if(a.PolygonSymbolizer){setCssParameter(a.PolygonSymbolizer.Stroke,"stroke-dasharray",k)}}else{if(a.LineSymbolizer){setCssParameter(a.LineSymbolizer.Stroke,"stroke-dasharray","")}if(a.PolygonSymbolizer){setCssParameter(a.PolygonSymbolizer.Stroke,"stroke-dasharray","")}}}this.setEditedLayerFlag(e.name)},setEditedLayerFlag:function(b){var a=this.layersConfig;Ext.each(a,function(c){if(c.name===b){c.edited=true}})},onClick:function(){var d=this.getWin(),a=this.getButton(),b=this;if(!d){var c=b.buildLayersConfig(a.config);if(!c){CWN2.Util.msgBox("Attenzione: Nessun livello disponibile");return}d=Ext.create("CWN2.button.GeoStyler.Window",{layersConfig:b.layersConfig})}this.showHideWin(d,CWN2.app.layout.mapPanel)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},buildLayersConfig:function(b){var d=this;var c=parseInt(b.options.idMap);var a=CWN2.app.map.layerManager.overlayLayersConfig;d.layersConfig=[];Ext.each(a,function(f){var h=Ext.clone(f);if(h.geomType==="VECTOR"&&h.idMap===c){var k=h.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var j=null;Ext.each(k,function(l){if(l.Name==="LABEL"){j=l;return false}});var g=[{name:"&nbsp;",type:null}];Ext.each(h.dbSchema.columns,function(l){g.push(l)});var e=f.wmsParams.url+"LAYER="+h.name+"&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LEGEND_OPTIONS=forceLabels:off";d.layersConfig.push({name:h.name,label:h.legend.label,legendUrl:e,id:h.id,sld:h.sld,labelRule:j,columns:g,edited:false,geomType:h.geomSubType})}});if(d.layersConfig.length>0){d.layersConfig.reverse();d.selectedLayer=0;d.selectedRule=0;return true}else{return false}},onLayerSelect:function(d,a,b){var c=this;c.selectedLayer=c.getSelectedLayerIndex(a[0].data.name);c.selectedRule=0;this.reloadRuleCombo();this.reloadTabPanel()},getSelectedLayerIndex:function(a){var c=this,b=0;Ext.each(c.layersConfig,function(d,e){if(d.name===a){b=e;return false}});return b},getSelectedRuleIndex:function(a,d){var c=this,b=0;var e=c.layersConfig[a].sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;Ext.each(e,function(f,g){if(f.Name===d){b=g;return false}});return b},onRuleSelect:function(d,a,b){var c=this;c.selectedRule=c.getSelectedRuleIndex(c.selectedLayer,a[0].data.Name);this.getRuleLegend().setSrc(a[0].data.legendUrl);this.reloadTabPanel()},reloadRuleCombo:function(){var c=this;Ext.suspendLayouts();var b=c.getPanel();b.remove(c.getRuleFieldset());b.add({xtype:"cwn2-btn-geostyler-rule-fieldset",layer:c.layersConfig[c.selectedLayer]});var a=c.getRuleCombo();a.setValue(a.getStore().getAt(c.selectedRule).data.Name);Ext.resumeLayouts(true)},reloadTabPanel:function(){var d=this;Ext.suspendLayouts();var c=this.getPanel();var f=this.getTabPanel();var b=d.layersConfig[d.selectedLayer];var e=b.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[d.selectedRule];var a=(f.items)?f.items.indexOf(f.getActiveTab()):0;c.remove(f);c.add({xtype:"cwn2-btn-geostyler-tab-panel",rule:e,geomType:b.geomType,labelRule:b.labelRule,columns:b.columns,activeTab:a});Ext.resumeLayouts(true)},onStrokeTypeSelect:function(c,e,j){var k=this,d=e[0].data.field1,g;var f=k.layersConfig[k.selectedLayer];var b=f.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[k.selectedRule];if(k.getFillTypeCombo()){var h=k.getFillTypeCombo().getValue();if(h==="None"&&d==="None"){CWN2.Util.msgBox("Attenzione: Stroke e Fill non possono essere entrambi non impostati");c.setValue(c.previousValue);return}}c.previousValue=d;Ext.suspendLayouts();var a=this.getStrokePanel();a.remove(a.items.items[1]);var m=b.LineSymbolizer||b.PolygonSymbolizer;if(d==="None"){if(b.PolygonSymbolizer&&b.PolygonSymbolizer.Stroke){var l=b.PolygonSymbolizer.Fill;b.PolygonSymbolizer={Fill:l}}}if(d==="Simple"){if((!m.Stroke)||(m.Stroke.GraphicStroke)){m.Stroke=Ext.clone(this.defaultSimpleStrokeStyle)}g={xtype:"cwn2-btn-geostyler-simple-stroke-panel",rule:b};a.add(g)}if(d==="WKN"){if((!m.Stroke)||(!m.Stroke.GraphicStroke)){m.Stroke=Ext.clone(this.defaultWKNStrokeStyle)}g={xtype:"cwn2-btn-geostyler-wkn-stroke-panel",rule:b};a.add(g)}Ext.resumeLayouts(true)},onFillTypeSelect:function(d,f,j){var k=this,h=f[0].data.field1,e;var g=k.layersConfig[k.selectedLayer];var b=g.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[k.selectedRule];var c=k.getStrokeTypeCombo().getValue();if(h==="None"&&c==="None"){CWN2.Util.msgBox("Attenzione: Stroke e Fill non possono essere entrambi non impostati");d.setValue(d.previousValue);return}d.previousValue=h;Ext.suspendLayouts();var a=this.getFillPanel();a.remove(a.items.items[1]);var m=b.PolygonSymbolizer;if(h==="None"){if(m&&m.Fill){var l=m.Stroke;m={Stroke:l}}}if(h==="Simple"){if((!m.Fill)||(m.Fill.GraphicFill)){m.Fill=Ext.clone(this.defaultSimpleFillStyle)}e={xtype:"cwn2-btn-geostyler-simple-fill-panel",rule:b};a.add(e)}if(h==="Graphic"){if((!m.Fill)||(!m.Fill.GraphicFill)||(!m.Fill.GraphicFill.Graphic.ExternalGraphic)){m.Fill=Ext.clone(this.defaultGraphicFillStyle)}e={xtype:"cwn2-btn-geostyler-graphic-fill-panel",rule:b};a.add(e)}if(h==="Hatch"){if((!m.Fill)||(!m.Fill.GraphicFill)||(!m.Fill.GraphicFill.Graphic.Mark)){m.Fill=Ext.clone(this.defaultHatchFillStyle)}e={xtype:"cwn2-btn-geostyler-hatch-fill-panel",rule:b};a.add(e)}Ext.resumeLayouts(true)},onPointTypeSelect:function(d,e,g){var h=this,c=e[0].data.field1,j;var f=h.layersConfig[h.selectedLayer];var b=f.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[h.selectedRule];Ext.suspendLayouts();var a=this.getPointPanel();a.remove(a.items.items[1]);if(c==="WKN"){if(b.PointSymbolizer.Graphic.ExternalGraphic){b.PointSymbolizer.Graphic=Ext.clone(this.defaultWKNPointStyle)}j={xtype:"cwn2-btn-geostyler-wkn-point-panel",rule:b}}if(c==="Graphic"){if(b.PointSymbolizer.Graphic.Mark){b.PointSymbolizer.Graphic=Ext.clone(this.defaultGraphicPointStyle)}j={xtype:"cwn2-btn-geostyler-graphic-point-panel",rule:b}}a.add(j);Ext.resumeLayouts(true)},defaultLabel:{Name:"LABEL",Title:"",TextSymbolizer:{Label:{PropertyName:"NUMERO_PRATICA"},Font:{CssParameter:[{_name:"font-family",__text:"Verdana"},{_name:"font-size",__text:8},{_name:"font-style",__text:"normal"},{_name:"font-weight",__text:"normal"}]},LabelPlacement:{PointPlacement:{AnchorPoint:{AnchorPointX:0,AnchorPointY:0}}},Halo:{Radius:2,Fill:{CssParameter:[{_name:"fill",__text:"#F5FFFA"}]}},Fill:{CssParameter:[{_name:"fill",__text:"#000000"}]},VendorOption:{_name:"conflictResolution",__text:"false"}}},defaultSimpleFillStyle:{CssParameter:[{_name:"fill",__text:"#FFFFFF"},{_name:"fill-opacity",__text:"1"}]},defaultGraphicFillStyle:{GraphicFill:{Graphic:{ExternalGraphic:{OnlineResource:{"_xmlns:xlink":"http://www.w3.org/1999/xlink","_xlink:type":"simple","_xlink:href":"http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/point-black.png"},Format:"image/png"},Size:"6"}}},defaultHatchFillStyle:{GraphicFill:{Graphic:{Mark:{WellKnownName:"shape://slash",Stroke:{CssParameter:[{_name:"stroke",__text:"#000000"}]}},Size:"8"}}},defaultSimpleStrokeStyle:{CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-opacity",__text:"1"},{_name:"stroke-width",__text:"1"}]},defaultWKNStrokeStyle:{GraphicStroke:{Graphic:{Mark:{WellKnownName:"circle",Fill:{CssParameter:[{_name:"fill",__text:"#FF0000"}]},Stroke:{CssParameter:[{_name:"stroke",__text:"#000000"}]}},Size:"6"}}},defaultWKNPointStyle:{Mark:{WellKnownName:"circle",Fill:{CssParameter:[{_name:"fill",__text:"#FF0000"},{_name:"fill-opacity",__text:"1"}]},Stroke:{CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-opacity",__text:"1"},{_name:"stroke-width",__text:"1"}]}},Size:"10"},defaultGraphicPointStyle:{ExternalGraphic:{OnlineResource:{"_xmlns:xlink":"http://www.w3.org/1999/xlink","_xlink:type":"simple","_xlink:href":"http://geoportale.regione.liguria.it/geoservices/geoserver_sld/sld/img/point-black.png"},Format:"image/png"},Size:"10"},onCancelButtonClick:function(){var a=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(b){if(b==="yes"){a.buildLayersConfig(a.getButton().config);var c=a.getWin();c.destroy();c=Ext.create("CWN2.button.GeoStyler.Window",{layersConfig:a.layersConfig});a.showHideWin(c,CWN2.app.layout.mapPanel)}})},onValidateCQLButtonClick:function(){var c=this.getCqlFilter().getValue();if(c){try{var b=CWN2.Util.transformFilterCQL2json(c);CWN2.Util.msgBox("Parsing Corretto")}catch(a){CWN2.Util.msgBox("Errore parsing del filtro.<br> "+a)}}},onSubmitButtonClick:function(b,d,a){var c=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(g){if(g==="yes"){Ext.each(c.layersConfig,function(j){if(j.edited){c.checkStrokeWidth(j);if(c.checkScale(j)&&c.checkExternalGraphic(j)){var n=Ext.clone(j);var l=CWN2.app.map.layerManager.getLayerConfigByName(n.name);l.sld=n.sld;var k=GeoStyler.app.x2js.json2xml_str(n.sld);Ext.Ajax.request({url:"/geoservices/REST/geoserver/geoserver_sld?id="+n.id,headers:{"Content-Type":"application/xml; charset=UTF-8"},xmlData:k,success:function(o){if(o.responseText.substring(0,2)==="OK"){j.edited=false}var p=CWN2.app.map.getLayerByName(j.name);p.redraw(true);var q=document.getElementById("legend_img_"+j.name);q.src=l.legend.icon+"?"+new Date().getTime()}});var m=n.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var h=c.getNumRules(m);CWN2.Util.ajaxRequest({type:"JSON",url:"/geoservices/REST/geoserver/set_flag_multiclasse?id="+n.id+"&num_rules="+h,callBack:function(o){console.log(o.message)}})}}});c.reloadRuleCombo();c.reloadTabPanel();var f=c.layersConfig[c.selectedLayer];var e=f.legendUrl+"&RULE="+f.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[c.selectedRule].Name+"&dc="+new Date().getTime();c.getRuleLegend().setSrc(e)}})},checkScale:function(a){var c=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var b=true;Ext.each(c,function(d){if(d.MinScaleDenominator&&d.MaxScaleDenominator&&d.MinScaleDenominator>=d.MaxScaleDenominator){CWN2.Util.msgBox("Attenzione: la Scala Min. deve essere minore di Scala Max. <br>Layer: "+a.name+" - "+a.label);b=false;return false}});return b},checkStrokeWidth:function(a){var b=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;Ext.each(b,function(c){if(c.PointSymbolizer&&c.PointSymbolizer.Graphic.Mark&&c.PointSymbolizer.Graphic.Mark.Stroke){if(getCssParameter(c.PointSymbolizer.Graphic.Mark.Stroke,"stroke-width")===0){c.PointSymbolizer.Graphic.Mark={WellKnownName:c.PointSymbolizer.Graphic.Mark.WellKnownName,Fill:c.PointSymbolizer.Graphic.Mark.Fill}}}})},checkExternalGraphic:function(a){var c=a.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule;var b=true;var d=null;Ext.each(c,function(e){if(e.PointSymbolizer&&e.PointSymbolizer.Graphic.ExternalGraphic){d=e.PointSymbolizer.Graphic.ExternalGraphic.OnlineResource["_xlink:href"]}if(e.PolygonSymbolizer&&e.PolygonSymbolizer.Fill&&e.PolygonSymbolizer.Fill.GraphicFill&&e.PolygonSymbolizer.Fill.GraphicFill.Graphic&&e.PolygonSymbolizer.Fill.GraphicFill.Graphic.ExternalGraphic){d=e.PolygonSymbolizer.Fill.GraphicFill.Graphic.ExternalGraphic.OnlineResource["_xlink:href"]}if(d){var f=document.createElement("img");f.onerror=function(){CWN2.Util.msgBox("Attenzione: l'immagine "+d+" non esiste!");b=false;return false};f.src=d}});return b},checkFilter:function(d,a){if(d.Filter){try{var c=CWN2.Util.transformFilterJson2CQL(d.Filter)}catch(b){CWN2.Util.msgBox("Attenzione: Errore Parsing del filtro. <br>Layer: "+a.name+" - "+a.label+"<br>Rule: "+d.Name+" - "+d.Title+"<br>Errore: "+b)}}},onChangeGenerateRulesSubmitButtonClick:function(b,d,a){var c=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(f){if(f==="yes"){var g=c.getGenerateRulesColumnCombo().getValue(),e=c.layersConfig[c.selectedLayer];if(g){CWN2.Util.ajaxRequest({type:"JSONP",url:"/geoservices/REST/config/query_layer_valuelist/"+e.name.replace("L","")+"?column="+g,callBack:function(j){if(j&&!j.success){CWN2.Util.msgBox("Attenzione: - "+j.message);return}(j.data&&j.data.length>0)?c.generateRules(g,j.data):CWN2.Util.msgBox("Nessun oggetto trovato")}})}else{CWN2.Util.msgBox("Attenzione: Selezionare una colonna");return}var h=c.getGenerateRulesWin();h.destroy()}})},generateRules:function(d,b){var e=this,c=e.layersConfig[e.selectedLayer],f=[];Ext.each(b,function(j,h){if(j.value){var k={};k.Name="R"+h;k.Title=d+" = "+j.value;k.Filter=CWN2.Util.transformFilterCQL2json(d+" = '"+j.value+"'");var l=(h<9)?h:h-9;var g=CWN2.Globals.COLOR_SCALES.Random["9"][l];switch(c.geomType){case"POLYGON":k.PolygonSymbolizer={Stroke:e.defaultSimpleStrokeStyle,Fill:{CssParameter:[{_name:"fill",__text:g},{_name:"fill-opacity",__text:"1"}]}};break;case"LINE":k.LineSymbolizer={Stroke:{CssParameter:[{_name:"stroke",__text:g},{_name:"stroke-opacity",__text:"1"},{_name:"stroke-width",__text:"1"}]}};break;case"POINT":k.PointSymbolizer={Graphic:{Mark:{WellKnownName:"circle",Fill:{CssParameter:[{_name:"fill",__text:g},{_name:"fill-opacity",__text:"1"}]}},Size:"10"}};break}f.push(k)}});c.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule=f;e.reloadRuleCombo();e.reloadTabPanel();var a=c.legendUrl+"&RULE="+c.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[e.selectedRule].Name+"&dc="+new Date().getTime();e.getRuleLegend().setSrc(a)},onChangeRuleOrderSubmitButtonClick:function(b,d,a){var c=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(h){if(h==="yes"){var g=c.layersConfig[c.selectedLayer],k=g.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule,f=c.getChangeRuleOrderPanel().store.data.items,l=[];Ext.each(f,function(m){Ext.each(k,function(n){if(n.Name===m.data.Name){l.push(n)}})});Ext.each(k,function(m){if(m.Name==="LABEL"){l.push(m)}});g.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule=l;c.reloadRuleCombo();c.reloadTabPanel();var e=g.legendUrl+"&RULE="+g.sld.StyledLayerDescriptor.NamedLayer.UserStyle.FeatureTypeStyle.Rule[c.selectedRule].Name+"&dc="+new Date().getTime();c.getRuleLegend().setSrc(e);var j=c.getChangeRuleOrderWin();j.destroy()}})},onChangeRuleOrderCancelButtonClick:function(){var a=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(b){if(b==="yes"){var c=a.getChangeRuleOrderWin();c.destroy()}})},layersConfig:[],selectedLayer:null,selectedRule:null});function getCssParameter(a,c){var d=(a)?a.CssParameter:null,b=null;Ext.each(d,function(e){if(e._name===c){b=e.__text;return false}});return b}function setCssParameter(a,b,d){if(!a){return}var c=a.CssParameter,e=false;Ext.each(c,function(f){if(f._name===b){f.__text=d;e=true;return false}});if(!e){if(!a.CssParameter){a.CssParameter=[]}a.CssParameter.push({_name:b,__text:d})}}function setDefaultMark(d,a){if(!d.Fill){d.Fill={CssParameter:[{_name:"fill",__text:"#000000"}]};if(a==="POINT"){d.Fill.CssParameter.push({_name:"fill-opacity",__text:"1"})}}if(typeof d.Stroke==="undefined"){if(a==="POINT"){var b=getCssParameter(d.Fill,"fill");d.Stroke={CssParameter:[{_name:"stroke",__text:b},{_name:"stroke-width",__text:"0"},{_name:"stroke-opacity",__text:"1"}]}}else{d.Stroke={CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-width",__text:"1"}]}}}if(d.Stroke===""){if(a==="POINT"){d.Stroke={CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-width",__text:"1"},{_name:"stroke-opacity",__text:"1"}]}}else{d.Stroke={CssParameter:[{_name:"stroke",__text:"#000000"},{_name:"stroke-width",__text:"1"}]}}}var c=getCssParameter(d.Stroke,"stroke-width");if(d.Stroke&&!c&&c!==0){setCssParameter(d.Stroke,"stroke-width","1")}}Ext.define("CWN2.button.GeocoderCombo",{alias:"widget.cwn2-combo-geocoder",constructor:function(b){var a=b.options||{};return Ext.create("CWN2.GeocoderComboBox",{id:"combo-geocoder",map:CWN2.app.map,hilite:a.hilite,service:"google",width:a.width||200})}});Ext.define("CWN2.button.InfoWms",{extend:"Ext.button.Button",alias:"widget.cwn2-button-infowms",constructor:function(c){var d=c.options||{},a=CWN2.app.map,b="infowms",j=this,e="_wmsInfo";if(!d.disableHilite){this.wmsSldHiliter=new CWN2.WmsSldHiliter(a,e)}function g(o){if(o){var l=o.length,m={},n;m.test=function(p){for(n=0;n<l;n++){if(p===o[n]){return true}}return false};return a.getLayersByName(m)}else{return null}}function h(){var n=a.layers,m=[];for(var l=0;l<n.length;l++){if(n[l].config&&n[l].config.type==="WMS"&&n[l].config.queryable){m.push(n[l])}}return m}var k=d.vendorParams||{};if(d.radius){k.radius=d.radius}var f=new OpenLayers.Control.WMSGetFeatureInfo({id:"infoWmsControl",layers:(d.layers)?g(d.layers.split(",")):h(),queryVisible:true,drillDown:true,maxFeatures:d.maxFeatures||CWN2.Globals.INFO_WMS_MAX_FEATURES,infoFormat:"application/vnd.ogc.gml",output:"object",eventListeners:{getfeatureinfo:function(l){j.fireEvent("getfeatureinfo",l)}}});a.addControl(f);this.options=d;this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:b,tooltip:CWN2.I18n.get("Info"),iconCls:(d&&d.iconCls)?d.iconCls:b,text:(d&&d.text)?d.text:"",width:(d&&d.width)?d.width:26,enableToggle:true,control:f,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.InfoWms.featureList.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-infowms-featurelist-win",title:CWN2.I18n.get("Risultato Interrogazione"),height:350,width:480,layout:"fit",resizable:false,constructor:function(a){this.items=a.items;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.featureList.GridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-infowms-featurelist-grid",header:false,frame:true,width:440,height:300,iconCls:"icon-grid",columns:[{header:"Livello",id:"layerLabel",sortable:true,dataIndex:"layerLabel",renderer:function(d,b,a){var c=a.data.layerLabel;var e="cursor:pointer; text-decoration:underline";return"<div style='"+e+"'>"+c+" </div>"},width:240},{header:"Feature",id:"label",sortable:true,dataIndex:"label",renderer:function(d,b,a){var c=a.data.label;var e="cursor:pointer; text-decoration:underline;font-weight: bold";return"<div style='"+e+"'>"+c+" </div>"},width:200}],constructor:function(a){this.store=Ext.create("CWN2.button.InfoWms.featureList.Store",{data:a.data});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.featureList.Store",{extend:"Ext.data.Store",fields:[{name:"featureId",mapping:"featureId"},{name:"layerLabel",mapping:"layerLabel"},{name:"layerName",mapping:"layerName"},{name:"label",mapping:"label"},{name:"attributes",mapping:"attributes"},{name:"doc",mapping:"doc"},{name:"feature",mapping:"feature"}],sortInfo:{field:"layerName",direction:"ASC"},constructor:function(a){this.data=a.data;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.baseInfo.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-infowms-baseinfo-win",height:400,width:360,layout:"fit",resizable:false,constructor:function(a){this.title=a.title;this.items=a.items;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.baseInfo.GridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-infowms-baseinfo-grid",frame:true,width:300,header:false,height:300,hideHeaders:true,iconCls:"icon-grid",columns:[{header:"Campo",id:"infoLabelAttr",dataIndex:"infoLabelAttr",renderer:function(a){return'<div style="white-space:normal !important;"><b>'+a+"</b></div>"},width:150},{header:"Valore",id:"fieldValue",dataIndex:"fieldValue",renderer:function(a){return'<div style="white-space:normal !important;">'+a+"</div>"},width:150}],constructor:function(a){this.id=a.id;this.store=Ext.create("CWN2.button.InfoWms.baseInfo.Store",{data:a.data});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.baseInfo.Store",{extend:"Ext.data.Store",fields:[{name:"infoLabelAttr",mapping:"infoLabelAttr"},{name:"fieldValue",mapping:"fieldValue"}],constructor:function(a){this.data=a.data;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.InfoWms.html.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-infowms-html-win",title:"Info",resizable:false,autoScroll:true,constructor:function(a){this.height=a.height;this.width=a.width;this.items=a.items;this.superclass.constructor.call(this)}});Ext.define("CWN2.controller.button.infowms",{extend:"Ext.app.Controller",views:["CWN2.button.InfoWms"],refs:[{ref:"button",selector:"cwn2-button-infowms"},{ref:"featureListWin",selector:"cwn2-infowms-featurelist-win"},{ref:"featureListGrid",selector:"cwn2-infowms-featurelist-grid"},{ref:"baseInfoWin",selector:"cwn2-infowms-baseinfo-win"},{ref:"htmlWin",selector:"cwn2-infowms-html-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.infowms: init");this.control({"cwn2-button-infowms":{toggle:this.onButtonPress,getfeatureinfo:this.onGetFeatureInfo},"cwn2-infowms-featurelist-win":{destroy:this.onWinDestroy},"cwn2-infowms-baseinfo-win":{destroy:this.onWinDestroy},"cwn2-infowms-html-win":{destroy:this.onWinDestroy},"#infoWmsMediaWin":{destroy:this.onWinDestroy},"cwn2-infowms-featurelist-grid":{select:this.onFeatureListGridSelect}})},onGetFeatureInfo:function(a){this.showFeatureList(a)},onWinDestroy:function(){var a=this.getButton().wmsSldHiliter;if(a){a.cleanHiliteLayer()}},onFeatureListGridSelect:function(a,b){this.showFeatureInfo(b);this.getFeatureListGrid().getSelectionModel().clearSelections()},onButtonPress:function(){},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},showFeatureList:function(a){var n=this,l=this.getButton();var j=a.object.findLayers(),c=o(j),d=a.features,k=f(d,c,j);if(k.length===0){return}if(this.getFeatureListWin()){this.getFeatureListWin().destroy()}Ext.create("CWN2.button.InfoWms.featureList.Window",{items:[Ext.create("CWN2.button.InfoWms.featureList.GridPanel",{data:k})]}).show().alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[10,10]);if(k.length===1){this.getFeatureListGrid().getSelectionModel().select(0);if(l.options.hideFeatureList){this.getFeatureListWin().close()}}function o(s){var q,t={},p=s.length;for(var r=0;r<p;r++){if(s[r].legend&&s[r].legend.label){q=s[r].legend.label}else{q=s[r].name}t[s[r].name]=q}return t}function f(q,p,w){var v=0,x=[],r=null,z=null,t=q.length,s=null;for(var u=0;u<t;u++){r=q[u].features;s=r.length;for(var y=0;y<s;y++){z=e(v,r[y],q[u],p,w);x.push(z);v++}}return x}function e(s,x,w,q,t){var v=(x.gml&&x.gml.featureType)?x.gml.featureType:x.type,u=m(v,t),r=x.attributes,p={};p.featureId=s;p.layerLabel=q[u];p.layerName=u;p.attributes=r;p.feature=x;p.url=w.url;p.label=b(u,r);return p}function m(r,s){var p=s.length;for(var q=0;q<p;q++){if(!s[q].params.LAYERS){return r}if(s[q].params.LAYERS.indexOf(r)!==-1){return s[q].name}}}function b(r,p){var q,s;q=g(r,"infoLabelAttr");s=g(r,"infoIdAttr");if(q&&p[q]){return p[q]}else{if(s&&p[s]){return p[s]}else{return p[h(p)]}}}function g(q,s){try{var p=CWN2.app.map.layerManager.getLayerConfigByName(q);if(!p){throw {name:"BadConfiguration",message:"CWN2.button.InfoWms: layer non esistente",level:1}}if(p.infoOptions&&p.infoOptions[s]){return p.infoOptions[s]}else{return null}}catch(r){CWN2.Util.handleException(r);return null}}function h(p){for(var q in p){if(p.hasOwnProperty(q)&&typeof(q)!=="function"){return q}}return null}},showFeatureInfo:function(c){var d=c.data,g=d.layerName,m=CWN2.app.map.layerManager.getLayerConfigByName(g),j=this,b=j.getButton().options,l=m.infoOptions,a={};if(!m){return}h();if(j.getButton().wmsSldHiliter){e()}(l&&l.infoUrl)?f(l,d):k(l,d);function h(){if(m.infoOptions&&!m.infoOptions.infoIdAttr){CWN2.Util.log("CWN2.button.InfoWms - parametro di configurazione del layer non impostato: infoIdAttr ",0)}if(!m.geomSubType){CWN2.Util.log("CWN2.button.InfoWms - parametro di configurazione del layer non impostato: geomSubType ",0)}}function k(v,r){var q=r.attributes,o=[],p=r.layerLabel,u=v?v.fieldMapping:null,w,n;for(var t in q){if(q.hasOwnProperty(t)){w=u?u[t]:t;n=q[t]||"";o.push({infoLabelAttr:w,fieldValue:n})}}if(j.getBaseInfoWin()){j.getBaseInfoWin().destroy()}var s=Ext.create("CWN2.button.InfoWms.baseInfo.Window",{title:r.layerLabel,items:[Ext.create("CWN2.button.InfoWms.baseInfo.GridPanel",{data:o})]});s.show().alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[500,10])}function f(n,t){var q=OpenLayers.String.format(n.infoUrl,t.attributes);if(CWN2.app.configuration.qpgRequest){var s=CWN2.app.configuration.qpgRequest.tematismi;Ext.each(s,function(v){if(t.layerName===v.olLayer.name&&v.separatoreDecimale===","){numeral.language("it");var u=parseFloat(t.attributes.VALORE);if(!isNaN(u)){t.attributes.VALORE=numeral(u).format("0000.00")}}})}if((q.substr(q.length-4)===".xsl")||(q.substr(q.length-5)===".xslt")){o(n,t)}else{if(!n.infoTarget||n.infoTarget==="panel"){r(q,n)}else{p(q,n)}}function o(A,w){var y="/geoservices/REST/config/xsl_info_service?";var C=x(w);var z={xslUrl:A.infoUrl,ambiente:CWN2.Globals.AMBIENTE,idLayer:w.layerName.replace("L",""),featureAttributes:w.attributes};CWN2.Util.ajaxRequest({type:"XML",url:y,jsonData:z,callBack:function(G){try{var F=Ext.DomQuery.select("td",G);Ext.each(F,function(H){if(H.id==="Titolo"){H.textContent=w.layerLabel;return false}Ext.each(H.attributes,function(I){if(I.text==="Titolo"){H.text=w.layerLabel;return false}})});var D=B(C,G);D=D.replace(new RegExp("%0A","g"),"").replace(new RegExp("%09","g"),"").replace(new RegExp("%20","g"),"");if(!A.infoTarget||A.infoTarget==="panel"){u(D,A)}else{v(D,A)}}catch(E){CWN2.Util.handleException(E)}}});function x(O){try{var N='<?xml version="1.0" encoding="ISO-8859-1"?><msGMLOutput xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></msGMLOutput>',M=CWN2.Util.parseXML(N),G=O.layerName+"_layer",H=M.createElement(G),L=O.layerName+"_feature",D=M.createElement(L),F=O.attributes;for(var J in F){if(F.hasOwnProperty(J)){var K=null;if(F[J]){K=M.createTextNode(F[J])}else{K=M.createTextNode("")}var I=M.createElement(J);I.appendChild(K);D.appendChild(I)}}H.appendChild(D);M.documentElement.appendChild(H);return M}catch(E){throw {name:"gmlTransformation",message:"CWN2.button.infoWms.buildGml: errore costruzione xmlDoc gml - "+E.message,level:1}}}function B(G,H){try{if(window.XSLTProcessor){var D=new XSLTProcessor();D.importStylesheet(H);var F=D.transformToDocument(G);return(new XMLSerializer()).serializeToString(F)}else{return G.transformNode(H)}}catch(E){throw {name:"gmlTransformation",message:"CWN2.button.infoWms.xslTransform: errore trasformazione xslt - "+E.message,level:1}}}function u(F,E){var G=E.infoWidth||400,D=E.infoHeight||500;if(j.getHtmlWin()){j.getHtmlWin().destroy()}var H=Ext.create("CWN2.button.InfoWms.html.Window",{height:D,width:G,items:[{xtype:"panel",manageHeight:false,border:false,title:"",html:F}]}).show().alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[20,20])}function v(H,E){var G=E.infoWidth||400,D=E.infoHeight||500,F=window.open("",null,"status=yes, toolbar=yes, menubar=no, width="+G+", height="+D+", resizable=yes, scrollbars=yes");F.document.open();F.document.write(H);F.document.close();F.focus()}}function r(v,u){var w=new CWN2.IframeWindow({url:v,width:u.infoWidth,height:u.infoHeight,id:"infoWmsMediaWin"}).alignTo(CWN2.app.layout.mapPanel.body,"tl-tl",[10,10])}function p(x,v){var y=v.infoWidth||400,u=v.infoHeight||500,w=window.open(x,v.infoTarget,"status=yes, toolbar=yes, menubar=no, width="+y+", height="+u+", resizable=yes, scrollbars=yes");w.focus()}}function e(){if(!m.infoOptions){return null}var o=m.infoOptions.infoIdAttr;var n=[];if(d.feature&&d.feature.attributes){n.push(d.feature.attributes[o])}if(typeof n[0]==="undefined"){CWN2.Util.log("Parametro layerConfig.infoOptions.infoIdAttr non impostato",0);return}var p=null,q=null;if(b&&b.zoomToSelected){p=d.feature.bounds}if(b&&b.zoomLevel){q=b.zoomLevel}return j.getButton().wmsSldHiliter.hiliteFeature({layers:[m.name],fields:o,values:n,bounds:p,zoomLevel:q})}}});Ext.define("CWN2.button.LoadLayers",{extend:"Ext.button.Button",alias:"widget.cwn2-button-loadlayers",constructor:function(b){var a=b.options,c="loadlayers";this.config=b;this.superclass.constructor.call(this,{tooltip:CWN2.I18n.get("Aggiunta Livelli"),iconCls:(a&&a.iconCls)?a.iconCls:c,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false,id:c})}});Ext.define("CWN2.button.LoadLayers.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-loadlayers-win",title:CWN2.I18n.get("Aggiunta Livelli"),height:500,width:700,resizable:true,layout:"fit",closeAction:"hide",buttons:[{text:CWN2.I18n.get("Aggiungi"),action:"loadlayers-submit"},{text:CWN2.I18n.get("Annulla"),action:"loadlayers-cancel"}],constructor:function(a){this.items=Ext.create("CWN2.button.LoadLayers.TabPanel",{items:a.items});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.LoadLayers.TabPanel",{extend:"Ext.tab.Panel",alias:"widget.cwn2-loadlayers-tabpanel",activeTab:0,bodyBorder:false,deferredRender:false,layoutOnTabChange:false,border:false,flex:1,plain:true,constructor:function(a){this.items=a.items;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.LoadLayers.TreePanel",{extend:"Ext.tree.Panel",alias:"widget.cwn2-loadlayers-tree",layout:"anchor",rootVisible:false,animate:true,autoScroll:true,nodeType:"async",containerScroll:true,border:false,bodyStyle:"padding:10px",bodyBorder:true,height:530,useArrows:true,multiSelect:true,constructor:function(a){this.title=a.title;this.store=a.store;this.type=a.type;this.panelConfig=a.panelConfig;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.LoadLayers.WmsCapabilitiesUrl",{extend:"Ext.form.field.Text",alias:"widget.cwn2-btn-loadlayers-wmsurl-field",allowBlank:false,value:"",width:500});Ext.define("CWN2.button.LoadLayers.WmsPanel",{extend:"Ext.form.Panel",alias:"widget.cwn2-loadlayers-wmspanel",height:530,title:"Servizi WMS",bodyStyle:"padding:5px 5px 0",constructor:function(a){this.type="wms";this.panelConfig=a.panelConfig;this.items=[{xtype:"fieldcontainer",border:false,width:600,flex:1,layout:"hbox",items:[{xtype:"cwn2-btn-loadlayers-wmsurl-field",fieldLabel:"URL Capabilities"},{xtype:"tbfill"},{xtype:"button",text:"Lista Layer",handler:function(){var b=Ext.data.StoreManager.lookup("wmscapsStore");var c=Ext.ComponentQuery.query("cwn2-btn-loadlayers-wmsurl-field")[0].value;if(c.indexOf("?")===-1){c+="?"}if(c.toUpperCase().indexOf("REQUEST=GETCAPABILITIES")===-1){c+="&REQUEST=GETCAPABILITIES"}if(c.toUpperCase().indexOf("SERVICE=WMS")===-1){c+="&SERVICE=WMS"}b.getProxy().url=CWN2.Globals.proxy+c;b.load()}}]},Ext.create("CWN2.button.LoadLayers.WmsGrid",{panelConfig:a.panelConfig})];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.LoadLayers.WmsGrid",{extend:"Ext.grid.Panel",alias:"widget.cwn2-loadlayers-wmsgrid",height:380,multiSelect:true,columns:[{header:"Titolo",dataIndex:"title",sortable:true},{id:"description",header:"Descrizione",dataIndex:"abstract",flex:1}],constructor:function(a){this.store=Ext.create("GeoExt.data.WmsCapabilitiesStore",{storeId:"wmscapsStore",url:null,autoLoad:false});this.type="wms";this.superclass.constructor.call(this)}});Ext.define("CWN2.button.LoadLayers.KmlPanel",{extend:"Ext.form.Panel",alias:"widget.cwn2-loadlayers-kmlpanel",height:530,title:"File KML/GPX",bodyStyle:"padding:5px 5px 0",constructor:function(a){this.type="kml";this.panelConfig=a.panelConfig;this.items=[{xtype:"displayfield",name:"home_score",value:"<br><b>Selezionare un file da caricare oppure indicare la URL di un file KML/KMZ o GPX (anche zippato)</b><br><br>"},{xtype:"filefield",emptyText:"Seleziona un file kml/kmz o gpx",width:500,regex:(/.(kml|kmz|gpx|zip)$/i),regexText:"Sono ammessi solo i file con estensione kml/kmz/gpx/zip",msgTarget:"under",validator:function(){var b=this.up("form").getForm();var c=b.findField("kml-url").getValue();if(!this.value&&!c){return false}return true},fieldLabel:"File",name:"kml-file",buttonText:"Browse"},{xtype:"textfield",fieldLabel:"URL",name:"kml-url",allowBlank:true,vtype:"url",msgTarget:"under",value:"",width:500,validator:function(){var c=this.up("form").getForm();var b=c.findField("kml-file").getValue();if(!this.value&&!b){return false}return true}}];this.superclass.constructor.call(this)}});Ext.define("CWN2.controller.button.loadlayers",{extend:"Ext.app.Controller",views:["CWN2.button.LoadLayers","CWN2.button.LoadLayers.Window"],refs:[{ref:"button",selector:"cwn2-button-loadlayers"},{ref:"win",selector:"cwn2-loadlayers-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.loadlayers: init");this.control({"cwn2-button-loadlayers":{click:this.onClick},"button[action=loadlayers-submit]":{click:this.onSubmitButtonClick},"button[action=loadlayers-cancel]":{click:this.onCancelButtonClick}})},onSubmitButtonClick:function(){var a=Ext.ComponentQuery.query("cwn2-loadlayers-tabpanel")[0].getActiveTab();switch(a.type){case"map":this.mapTreeSubmitHandler(a);break;case"layer":this.layerTreeSubmitHandler(a);break;case"wms":this.wmsSubmitHandler(a);break;case"kml":this.kmlSubmitHandler(a);break}},mapTreeSubmitHandler:function(a){var c=a.getSelectionModel().getSelection()[0],b=this;if(!c||!c.data.idMap){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Nessuna carta selezionata"));return}CWN2.loadingScreen=Ext.getBody().mask("Caricamento Livelli","loadingscreen");CWN2.Util.ajaxRequest({type:"JSONP",url:CWN2.Globals.RL_MAP_CONFIG_SERVICE+c.data.idMap,callBack:function(d){CWN2.app.map.layerManager.addLayers(d.data.layers);b.getWin().hide()}})},layerTreeSubmitHandler:function(a){var b=a.getSelectionModel().getSelection(),c=this,d="";Ext.each(b,function(e){if(e.data.idLayer){d+=e.data.idLayer+","}});if((d.length)===0){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Nessun livello selezionato"));return}d=d.substr(0,d.length-1);Ext.MessageBox.wait("Caricamento","Attendere");CWN2.Util.ajaxRequest({type:"JSONP",url:a.panelConfig.options.layersConfigServiceUrl+d,callBack:function(e){CWN2.app.map.layerManager.addLayers(e.data);c.getWin().hide();Ext.MessageBox.hide()}})},wmsSubmitHandler:function(a){var b=a.items.items[1].getSelectionModel().getSelection(),d=this,e="",c=true;Ext.each(b,function(f){if(!f.data.srs[CWN2.app.map.projection]){c=false;return false}CWN2.app.map.layerManager.addLayers({type:"WMS",name:f.data.name,minScale:f.data.minScale,maxScale:f.data.maxScale,queryable:f.data.queryable,visible:true,wmsParams:{url:f.raw.url,transparent:true,name:f.data.name},legend:{label:f.data.title,icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif"}})});if(!c){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Sistema di riferimento non gestito"))}d.getWin().hide()},kmlSubmitHandler:function(a){var c=this;var b=a.form;if(b.isValid()){if(b.getValues()["kml-url"]){if(b.getValues()["kml-url"].indexOf("kmz")>-1){b.submit({url:"/geoservices/REST/utils/kmz_upload_and_unzip/?url="+b.getValues()["kml-url"],waitMsg:"Caricamento file....",success:function(d,e){c.kmlLoadLayer(e.result.file)},failure:function(e,d){Ext.Msg.alert(CWN2.I18n.get("Attenzione"),d.result.error)}})}else{c.kmlLoadLayer(b.getValues()["kml-url"])}}else{b.submit({url:"/geoservices/REST/utils/file_upload",waitMsg:"Caricamento file....",success:function(d,e){c.kmlLoadLayer(e.result.file)},failure:function(e,d){Ext.Msg.alert(CWN2.I18n.get("Attenzione"),d.result.error)}})}c.getWin().hide()}else{Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),"Indicare una URL o un file da caricare")}},kmlLoadLayer:function(c){if(c.indexOf("kml")===-1&&c.indexOf("gpx")===-1){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),"Indicare una URL o un file da caricare")}var d=(c.indexOf("kml")>-1)?"KML":"GPX";var b=c.substring(c.lastIndexOf("/")+1,c.length-4);var a={name:b,type:d,projection:"EPSG:4326",url:c,visible:true,legend:{label:b,icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif"},infoOptions:{infoPopUp:"simple",infoWidth:300,infoHeight:300}};if(!CWN2.app.map.layerManager.isLayerInConfigWithTitle(a)){CWN2.app.map.layerManager.addLayers(a)}else{Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),"File già presente come livello sulla mappa")}},onCancelButtonClick:function(){this.getWin().hide()},onClick:function(){var e=CWN2.app.layout.mapPanel,d=this.getWin(),b=this.getButton(),c=this;if(!d){var a=[];Ext.each(b.config.panels,function(f){switch(f.type){case"layerTree":a.push(c.buildTreePanel(f,"layer"));break;case"mapTree":a.push(c.buildTreePanel(f,"map"));break;case"wms":a.push(c.buildWmsPanel(f));break;case"kml":a.push(c.buildKmlPanel(f));break}});d=Ext.create("CWN2.button.LoadLayers.Window",{items:a})}this.showHideWin(d,e)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},buildTreePanel:function(e,c){var b=(c==="map")?"idMap":"idLayer";var d=this;Ext.define("CWN2.button.LoadLayers.Tree",{extend:"Ext.data.Model",fields:[b,"text"]});var a=Ext.create("Ext.data.TreeStore",{model:"CWN2.button.LoadLayers.Tree",proxy:{type:"jsonp",url:e.options.treeServiceUrl,root:"data"},root:"data"});this.loadTree(a,e.options.treeServiceUrl);return Ext.create("CWN2.button.LoadLayers.TreePanel",{title:CWN2.I18n.get(e.name),store:a,type:c,panelConfig:e})},loadTree:function(b,a){CWN2.Util.ajaxRequest({type:"JSONP",url:a,callBack:function(d){var c=d.data;b.setRootNode(c)}})},buildWmsPanel:function(b){var a=this;return Ext.create("CWN2.button.LoadLayers.WmsPanel",{panelConfig:b})},buildKmlPanel:function(b){var a=this;return Ext.create("CWN2.button.LoadLayers.KmlPanel",{panelConfig:b})}});Ext.define("CWN2.button.MeasureArea",{extend:"Ext.button.Button",alias:"widget.cwn2-button-measurearea",constructor:function(c){var b=c.options,e=CWN2.app.map,f="measurearea",a="cwn2-measure-div",d=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{persist:true,geodesic:true,eventListeners:{measure:function(g){var h=CWN2.I18n.get("Area")+": "+g.measure.toFixed(3)+" "+g.units+"2";Ext.ComponentQuery.query("cwn2-statusbar")[0].setStatusbarItemText(a,h)},measurepartial:function(g){var h=CWN2.I18n.get("Area")+": "+g.measure.toFixed(3)+" "+g.units+"2";Ext.ComponentQuery.query("cwn2-statusbar")[0].setStatusbarItemText(a,h)}}});Ext.ComponentQuery.query("cwn2-statusbar")[0].addStatusbarItem({id:a,text:"",width:200,xtype:"tbtext"});e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:CWN2.I18n.get("Misure Areali"),iconCls:(b&&b.iconCls)?b.iconCls:f,text:(b&&b.text)?b.text:"",width:(b&&b.width)?b.width:26,enableToggle:true,control:d,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.MeasureLine",{extend:"Ext.button.Button",alias:"widget.cwn2-button-measureline",constructor:function(c){var b=c.options,e=CWN2.app.map,a="cwn2-measure-div",f="measureline",d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,geodesic:true,eventListeners:{measure:function(g){var h=CWN2.I18n.get("Distanza")+": "+g.measure.toFixed(3)+" "+g.units;Ext.ComponentQuery.query("cwn2-statusbar")[0].setStatusbarItemText(a,h)},measurepartial:function(g){var h=CWN2.I18n.get("Distanza")+": "+g.measure.toFixed(3)+" "+g.units;Ext.ComponentQuery.query("cwn2-statusbar")[0].setStatusbarItemText(a,h)}}});Ext.ComponentQuery.query("cwn2-statusbar")[0].addStatusbarItem({id:a,text:"",width:200,xtype:"tbtext"});e.addControl(d);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:f,tooltip:CWN2.I18n.get("Misure Lineari"),iconCls:(b&&b.iconCls)?b.iconCls:f,text:(b&&b.text)?b.text:"",width:(b&&b.width)?b.width:26,enableToggle:true,control:d,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.ModifyFeature",{extend:"Ext.button.Button",alias:"widget.cwn2-button-modifyfeature",constructor:function(b){var a=b.options,d=CWN2.app.map,g="modifyFeature",f=OpenLayers.Control.ModifyFeature.RESHAPE,e={mode:f,createVertices:true},c=new OpenLayers.Control.ModifyFeature(CWN2.Editor.createEditingLayer(d),e);d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:g,tooltip:CWN2.I18n.get("Modifica geometria"),iconCls:(a&&a.iconCls)?a.iconCls:g,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:c,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.Pan",{extend:"Ext.button.Button",alias:"widget.cwn2-button-pan",constructor:function(b){var f="pan",a=b.options,c=b.panels,e=CWN2.app.map,d=new OpenLayers.Control.Navigation();e.addControl(d);e.getControlsByClass("OpenLayers.Control.Navigation")[0].deactivate();this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{tooltip:CWN2.I18n.get("Pan"),iconCls:(a&&a.iconCls)?a.iconCls:f,text:(a&&a.text)?a.text:"",scale:b.scale,enableToggle:true,control:d,id:f,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.Print",{extend:"Ext.button.Button",alias:"widget.cwn2-button-print",constructor:function(b){var a=b.options;this.superclass.constructor.call(this,{id:"print",tooltip:CWN2.I18n.get("Stampa"),iconCls:(a&&a.iconCls)?a.iconCls:"print",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false})}});Ext.define("CWN2.button.Print.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-print-win",closeAction:"hide",title:CWN2.I18n.get("Stampa"),height:400,width:400,layout:"fit",resizable:false,constructor:function(a){this.items=[{xtype:"panel",height:"auto",width:"auto",frame:true,items:[{xtype:"fieldset",title:" ",width:350,border:false,labelWidth:20,flex:1,items:[{xtype:"cwn2-btn-print-format-combo"},{xtype:"cwn2-btn-print-scale-field"}]},{xtype:"cwn2-btn-print-pngfieldset"},{xtype:"cwn2-btn-print-pdffieldset"}],buttons:[{text:CWN2.I18n.get("Stampa"),action:"print-submit"},{text:CWN2.I18n.get("Annulla"),action:"print-cancel"}],autoScroll:true}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.Print.PngFieldSet",{extend:"Ext.form.FieldSet",alias:"widget.cwn2-btn-print-pngfieldset",title:"Dimensione PNG",width:370,flex:1,items:[{xtype:"cwn2-btn-print-width-field"},{xtype:"cwn2-btn-print-height-field"}]});Ext.define("CWN2.button.Print.PdfFieldSet",{extend:"Ext.form.FieldSet",alias:"widget.cwn2-btn-print-pdffieldset",title:"Pagina PDF",width:370,flex:1,items:[{xtype:"cwn2-btn-print-pagesize-combo"},{xtype:"cwn2-btn-print-orientation-combo"},{xtype:"cwn2-btn-print-title-field"}]});Ext.define("CWN2.button.Print.OrientationCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-print-orientation-combo",fieldLabel:"Orientazione",queryMode:"local",store:[["portrait","Verticale"],["landscape","Orizzontale"]],typeAhead:true,triggerAction:"all",value:"portrait",width:200});Ext.define("CWN2.button.Print.PageSizeCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-print-pagesize-combo",fieldLabel:"Dimensione",queryMode:"local",store:[["A3","A3"],["A4","A4"],["A5","A5"]],typeAhead:true,triggerAction:"all",value:"A4",width:160});Ext.define("CWN2.button.Print.FormatCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-print-format-combo",fieldLabel:"Formato",labelWidth:50,queryMode:"local",store:[["pdf","File PDF"],["png","Immagine PNG"]],typeAhead:true,triggerAction:"all",value:"pdf",width:160});Ext.define("CWN2.button.Print.TitleField",{extend:"Ext.form.TextArea",alias:"widget.cwn2-btn-print-title-field",fieldLabel:"Titolo",allowBlank:true,width:340,value:null});Ext.define("CWN2.button.Print.WidthField",{extend:"Ext.form.NumberField",alias:"widget.cwn2-btn-print-width-field",fieldLabel:"Larghezza (pixel)",allowBlank:false,value:"1",minValue:1,maxValue:2024,width:160});Ext.define("CWN2.button.Print.ScaleField",{extend:"Ext.form.field.Checkbox",alias:"widget.cwn2-btn-print-scale-field",boxLabel:"Mantieni Scala",checked:true});Ext.define("CWN2.button.Print.HeightField",{extend:"Ext.form.NumberField",alias:"widget.cwn2-btn-print-height-field",fieldLabel:"Altezza (pixel)",allowBlank:false,value:"1",minValue:1,maxValue:2024,width:160});Ext.define("CWN2.controller.button.print",{extend:"Ext.app.Controller",views:["CWN2.button.Print"],refs:[{ref:"button",selector:"cwn2-button-print"},{ref:"win",selector:"cwn2-print-win"},{ref:"format",selector:"cwn2-btn-print-format-combo"},{ref:"width",selector:"cwn2-btn-print-width-field"},{ref:"height",selector:"cwn2-btn-print-height-field"},{ref:"title",selector:"cwn2-btn-print-title-field"},{ref:"orientation",selector:"cwn2-btn-print-orientation-combo"},{ref:"pageSize",selector:"cwn2-btn-print-pagesize-combo"},{ref:"scale",selector:" cwn2-btn-print-scale-field"},{ref:"pngFieldSet",selector:" cwn2-btn-print-pngfieldset"},{ref:"pdfFieldSet",selector:" cwn2-btn-print-pdffieldset"}],init:function(a){CWN2.Util.log("CWN2.controller.button.print: init");this.control({"button[action=print-submit]":{click:this.onSubmitButtonClick},"button[action=print-cancel]":{click:this.onCancelButtonClick},"cwn2-btn-print-format-combo":{select:this.onFormatSelect},"cwn2-button-print":{click:this.onClick}})},onClick:function(){var d=CWN2.app.layout.mapPanel,c=this.getWin(),a=this.getButton(),b=this;if(!c){c=Ext.create("CWN2.button.Print.Window",{})}this.showHideWin(c,d)},showHideWin:function(a,b){if(!a.isVisible()){a.show();this.setFieldValues();this.enableFieldSets();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},setFieldValues:function(){var c=this.getWidth(),b=this.getHeight(),a=this.getTitle();if(c.value===1){c.setValue(CWN2.app.map.div.scrollWidth)}if(b.value===1){b.setValue(CWN2.app.map.div.scrollHeight)}if(a.value===null||a.value===""){a.setValue(CWN2.app.layout.mapTitle)}},enableFieldSets:function(){var a=this.getFormat().value;if(a==="png"){this.getPngFieldSet().enable();this.getPdfFieldSet().disable()}else{this.getPngFieldSet().disable();this.getPdfFieldSet().enable()}},onFormatSelect:function(){this.enableFieldSets()},onCancelButtonClick:function(){this.getWin().hide()},onSubmitButtonClick:function(f,h,j){var m=this,g=this.getWin(),p=this.getFormat().value,b=this.getWidth().value,o=this.getHeight().value,n=this.getTitle().value||null,c=this.getScale().value,a=this.getOrientation().value,l=this.getPageSize().value;if(p==="pdf"){var k=CWN2.app.map.div.scrollHeight/CWN2.app.map.div.scrollWidth;switch(l){case"A4":if(a==="portrait"){b=900;o=parseInt(b*k)}else{o=800;b=parseInt(o/k)}break;case"A3":if(a==="portrait"){b=1400;o=parseInt(b*k)}else{o=1150;b=parseInt(o/k)}break;case"A5":if(a==="portrait"){b=750;o=parseInt(b*k)}else{o=600;b=parseInt(o/k)}break}}var d={printConfig:{fileType:p,title:n,width:b,height:o,pageSize:l,orientation:a},mapOptions:{projection:CWN2.app.map.projection,extent:CWN2.app.map.getExtent().toString(),center:{lon:CWN2.app.map.center.lon,lat:CWN2.app.map.center.lat},zoom:CWN2.app.map.zoom,flagSameScale:c,scale:CWN2.app.map.getScale()},baseLayers:[CWN2.app.map.layerManager.getActiveBaseLayerConfig()],layers:CWN2.app.map.layerManager.overlayLayersConfig};CWN2.loadingScreen=Ext.getBody().mask("Preparazione Stampa","loadingscreen");CWN2.Util.ajaxRequest({type:"JSON",url:"/geoservices/REST/gv_print/print",callBack:function(q){var s={};if(!q){s.message=q.responseText;s.level=2;CWN2.Util.handleException(s);return}if(q.success===false){s.message=q.message;s.level=2;CWN2.Util.handleException(s);return}CWN2.Util.log("Preparato file di stampa: "+q.url);var r="menubar=yes,location=no,resizable=no,scrollbars=no,status=no";var e=window.open(q.url,"",r);e.focus();g.hide()},jsonData:d});if(p==="pdf"){CWN2.Util.ajaxRequest({type:"JSON",url:"/geoservices/REST/gv_print/print_legend",callBack:function(e){var q={};if(!e){q.message=e.responseText;q.level=2;CWN2.Util.handleException(q);return}if(e.success===false){q.message=e.message;q.level=2;CWN2.Util.handleException(q);return}Ext.each(e.url,function(s,r){var t="menubar=yes,location=no,resizable=no,scrollbars=no,status=no";window.open(s,"",t);g.hide()})},jsonData:d})}}});Ext.define("CWN2.button.QpgTematismi",{extend:"Ext.button.Button",alias:"widget.cwn2-button-qpgtematismi",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{id:"qpgtematismi",tooltip:CWN2.I18n.get("Tematismi"),iconCls:(a&&a.iconCls)?a.iconCls:"tematismi",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false})}});Ext.define("CWN2.button.QpgTematismi.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-btn-qpgtematismi-win",closeAction:"hide",title:CWN2.I18n.get("Modifica Tematismo"),height:450,width:350,layout:"fit",resizable:false,constructor:function(a){var b=this;this.items=[{xtype:"cwn2-btn-qpgtematismi-panel",tematismi:a.tematismi}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.QpgTematismi.Panel",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-qpgtematismi-panel",height:"auto",width:"auto",frame:true,buttons:[{text:CWN2.I18n.get("Ricalcola Classi"),action:"qpgtematismi-recalc"},{text:CWN2.I18n.get("Modifica Tema"),action:"qpgtematismi-submit"}],autoScroll:true,constructor:function(a){this.items=[{xtype:"cwn2-btn-qpgtematismi-temi-combo",tematismi:a.tematismi},{xtype:"cwn2-btn-qpgtematismi-tipo-combo",tematismo:a.tematismi[0]},{xtype:"cwn2-btn-qpgtematismi-classi-combo",tematismo:a.tematismi[0]},{xtype:"cwn2-btn-qpgtematismi-scala-colore-combo",tematismo:a.tematismi[0]},{xtype:"cwn2-btn-qpgtematismi-grid-panel",tematismo:a.tematismi[0]}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.QpgTematismi.TemiCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-qpgtematismi-temi-combo",fieldLabel:"Tematismo",labelWidth:70,mode:"local",typeAhead:true,triggerAction:"all",valueField:"idTema",displayField:"descrizione",width:300,constructor:function(a){Ext.define("QpgTematismi",{extend:"Ext.data.Model",fields:[{name:"idTema",type:"number"},{name:"descrizione",type:"string"}]});this.store=Ext.create("Ext.data.Store",{model:"QpgTematismi",data:{tematismi:a.tematismi},proxy:{type:"memory",reader:{type:"json",root:"tematismi"}}});this.superclass.constructor.call(this);this.setValue(this.getStore().getAt(0).data.descrizione)}});Ext.define("CWN2.button.QpgTematismi.TipoCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-qpgtematismi-tipo-combo",fieldLabel:"Tipo",labelWidth:70,mode:"local",typeAhead:true,triggerAction:"all",valueField:"id",displayField:"tipo",width:300,constructor:function(a){this.store=[[1,"Uguale Ampiezza degli Intervalli"],[2,"Uguale numero di occorrenze (quantili)"],[3,"Personalizzata"]];this.superclass.constructor.call(this);this.setValue(a.tematismo.idTipoClassificazione)}});Ext.define("CWN2.button.QpgTematismi.ClassiCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-qpgtematismi-classi-combo",fieldLabel:"Num. Classi",labelWidth:70,mode:"local",typeAhead:true,triggerAction:"all",width:200,constructor:function(a){this.store=[[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9]];this.superclass.constructor.call(this);this.setValue(a.tematismo.numClassi)}});Ext.define("CWN2.button.QpgTematismi.ScalaColoreCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-qpgtematismi-scala-colore-combo",fieldLabel:"Scala Colore",labelWidth:70,mode:"local",typeAhead:true,triggerAction:"all",width:200,constructor:function(a){this.store=[["Rosso","Rosso"],["Verde","Verde"],["Blu","Blu"]];this.superclass.constructor.call(this);this.setValue(a.tematismo.scalaColore)}});Ext.define("CWN2.button.QpgTematismi.GridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-btn-qpgtematismi-grid-panel",constructor:function(c){function a(g,f,e){return"<img id='legend_img_"+e.internalId+"' src='"+e.data.legendIcon+"' >"}Ext.define("QpgTematismiGridClassi",{extend:"Ext.data.Model",fields:[{name:"legendIcon",type:"string"},{name:"from",type:"number"},{name:"to",type:"number"},{name:"count",type:"number"}]});var b=Ext.create("Ext.data.Store",{model:"QpgTematismiGridClassi",data:{classes:c.tematismo.legendClasses},proxy:{type:"memory",reader:{type:"json",root:"classes"}}});this.superclass.constructor.call(this,{store:b,viewConfig:{forceFit:true},width:230,height:250,margin:"15 0 0 0",title:null,hideHeaders:true,disableSelection:true,columns:[{xtype:"actioncolumn",dataIndex:"legendIcon",renderer:a,width:30},{dataIndex:"from",editor:{xtype:"numberfield",allowBlank:false},renderer:function(e){if(c.tematismo.separatoreDecimale===","){numeral.language("it")}else{numeral.language("en")}return numeral(e).format("0000.00")},width:60},{dataIndex:"to",editor:{xtype:"numberfield",allowBlank:false},renderer:function(e){if(c.tematismo.separatoreDecimale===","){numeral.language("it")}else{numeral.language("en")}return numeral(e).format("0000.00")},width:60},{dataIndex:"count",renderer:function(e){return"("+e+")"},width:60}],frame:true,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})]});var d=this}});Ext.define("CWN2.controller.button.qpgtematismi",{extend:"Ext.app.Controller",views:["CWN2.button.QpgTematismi","CWN2.button.QpgTematismi.GridPanel"],refs:[{ref:"button",selector:"cwn2-button-qpgtematismi"},{ref:"win",selector:"cwn2-btn-qpgtematismi-win"},{ref:"panel",selector:"cwn2-btn-qpgtematismi-panel"},{ref:"gridPanel",selector:"cwn2-btn-qpgtematismi-grid-panel"},{ref:"temi",selector:"cwn2-btn-qpgtematismi-temi-combo"},{ref:"tipo",selector:"cwn2-btn-qpgtematismi-tipo-combo"},{ref:"classi",selector:"cwn2-btn-qpgtematismi-classi-combo"},{ref:"scalaColore",selector:"cwn2-btn-qpgtematismi-scala-colore-combo"}],init:function(a){CWN2.Util.log("CWN2.controller.button.qpgtematismi: init");this.control({"cwn2-button-qpgtematismi":{click:this.onClick},"cwn2-btn-qpgtematismi-temi-combo":{select:this.onThemesSelect},"cwn2-btn-qpgtematismi-grid-panel":{edit:this.onGridEdit},"button[action=qpgtematismi-recalc]":{click:this.onRecalcButtonClick},"button[action=qpgtematismi-submit]":{click:this.onSubmitButtonClick}})},onGridEdit:function(c,f){var d=this;var b=this.getGridPanel();if(f.colIdx===1&&f.rowIdx>0){var a=b.getView().getRecord(b.getView().getNode(f.rowIdx-1));if(a&&a.data.to!==f.value){a.set("to",f.value)}}if(f.colIdx===2&&f.rowIdx<f.store.data.length){var a=b.getView().getRecord(b.getView().getNode(f.rowIdx+1));if(a&&a.data.from!==f.value){a.set("from",f.value)}}if(this.checkChangedBounds()){this.getTipo().setValue(3)}},checkChangedBounds:function(){var b=this;var a=this.getGridPanel().getStore().getRange();var d=this.getTematismo(this.selectedTheme).legendClasses;var c=false;Ext.each(a,function(e,f){if(e.data.from!==d[f].from||e.data.to!==d[f].to){c=true}});return c},calculateStats:function(a){var b=this.getGridPanel().getStore().getRange();var c=[];Ext.each(b,function(d,e){if(e===0){c.push(d.data.from)}c.push(d.data.to)});CWN2.QPG.calculateStats(a,c)},onRecalcButtonClick:function(){var c=this;var b=this.getTematismo(this.selectedTheme);var a={};a.tipoTematismo=b.tipoTematismo;a.descrizione=b.descrizione;a.valori=b.valori;a.separatoreDecimale=b.separatoreDecimale;a.livello=Ext.clone(b.livello);a.idTipoClassificazione=this.getTipo().getValue();a.numClassi=this.getClassi().getValue();a.scalaColore=this.getScalaColore().getValue();this.calculateStats(a);CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,callBack:function(d){CWN2.QPG.loadQPGLayer(a,d.data.sldUrl);c.reloadGridPanel(a)},jsonData:{sldBody:a.stat.sldBody,sldCleanBody:""},disableException:true})},onSubmitButtonClick:function(){var b=this;var a=this.getTematismo(this.selectedTheme);a.idTipoClassificazione=this.getTipo().getValue();a.numClassi=this.getClassi().getValue();a.scalaColore=this.getScalaColore().getValue();this.calculateStats(a);CWN2.Util.ajaxRequest({type:"JSON",url:CWN2.Globals.RL_CREATE_SLD_SERVICE,callBack:function(c){a.layerConfig.classes=CWN2.QPG.getRules(a,"http://geoservizi.regione.liguria.it/geoserver/QPG_TEMI/",c.data.sldUrl);a.olLayer.styleMap=CWN2.LayerFactory.createVectorStyleMap(a.layerConfig);a.olLayer.url="http://geoservizi.regione.liguria.it/geoserver/QPG_TEMI/wms?VIEWPARAMS=ID_RICHIESTA:"+a.idRichiesta+";ID_TEMA:"+a.idTema+"&SLD="+c.data.sldUrl;a.olLayer.redraw(true);b.reloadGridPanel(a)},jsonData:{sldBody:a.stat.sldBody,sldCleanBody:""},disableException:true})},getTematismo:function(b){var a;var c=CWN2.app.configuration.qpgRequest.tematismi;Ext.each(c,function(d){if(d.idTema===b){a=d;return false}});return a},onThemesSelect:function(e,b,c){var d=this;this.selectedTheme=b[0].data.idTema;var a=this.getTematismo(b[0].data.idTema);d.getTipo().setValue(a.idTipoClassificazione);d.getClassi().setValue(a.numClassi);d.getScalaColore().setValue(a.scalaColore);this.reloadGridPanel(a)},reloadGridPanel:function(b){var d=this;Ext.suspendLayouts();var a=this.getPanel();var c=this.getGridPanel();a.remove(c);a.add({xtype:"cwn2-btn-qpgtematismi-grid-panel",tematismo:b});Ext.resumeLayouts(true)},onClick:function(){var e=this.getWin(),a=this.getButton(),c=this;var d=CWN2.app.configuration.qpgRequest.tematismi;var b=false;Ext.each(d,function(f){if(f.idTipoClassificazione>0){b=true;return false}});if(b){if(!e){e=Ext.create("CWN2.button.QpgTematismi.Window",{tematismi:d})}this.showHideWin(e,CWN2.app.layout.mapPanel)}else{CWN2.Util.msgBox("Nessun tematismo editabile");return}this.selectedTheme=d[0].idTema},selectedTheme:null,showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.button.RemoveLayers",{extend:"Ext.button.Button",alias:"widget.cwn2-button-removelayers",constructor:function(b){var a=b.options,d="removelayers",c=CWN2.app.map;this.config=b;this.superclass.constructor.call(this,{tooltip:CWN2.I18n.get("Togli Livelli"),iconCls:(a&&a.iconCls)?a.iconCls:d,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false,id:d,handler:function(){}})}});Ext.define("CWN2.button.RemoveLayers.GridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-removelayers-grid",id:"remove-layer-panel",disableSelection:true,header:false,hideHeaders:true,columns:[{dataIndex:"name",renderer:function(a){return"<input name='"+a+"' id='rm_check_"+a+"' type='checkbox' >"},width:25},{dataIndex:"legend",renderer:function(d,b,a){var c=a.data.legendLabel;return"<div>"+c+" </div>"},width:275}],autoScroll:true,width:320,frame:true,constructor:function(a){this.store=a.store;this.superclass.constructor.call(this)}});Ext.define("CWN2.button.RemoveLayers.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-removelayers-win",title:CWN2.I18n.get("Seleziona i livelli da eliminare"),height:300,width:360,layout:"fit",resizable:false,closable:false,closeAction:"hide",constructor:function(a){this.items=[{xtype:"cwn2-removelayers-grid",store:a.store}];this.buttons=a.buttons;this.superclass.constructor.call(this)}});Ext.define("CWN2.controller.button.removelayers",{extend:"Ext.app.Controller",views:["CWN2.button.RemoveLayers","CWN2.button.RemoveLayers.Window"],refs:[{ref:"button",selector:"cwn2-button-removelayers"},{ref:"win",selector:"cwn2-removelayers-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.removelayers: init");this.control({"cwn2-button-removelayers":{click:this.onClick},"button[action=removelayers-submit]":{click:this.onSubmitButtonClick},"button[action=removelayers-cancel]":{click:this.onCancelButtonClick}})},onSubmitButtonClick:function(){var a=[];Ext.each(CWN2.app.map.layerManager.getLayersConfig(),function(c){var b=window.document.getElementById("rm_check_"+c.name);if(b&&b.checked){a.push(c.name)}});CWN2.app.map.layerManager.remove(a);this.getWin().hide()},onCancelButtonClick:function(){this.getWin().hide()},onClick:function(){var d=CWN2.app.layout.mapPanel,c=this.getWin(),a=this.getButton(),b=this;if(!c){c=Ext.create("CWN2.button.RemoveLayers.Window",{store:CWN2.app.map.layerManager.getLayerStore("overlay"),buttons:[{action:"removelayers-submit",text:CWN2.I18n.get("Rimuovi")},{action:"removelayers-cancel",text:CWN2.I18n.get("Annulla")}]})}this.showHideWin(c,d)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.button.Risknat",{extend:"Ext.button.Button",alias:"widget.cwn2-button-risknat",constructor:function(b){var a=b.options,c="risknat";this.config=b;this.superclass.constructor.call(this,{tooltip:CWN2.I18n.get("Caricamento Livelli Risknat"),pressed:false,id:c,iconCls:(a&&a.iconCls)?a.iconCls:c,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26})}});Ext.define("CWN2.button.Risknat.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-risknat-win",title:CWN2.I18n.get("Caricamento Livelli Risknat"),height:205,width:335,resizable:false,layout:"fit",closeAction:"hide",buttons:[{text:CWN2.I18n.get("Carica"),action:"risknat-submit"},{text:CWN2.I18n.get("Annulla"),action:"risknat-cancel"}]});Ext.define("CWN2.button.Risknat.TabPanel",{extend:"Ext.tab.Panel",alias:"widget.cwn2-btn-risknat-tab-panel",activeTab:0,bodyBorder:false,deferredRender:false,layoutOnTabChange:true,border:false,flex:1,plain:true});Ext.define("CWN2.button.Risknat.Target",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-risknat-target-panel",frame:true,labelWidth:1,height:215,type:"target"});Ext.define("CWN2.button.Risknat.Aree",{extend:"Ext.panel.Panel",alias:"widget.cwn2-btn-risknat-aree-panel",frame:true,labelWidth:1,height:215,type:"aree"});Ext.define("CWN2.button.Risknat.DatasetCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-risknat-dataset-combo",mode:"remote",typeAhead:true,triggerAction:"all",value:"Scegli un dataset...",valueField:"codice",displayField:"label",margin:"10 0 0 0",width:300,constructor:function(b){var a="/geoservices/REST/risknat/ds_list?type="+b.type;Ext.define("DatasetModel",{extend:"Ext.data.Model",fields:[{name:"codice",type:"integer"},{name:"label",type:"string"},{name:"extent",type:"string"}]});this.store=Ext.create("Ext.data.Store",{fields:["codice","label","extent"],proxy:{type:"ajax",url:a,reader:{type:"json",root:"dataset"},listeners:{exception:{fn:function(g,d,c,f){var e={};e.message="Errore caricamento dataset";e.level=2;CWN2.Util.handleException(e)}}}},autoLoad:true});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.Risknat.DatasetComboAree",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-btn-risknat-dataset-combo-aree",mode:"local",typeAhead:true,triggerAction:"all",value:"Scegli un dataset...",valueField:"codice",displayField:"label",margin:"10 0 0 0",width:300,constructor:function(b){var a="/geoservices/REST/risknat/ds_list?type="+b.type;Ext.define("DatasetModel",{extend:"Ext.data.Model",fields:[{name:"codice",type:"integer"},{name:"label",type:"string"},{name:"extent",type:"string"}]});this.store=Ext.create("Ext.data.Store",{fields:["codice","label","extent"],proxy:{type:"ajax",url:a,reader:{type:"json",root:"dataset"},listeners:{exception:{fn:function(g,d,c,f){var e={};e.message="Errore caricamento dataset";e.level=2;CWN2.Util.handleException(e)}}}},autoLoad:true});this.superclass.constructor.call(this)}});Ext.define("CWN2.button.Risknat.TargetSubmit",{extend:"Ext.button.Button",alias:"widget.cwn2-btn-risknat-target-submit",text:"Carica..."});Ext.define("CWN2.controller.button.risknat",{extend:"Ext.app.Controller",views:["CWN2.button.Risknat"],refs:[{ref:"button",selector:"cwn2-button-risknat"},{ref:"win",selector:"cwn2-risknat-win"},{ref:"datasetCombo",selector:"cwn2-btn-risknat-dataset-combo"},{ref:"datasetComboAree",selector:"cwn2-btn-risknat-dataset-combo-aree"}],init:function(a){CWN2.Util.log("CWN2.controller.button.risknat: init");this.control({"cwn2-button-risknat":{click:this.onClick},"button[action=risknat-submit]":{click:this.onSubmitButtonClick},"button[action=risknat-cancel]":{click:this.onCancelButtonClick}})},onSubmitButtonClick:function(){var b=Ext.ComponentQuery.query("cwn2-btn-risknat-tab-panel")[0].getActiveTab();var e=this,f=(b.type==="target")?this.getDatasetCombo():this.getDatasetComboAree(),a=f.value;if(isNaN(parseInt(a))){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Nessun Dataset selezionato"))}else{var c=f.findRecordByValue(a).data.label;var d=f.findRecordByValue(a).data.extent;switch(b.type){case"target":e.caricaTarget(a,c);break;case"aree":e.caricaAree(a,c);break}if(Ext.getCmp("risknat-zoom-checkbox").value){CWN2.app.map.zoomToExtent(OpenLayers.Bounds.fromString(CWN2.Util.transformStrBounds("EPSG:3003",CWN2.app.map.projection,d)))}this.getWin().hide()}},caricaAree:function(a,c){var f=this,e=this.getButton();var d=e.config.options.serviceUrl||"http://geoservizi.datasiel.net:8080/geoserver/RISKNAT/wms?";d+="VIEWPARAMS=ID_DATASET:"+a;var b="AREE_DS"+a;CWN2.app.map.layerManager.addLayers({type:"WMS",name:b,queryable:true,flagGeoserver:true,visible:true,geomSubType:"POLYGON",multiClasse:true,wmsParams:{url:d,transparent:true,name:"AREE_ANOMALE",format:"image/png8"},infoOptions:{infoUrl:"http://www.cartografiarl.regione.liguria.it/mapfiles/info/repertoriocartografico/RISKNATAreePubblico.xsl",infoTarget:"info",infoIdAttr:"ID_AREA",infoLabelAttr:"ID_AREA"},legend:{label:c+" - Aree Anomale",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif"}})},caricaTarget:function(a,c){var f=this,e=this.getButton();var d=e.config.options.serviceUrl||"http://geoservizi.datasiel.net:8080/geoserver/RISKNAT/wms?";var b="TARGET_DS"+a;CWN2.app.map.layerManager.addLayers({type:"WMS",name:b,minScale:"150000",queryable:true,flagGeoserver:true,visible:true,multiClasse:true,wmsParams:{url:d,transparent:true,name:b,format:"image/png8"},infoOptions:{infoUrl:"http://www.cartografiarl.regione.liguria.it/mapfiles/info/repertoriocartografico/RisknatTarget.xsl",infoTarget:"info",infoIdAttr:"ID",infoLabelAttr:"CODE_TARGET"},legend:{label:c+" - Target",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/classi.gif"}})},onCancelButtonClick:function(){this.getWin().hide()},onClick:function(){var e=CWN2.app.layout.mapPanel,d=this.getWin(),b=this.getButton(),c=this;if(!d){var a=[];a.push({xtype:"cwn2-btn-risknat-target-panel",title:"Target",items:[{xtype:"cwn2-btn-risknat-dataset-combo",type:"target"},{xtype:"button",text:"Info sul Dataset",margin:"10 0 0 0",handler:function(){var f=c.getDatasetCombo().value;if(isNaN(parseInt(f))){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Nessun Dataset selezionato"))}else{var g=c.getDatasetCombo().findRecordByValue(f).data.label;window.open("http://www.cartografiarl.regione.liguria.it/RiskNat/pdf/"+g+".pdf")}}},{xtype:"checkbox",boxLabel:"Zoom sul Dataset",name:"risknat-zoom-checkbox",inputValue:"1",margin:"10 0 0 0",id:"risknat-zoom-checkbox"}]});a.push({xtype:"cwn2-btn-risknat-aree-panel",title:"Aree Anomale",items:[{xtype:"cwn2-btn-risknat-dataset-combo-aree",type:"aree"},{xtype:"button",text:"Info sul Dataset",margin:"10 0 0 0",handler:function(){var f=c.getDatasetCombo().value;if(isNaN(parseInt(f))){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Nessun Dataset selezionato"))}else{var g=c.getDatasetCombo().findRecordByValue(f).data.label;window.open("http://www.cartografiarl.regione.liguria.it/RiskNat/pdf/"+g+".pdf")}}},{xtype:"checkbox",boxLabel:"Zoom sul Dataset",name:"risknat-zoom-checkbox",inputValue:"1",margin:"10 0 0 0",id:"risknat-zoom-checkbox"}]});d=Ext.create("CWN2.button.Risknat.Window",{items:[{xtype:"cwn2-btn-risknat-tab-panel",id:"risknat-tabpanel",items:a}]})}this.showHideWin(d,e)},showHideWin:function(a,b){if(a.isVisible()){a.hide()}else{a.show();a.alignTo(b.body,"tl-tl",[10,10])}}});Ext.define("CWN2.button.RoutePlanner",{extend:"Ext.button.Button",alias:"widget.cwn2-button-routeplanner",constructor:function(b){this.config=b;var a=b.options,c="routeplanner";this.superclass.constructor.call(this,{tooltip:CWN2.I18n.get("Calcolo Percorsi"),iconCls:(a&&a.iconCls)?a.iconCls:c,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:20,pressed:false,id:c})}});Ext.define("CWN2.button.RoutePlanner.Store",{extend:"Ext.data.Store",fields:[{name:"id"},{name:"instructions"},{name:"distance"},{name:"duration"}]});Ext.define("CWN2.button.RoutePlanner.OutputPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-routeplanner-outputpanel",title:"",viewConfig:{forceFit:true},split:true,hideHeaders:true,autoScroll:true,width:220,region:"center",visible:false,frame:true,store:Ext.create("CWN2.button.RoutePlanner.Store"),columns:[{id:"instructions",dataIndex:"instructions",renderer:function(c,b,a){if(a.data.instructions){return"<div style='white-space:normal'>"+a.data.instructions+" </div>"}return null},width:250},{id:"distance",dataIndex:"distance",renderer:function(c,b,a){if(a.data.distance){return"<div>"+a.data.distance+" </div>"}return null},width:40},{id:"duration",dataIndex:"duration",renderer:function(c,b,a){if(a.data.duration){return"<div>"+a.data.duration+" </div>"}return null},width:30}],tbar:[new Ext.form.field.Text({id:"cwn2-routeplanner-output-panel-title",width:270,readOnly:true}),"->",{text:"Zoom",action:"routeplanner-zoom"}]});Ext.define("CWN2.button.RoutePlanner.ModeComboBox",{extend:"Ext.form.field.ComboBox",alias:"widget.cwn2-routeplanner-modecombo",store:[["DRIVING",CWN2.I18n.get("In auto")],["WALKING",CWN2.I18n.get("A piedi")]],autoSelect:true,fieldLabel:CWN2.I18n.get("Mezzo"),width:160,labelWidth:35,displayField:"descrizione",valueField:"codice",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",value:"DRIVING",selectOnFocus:true});Ext.define("CWN2.button.RoutePlanner.InputPanel",{extend:"Ext.form.Panel",alias:"widget.cwn2-routeplanner-inputpanel",title:"",method:"GET",defaults:{labelWidth:15,labelPad:10},bodyStyle:"padding:5px 5px 0",region:"north",height:130,constructor:function(){this.items=[{xtype:"container",border:false,layout:"column",anchor:"100%",labelWidth:15,items:[{xtype:"cwn2-geocoder-combobox",id:"cwn2-routeplanner-start-combo",width:300,fieldLabel:"A",labelWidth:35,map:CWN2.app.map,service:"google"},{xtype:"component",width:5,html:"&nbsp;"},{xtype:"button",action:"routeplanner-start",layout:"form",iconCls:"routeplanner-map",tooltip:CWN2.I18n.get("Seleziona punto di partenza sulla mappa"),enableToggle:true,toggleGroup:"mapInteractToggleGroup"}]},{xtype:"container",border:false,layout:"column",anchor:"100%",items:[{xtype:"cwn2-geocoder-combobox",id:"cwn2-routeplanner-end-combo",width:300,fieldLabel:"B",labelWidth:35,map:CWN2.app.map,service:"google"},{xtype:"component",width:5,html:"&nbsp;"},{xtype:"button",action:"routeplanner-end",layout:"form",iconCls:"routeplanner-map",tooltip:CWN2.I18n.get("Seleziona punto di arrivo sulla mappa"),enableToggle:true,toggleGroup:"mapInteractToggleGroup"}]},{xtype:"container",border:false,layout:"column",anchor:"100%",items:[{xtype:"cwn2-routeplanner-modecombo"},{xtype:"component",width:145,html:"&nbsp;"}]}];this.buttons=[{text:CWN2.I18n.get("Calcola"),action:"routeplanner-submit"},{text:CWN2.I18n.get("Reset"),action:"routeplanner-reset"}];this.superclass.constructor.call(this)}});Ext.define("CWN2.button.RoutePlanner.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-routeplanner-win",title:CWN2.I18n.get("Calcolo Percorsi"),frame:true,width:370,height:160,resizable:false,layout:"border",closeAction:"hide",items:[{xtype:"cwn2-routeplanner-inputpanel"},{xtype:"cwn2-routeplanner-outputpanel"}]});Ext.define("CWN2.controller.button.routeplanner",{extend:"Ext.app.Controller",views:["CWN2.button.RoutePlanner","CWN2.button.RoutePlanner.Window","CWN2.button.RoutePlanner.InputPanel","CWN2.button.RoutePlanner.OutputPanel"],refs:[{ref:"button",selector:"cwn2-button-routeplanner"},{ref:"win",selector:"cwn2-routeplanner-win"},{ref:"inputPanel",selector:"cwn2-routeplanner-inputpanel"},{ref:"outputPanel",selector:"cwn2-routeplanner-outputpanel"},{ref:"outputPanelTitle",selector:"#cwn2-routeplanner-output-panel-title"}],init:function(a){CWN2.Util.log("CWN2.controller.button.routeplanner: init");this.control({"cwn2-button-routeplanner":{click:this.onClick},"cwn2-routeplanner-inputpanel":{render:this.onRenderInputPanel},"#cwn2-routeplanner-start-combo":{select:this.onStartComboSelect},"#cwn2-routeplanner-end-combo":{select:this.onEndComboSelect},"cwn2-routeplanner-modecombo":{select:this.onModeComboSelect},"button[action=routeplanner-start]":{click:this.onStartButtonClick},"button[action=routeplanner-end]":{click:this.onEndButtonClick},"button[action=routeplanner-submit]":{click:this.onSubmitButtonClick},"button[action=routeplanner-reset]":{click:this.onResetButtonClick},"button[action=routeplanner-zoom]":{click:this.onZoomButtonClick},"cwn2-routeplanner-outputpanel":{select:this.onOutputPanelSelect,itemmouseenter:this.onItemMouseEnter,itemmouseleave:this.onItemMouseLeave}});this.initRouteMngr()},onItemMouseEnter:function(b,a){this.hiliteStep(a,false)},onItemMouseLeave:function(b,a){this.hiliteStep(a,true)},hiliteStep:function hiliteStep(b,a){var f=b.data.id;var d=CWN2.app.map.getLayerByName("routingLayer");var e=d.getFeaturesByAttribute("id",f);if(e.length>0){var c=e[0];if(a){if(c.isSelected()){c.renderStyle="select"}else{c.renderStyle="default"}}else{c.renderStyle="hover"}d.drawFeature(c,c.renderStyle);this.showStepPopup(c)}},onRenderInputPanel:function(){var a=this;a.clickMapCtrl=new CWN2.Control.GetMapCoordinatesOnClick(function(f,e,d,b){var c=6;if(b.type==="start"){Ext.ComponentQuery.query("#cwn2-routeplanner-start-combo")[0].setValue("Coordinate: "+e.lon.toFixed(c)+" , "+e.lat.toFixed(c));a.setOrigin(null,d.lat,d.lon)}else{Ext.ComponentQuery.query("#cwn2-routeplanner-end-combo")[0].setValue("Coordinate: "+e.lon.toFixed(c)+" , "+e.lat.toFixed(c));a.setDestination(null,d.lat,d.lon)}});CWN2.app.map.addControl(this.clickMapCtrl)},onClick:function(){var d=CWN2.app.layout.mapPanel,c=this.getWin(),a=this.getButton(),b=this;if(!c){c=Ext.create("CWN2.button.RoutePlanner.Window",{})}this.showHideWin(c,d)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},onStartComboSelect:function(f,c){var b,e,g,a=c[0];try{b=a.data.name;e=a.data.lonlat[1];g=a.data.lonlat[0];if(!CWN2.app.map.isPointInMaxExtent(e,g)){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Il punto è fuori dai limiti geografici della mappa"));return}this.setOrigin(b,e,g);Ext.ComponentQuery.query("#cwn2-routeplanner-end-combo")[0].focus("",100)}catch(d){if(d.name==="PointOutOfMaxExtent"){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Il punto e' fuori dai limiti geografici della mappa"),function(){f.setValue("");f.focus("",100)})}}},onEndComboSelect:function(f,c){var b,e,g,a=c[0];try{b=a.data.name;e=a.data.lonlat[1];g=a.data.lonlat[0];if(!CWN2.app.map.isPointInMaxExtent(e,g)){Ext.MessageBox.alert(CWN2.I18n.get("Attenzione"),CWN2.I18n.get("Il punto è fuori dai limiti geografici della mappa"));return}this.setDestination(b,e,g)}catch(d){if(d.name==="PointOutOfMaxExtent"){Ext.MessageBox.alert("Attenzione","Il punto e' fuori dai limiti geografici della mappa",function(){f.setValue("");f.focus("",100)})}}},onModeComboSelect:function(b,a){this.setTravelMode(a[0].data.field1)},onStartButtonClick:function(b,a){this.clickMapCtrl.activate({type:"start"})},onEndButtonClick:function(b,a){this.clickMapCtrl.activate({type:"end"})},onSubmitButtonClick:function(){this.registerCallbacks();try{this.calculate(c)}catch(a){CWN2.Util.handleException(a)}var b=this;function c(e){var j=CWN2.app.map,h=b.getOutputPanel();b.drawRouteOnMap(j,e);b.getOutputPanelTitle().setValue(CWN2.I18n.get("Distanza totale")+": "+e.distance+" - "+CWN2.I18n.get("Durata totale")+": "+e.duration);var f=h.store;f.clearData();var d=e.steps.length;for(var g=0;g<d;g++){var k={id:g,instructions:e.steps[g].instructions,distance:e.steps[g].distance.text,duration:e.steps[g].duration.text};f.add(k)}h.setVisible(true);b.getWin().setHeight(500)}},onResetButtonClick:function(){var a=this.getOutputPanel();Ext.ComponentQuery.query("#cwn2-routeplanner-start-combo")[0].setValue("");Ext.ComponentQuery.query("#cwn2-routeplanner-end-combo")[0].setValue("");this.reset();this.getOutputPanelTitle().setValue(null);a.store.clearData();a.setVisible(false);this.getWin().setHeight(160)},onZoomButtonClick:function(){CWN2.app.map.zoomToStringExtent(this.getResult().bounds,"EPSG:4326")},onOutputPanelSelect:function(d,a,c){if(CWN2.app.map.getLayerByName("routingLayer")&&CWN2.app.map.getLayerByName("routingLayer").visibility){try{CWN2.FeatureSelecter.selectFeature({layer:CWN2.app.map.getLayerByName("routingLayer"),attrName:"id",item:a.data.id,options:{zoom:true,maxZoomLevel:15,hiliteOnly:false}})}catch(b){CWN2.Util.handleException(b)}}},showStepPopup:function(b){var a;if(b.popup){a=b.popup;CWN2.app.map.removePopup(a);b.popup=null}else{a=new OpenLayers.Popup.Anchored("stepPopup",b.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(200,60),b.attributes.label,null,false,null);b.popup=a;a.feature=b;a.panMapIfOutOfView=false;a.backgroundColor="#FFFFFF";a.opacity=0.9;CWN2.app.map.addPopup(a)}},registerCallbacks:function(){var a=this;CWN2.app.map.featureManager.registerCallback("onFeatureSelect",function(c){if((c.attributes.type==="step")||(c.attributes.type==="start")){var b=a.getOutputPanel();b.getView().getSelectionModel().suspendEvents();b.getView().select(c.attributes.id);b.getView().getSelectionModel().resumeEvents();b.getView().focusRow(c.attributes.id);CWN2.app.map.zoomToFeatures([c],15)}});CWN2.app.map.featureManager.registerCallback("onFeatureUnselect",function(b){if((b.attributes.type==="step")||(b.attributes.type==="start")){var c=a.getOutputPanel().getView().getSelectionModel().getSelection()[0];if(c){a.getOutputPanel().getView().deselect(b.attributes.id)}}});CWN2.app.map.featureManager.registerCallback("onFeatureOver",function(b){if(b.attributes.type==="step"){a.showStepPopup(b)}});CWN2.app.map.featureManager.registerCallback("onFeatureOut",function(b){if(b.attributes.type==="step"){a.showStepPopup(b)}})},initRouteMngr:function(){if(typeof google!=="undefined"){this.travelMode=google.maps.TravelMode.DRIVING;this.directionsDisplay=new google.maps.DirectionsRenderer({preserveViewport:true})}},origin:{address:null,lat:null,lon:null,latLng:null},destination:{address:null,lat:null,lon:null,latLng:null},routingLayer:null,result:{},travelMode:null,directionsDisplay:null,setOrigin:function(a,b,c){this.origin.address=a;this.origin.lat=b;this.origin.lon=c;if(b&&c){this.origin.latLng=new google.maps.LatLng(b,c)}else{this.origin.latLng=null}},setDestination:function(a,b,c){this.destination.address=a;this.destination.lat=b;this.destination.lon=c;if(b&&c){this.destination.latLng=new google.maps.LatLng(b,c)}else{this.destination.latLng=null}},setTravelMode:function(a){this.travelMode=a},calculate:function(f){var d=this;var b=c(),e=new google.maps.DirectionsService();CWN2.Util.assert(b.origin,{name:"MissingOrigin",message:"Partenza deve essere indicata",level:1});CWN2.Util.assert(b.destination,{name:"MissingDestination",message:"Destinazione deve essere indicata",level:1});e.route(b,function(g,h){if(h===google.maps.DirectionsStatus.OK){d.result=a(g,f)}else{var j="CWN2.routingMngr.calculate: Servizio Google ha ritornato un errore./n";switch(h){case google.maps.DirectionsStatus.NOT_FOUND:j+="Origine o destinazione non trovati";break;case google.maps.DirectionsStatus.OVER_QUERY_LIMIT:j+="Superato il numero di richieste permesse";break;case google.maps.DirectionsStatus.REQUEST_DENIED:j+="Richiesta rifiutata";break;case google.maps.DirectionsStatus.UNKNOWN_ERROR:j+="Errore del server Google. Riprova successivamente";break;case google.maps.DirectionsStatus.ZERO_RESULTS:j+="Non è stato possibile trovare un percorso dall'origine alla destinazione";break}throw {name:"GoogleDirectionsError",message:j,level:1}}});function a(n,l){var m=CWN2.app.map;m.layerManager.addBaseLayers([{type:"google_roadmap",name:"google_roadmap",legend:{label:"Google Stradario",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},visible:false,isBaseLayer:false}]);var j=OpenLayers.Layer.Google.cache[m.id].mapObject;try{d.directionsDisplay.setMap(j);d.directionsDisplay.setDirections(n)}catch(k){}var g=h(n);if(l){l(g)}return g;function h(s){var r,p,o={};o.origin=s.routes[0].legs[0].start_address;o.destination=s.routes[0].legs[0].end_address;o.copyrights=s.routes[0].copyrights;o.bounds=q(s.routes[0].bounds);o.overview_path=s.routes[0].overview_path;o.distance=s.routes[0].legs[0].distance.text;o.duration=s.routes[0].legs[0].duration.text;o.steps=s.routes[0].legs[0].steps;p=o.steps.length;for(r=0;r<p;r++){o.steps[r].id=r}return o;function q(t){return d.extractCoordinates(t.getSouthWest())+","+d.extractCoordinates(t.getNorthEast())}}}function c(){var k=(d.origin.address)?d.origin.address:d.origin.latLng,g=(d.destination.address)?d.destination.address:d.destination.latLng,h=google.maps.UnitSystem.METRIC,j="it";return{origin:k,destination:g,travelMode:d.travelMode,unitSystem:h,region:j}}},drawRouteOnMap:function(h,b){var e=this;var c,g;c=d();this.routingLayer=CWN2.app.map.layerManager.createVectorLayer({name:"routingLayer",format:"GeoJSON",classes:c,legend:null});this.routingLayer.setVisibility(true);CWN2.FeatureLoader.loadFeatures({layer:this.routingLayer,features:f(b.steps,b.destination),url:null,options:{zoom:false,clean:true}});g={type:"google_roadmap",name:"google_roadmap",legend:{label:"Google Stradario",icon:"http://geoportale.regione.liguria.it/geoviewer/img/legend/google.png"},visible:false,isBaseLayer:false};CWN2.app.map.layerManager.addBaseLayers([g]);CWN2.app.map.setBaseLayerOnMap("google_roadmap");var a=b.bounds;CWN2.app.map.zoomToStringExtent(a,"EPSG:4326");function d(){var k,m,l,j;l=[{renderIntent:"default",style:{fillColor:"#3838FF",fillOpacity:0.5,strokeColor:"#3838FF",strokeOpacity:1,strokeWidth:1,pointRadius:5}},{renderIntent:"hover",style:{fillColor:"#ee9900",fillOpacity:0.8,strokeColor:"#3838FF",strokeOpacity:1,strokeWidth:1,pointRadius:7}},{renderIntent:"select",style:{fillColor:"#ee9900",fillOpacity:0.8,strokeColor:"#3838FF",strokeOpacity:1,strokeWidth:1,pointRadius:7}}];k=[{renderIntent:"default",style:{externalGraphic:"http://geoportale.regione.liguria.it/geoviewer/img/icons/numbers/letter_a.png",graphicWidth:32,graphicHeight:37,graphicOpacity:1,graphicXOffset:-16,graphicYOffset:-37,graphicTitle:"${label}"}}];m=[{renderIntent:"default",style:{externalGraphic:"http://geoportale.regione.liguria.it/geoviewer/img/icons/numbers/letter_b.png",graphicWidth:32,graphicHeight:37,graphicOpacity:1,graphicXOffset:-16,graphicYOffset:-37,graphicTitle:"${label}"}}];j=[{filter:"type = 'start'",styleMaps:k},{filter:"type = 'end'",styleMaps:m},{filter:"type = 'step'",styleMaps:l}];return j}function f(q,j){var m,n,o=q.length,r,p,l=6;m='{ "type": "FeatureCollection","features": [';for(n=0;n<o;n++){p=(n===0)?"start":"step";r="["+e.extractCoordinates(q[n].start_location)+"]";m+='{ "type": "Feature",';m+='"geometry": {"type": "Point", "coordinates": '+r+"},";m+='"properties": {"label": "'+k(q[n].instructions)+'","type": "'+p+'","id": '+q[n].id+"}},"}if(typeof j!=="string"){j="Coordinate: "+j.Oa.toFixed(l)+" , "+j.Na.toFixed(l)}p="end";r="["+e.extractCoordinates(q[n-1].end_location)+"]";m+='{ "type": "Feature",';m+='"geometry": {"type": "Point", "coordinates": '+r+"},";m+='"properties": {"label": "'+k(j)+'","type": "'+p+'"}},';m=m.substr(0,m.length-1);m+="]}";return Ext.decode(m);function k(s){if(typeof s==="string"){return s.replace(/"/g,"'")}}}},reset:function(){this.directionsDisplay.setMap(null);if(this.routingLayer){this.routingLayer.setVisibility(false);var d=this.routingLayer.features;var a=d.length;for(var c=0;c<a;c++){if(d[c].popup){var b=d[c].popup;b.feature=null;CWN2.app.map.removePopup(d[c].popup);d[c].popup.destroy();d[c].popup=null}}}this.origin.address=null;this.origin.lat=null;this.origin.lon=null;this.origin.latLng=null;this.destination.address=null;this.destination.lat=null;this.destination.lon=null;this.destination.latLng=null},getResult:function(){return this.result},swapDirection:function(){var a=Ext.clone(origin),b=Ext.clone(destination);this.destination=a;this.origin=b},extractCoordinates:function(point){var coord=point.toString().replace("(","[").replace(")","]");var coordArray=eval(coord);return coordArray[1]+","+coordArray[0]}});Ext.define("CWN2.button.S3Ricerche",{extend:"Ext.button.Button",alias:"widget.cwn2-button-s3ricerche",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{tooltip:(a&&a.tooltip)?a.tooltip:CWN2.I18n.get("Ricerca avanzata"),iconCls:(a&&a.iconCls)?a.iconCls:a.id,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,id:a.id})}});Ext.define("CWN2.controller.button.s3ricerche",{extend:"Ext.app.Controller",views:["CWN2.button.S3Ricerche"],refs:[{ref:"buttonS3ricerche",selector:"#s3ricerche"},{ref:"buttonS3RicercaPraticaGenioWeb",selector:"#s3RicercaPraticaGenioWeb"},{ref:"win",selector:"cwn2-button-s3ricerche"}],init:function(a){CWN2.Util.log("CWN2.controller.button.s3ricerche: init");this.control({"#s3ricerche":{click:this.onClickS3ricerche},"#s3RicercaPraticaGenioWeb":{click:this.onClickS3RicercaPraticaGenioWeb}})},onClickS3ricerche:function(){this.createWin(this.getButtonS3ricerche())},onClickS3RicercaPraticaGenioWeb:function(){this.createWin(this.getButtonS3RicercaPraticaGenioWeb())},createWin:function(c){var f=CWN2.app.layout.mapPanel,d=400,a=400,b=c.config.options.id+"-win";var e=Ext.ComponentQuery.query("#"+b)[0];if(!e){e=Ext.create("CWN2.IframeWindow",{url:c.config.options.url,id:b,width:d,height:a,resizable:false,hide:true})}this.showHideWin(e,f)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.button.SelectFeature",{extend:"Ext.button.Button",alias:"widget.cwn2-button-selectfeature",constructor:function(b){this.config=b;var a=b.options,f=CWN2.app.map,g="selectfeature",d=this;this.layers=a.idLayer.split(",");this.wmsSldHiliter={};for(var c=0;c<this.layers.length;c++){this.wmsSldHiliter[this.layers[c]]=new CWN2.WmsSldHiliter(f,"_selezione_"+this.layers[c])}var e=new OpenLayers.Control.WMSGetFeatureInfo({layers:null,queryVisible:true,name:"selectfeature",drillDown:true,maxFeatures:1,vendorParams:(a.radius)?{radius:a.radius}:null,infoFormat:"application/vnd.ogc.gml",output:"object",eventListeners:{getfeatureinfo:function(h){d.fireEvent("getfeatureinfo",h)}}});f.addControl(e);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:g,tooltip:CWN2.I18n.get("Seleziona"),iconCls:(a&&a.iconCls)?a.iconCls:"select",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,enableToggle:true,control:e,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.selectFeature.Store",{extend:"Ext.data.Store",data:[],autoLoad:false,fields:[{name:"ID_LAYER",mapping:"ID_LAYER"},{name:"ID",mapping:"ID"},{name:"LABEL",mapping:"LABEL"}]});Ext.define("CWN2.button.selectFeature.GridPanel",{extend:"Ext.grid.Panel",alias:"widget.cwn2-selectfeature-grid",frame:true,width:300,height:300,hideHeaders:true,iconCls:"icon-grid",store:Ext.create("CWN2.button.selectFeature.Store"),columns:[{header:"ID",sortable:true,dataIndex:"ID",width:70},{header:"LABEL",sortable:true,dataIndex:"LABEL",width:200},{xtype:"actioncolumn",header:" ",items:[{icon:"http://geoportale.regione.liguria.it/geoviewer/img/silk/delete.png",tooltip:"Seleziona per cancellare"}],width:30}]});Ext.define("CWN2.button.selectFeature.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-selectfeature-win",title:CWN2.I18n.get("Oggetti Selezionati"),width:335,height:360,layout:"fit",closable:false,closeAction:"hide",items:[Ext.create("CWN2.button.selectFeature.GridPanel")],buttons:[{text:CWN2.I18n.get("Conferma"),action:"selectfeature-submit"},{text:CWN2.I18n.get("Annulla"),action:"selectfeature-cancel"}]});Ext.define("CWN2.controller.button.selectfeature",{extend:"Ext.app.Controller",views:["CWN2.button.SelectFeature"],refs:[{ref:"button",selector:"cwn2-button-selectfeature"},{ref:"win",selector:"cwn2-selectfeature-win"},{ref:"grid",selector:"cwn2-selectfeature-grid"}],init:function(a){CWN2.Util.log("CWN2.controller.button.selectfeature: init");this.control({"cwn2-button-selectfeature":{toggle:this.onButtonPress,getfeatureinfo:this.onGetFeatureInfo},"button[action=selectfeature-submit]":{click:this.onSubmitButtonClick},"button[action=selectfeature-cancel]":{click:this.onCancelButtonClick},"cwn2-selectfeature-grid actioncolumn":{click:this.onDeleteClick}})},onSubmitButtonClick:function(){var b=this.getButton(),a=this.getGrid().store.data.items;if(a.length===0){alert("Selezionare almeno un oggetto");return}if(b.config.options&&b.config.options.callBacks&&b.config.options.callBacks.submit){b.config.options.callBacks.submit(a)}else{CWN2.Util.log("Funzione di callback 'submit' non definita",1)}},onCancelButtonClick:function(){var b=this.getButton(),a=this.getGrid().store.data.items;if(b.config.options&&b.config.options.callBacks&&b.config.options.callBacks.cancel){b.config.options.callBacks.cancel(a,this.getButton())}else{CWN2.Util.log("Funzione di callback 'cancel' non definita",1)}},onDeleteClick:function(b,a,g,c,f){var d=this;Ext.MessageBox.confirm(CWN2.I18n.get("Conferma"),CWN2.I18n.get("Sei sicuro?"),function(h){if(h==="yes"){var e=Ext.ComponentQuery.query("cwn2-selectfeature-grid")[0].store;e.removeAt(g);d.updateHiliteLayer(e)}})},onGetFeatureInfo:function(a){this.updateList(a)},onButtonPress:function(){var e=CWN2.app.layout.mapPanel,d=this.getWin(),a=this.getButton(),b=this,c=CWN2.app.map;d=this.getWin()||Ext.create("CWN2.button.selectFeature.Window");this.showHideWin(d,e)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}},updateList:function(d){var b=this.getButton(),c=this;Ext.each(b.layers,function(h){var g=d.features;Ext.each(g,function(j){var k=j.features;Ext.each(k,function(l){if(l.type===h||(l.gml&&l.gml.featureType===h)){f(l.attributes,h);return false}})})});function f(l,m){var g=e(l,m);var k=Ext.ComponentQuery.query("cwn2-selectfeature-grid")[0].store,j=g.ID,h=k.findBy(function(n,o){return n.get("ID")===j});(h!==-1)?k.removeAt(h):a(k,g);c.updateHiliteLayer(k)}function a(g,h){if(b.config.options.flagSelezioneSingola){g.removeAll()}g.add(h)}function e(j,n){var g=null;var h=CWN2.app.map.layerManager.getLayerConfigByName(n);var l=h.infoOptions.infoIdAttr;var k=h.infoOptions.infoLabelAttr;if(!l){var m={name:"BadConfiguration",message:"CWN2.button.selectFeature: infoOptions.infoIdAttr non impostato per layer "+n,level:1};CWN2.util.handleException(m);return null}if(!k){k=l}if(j[l]){g={};g.ID_LAYER=n;g.ID=j[l];if(j[k]){g.LABEL=j[k]}else{g.LABEL=j[l];CWN2.Util.log("CWN2.button.selectFeature: valore non trovato per campo ID per layer "+n)}g.LABEL=j[k]}else{CWN2.Util.log("CWN2.button.selectFeature: valore non trovato per campo ID per layer "+n)}return g}},updateHiliteLayer:function(g){var a=g.data.items,d=this.getButton(),f=this,b=d.layers;for(var c=0;c<b.length;c++){var e=b[c];var j=CWN2.app.map.layerManager.getLayerConfigByName(e);var h=[];Ext.each(a,function(k,l){(k.data.ID_LAYER==e)?h.push(k.data.ID):null});(h.length>0)?d.wmsSldHiliter[e].hiliteFeature({layers:[j.name],fields:j.infoOptions.infoIdAttr,values:h}):d.wmsSldHiliter[e].cleanHiliteLayer(e)}}});Ext.define("CWN2.button.SimpleLegend",{extend:"Ext.button.Button",alias:"widget.cwn2-button-simplelegend",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{id:"simpleLegend",tooltip:"Legenda",iconCls:(a&&a.iconCls)?a.iconCls:"legend",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false})}});Ext.define("CWN2.button.SimpleLegend.Win",{extend:"Ext.window.Window",alias:"widget.cwn2-simplelegend-win",title:"Legenda",autoScroll:true,layout:"fit",height:430,width:260,resizable:false,closeAction:"hide"});Ext.define("CWN2.controller.button.simpleLegend",{extend:"Ext.app.Controller",views:["CWN2.button.SimpleLegend"],refs:[{ref:"button",selector:"cwn2-button-simplelegend"},{ref:"win",selector:"cwn2-simplelegend-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.simpleLegend: init");this.control({"cwn2-button-simplelegend":{click:this.onClick}})},onClick:function(){var c=this.getWin(),a=this.getButton();var b=(a.config.options&&a.config.options.noBaseLayerGrid)?a.config.options.noBaseLayerGrid:false;if(!c){c=Ext.create("CWN2.button.SimpleLegend.Win",{items:[new CWN2.SimpleLegendPanel({flagBtn:true,noBaseLayerGrid:b})]})}this.showHideWin(c,CWN2.app.layout.mapPanel)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tr-tr",[-10,10])}else{a.hide()}}});Ext.define("CWN2.button.Transparency",{extend:"Ext.button.Button",alias:"widget.cwn2-button-transparency",constructor:function(b){var a=b.options;this.superclass.constructor.call(this,{id:"transparency",tooltip:CWN2.I18n.get("Trasparenza"),iconCls:(a&&a.iconCls)?a.iconCls:"transparency",text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false})}});Ext.define("CWN2.button.Transparency.Window",{extend:"Ext.window.Window",alias:"widget.cwn2-transparency-win",title:CWN2.I18n.get("Trasparenza"),height:300,width:330,layout:"fit",resizable:false,constructor:function(a){var b=[];Ext.each(a.layers,function(d,c){var e=a.mapPanel.map.getLayerByName(d.data.name);b.push({xtype:"gx_opacityslider",layer:e,aggressive:true,width:300,isFormField:true,labelWidth:150,fieldLabel:d.data.legendLabel})});this.items=[{xtype:"panel",height:"auto",width:"auto",frame:true,items:b,autoScroll:true}];this.superclass.constructor.call(this)}});Ext.define("CWN2.controller.button.transparency",{extend:"Ext.app.Controller",views:["CWN2.button.Transparency"],refs:[{ref:"button",selector:"cwn2-button-transparency"},{ref:"win",selector:"cwn2-transparency-win"}],init:function(a){CWN2.Util.log("CWN2.controller.button.transparency: init");this.control({"cwn2-button-transparency":{click:this.onClick}})},onClick:function(){var d=CWN2.app.layout.mapPanel,c=this.getWin(),a=this.getButton(),b=this;if(!c){c=Ext.create("CWN2.button.Transparency.Window",{layers:CWN2.app.map.layerManager.getLayerStore("overlay").data.items,mapPanel:CWN2.app.layout.mapPanel})}this.showHideWin(c,d)},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.button.ZoomIn",{extend:"Ext.button.Button",alias:"widget.cwn2-button-zoomin",constructor:function(b){var a=b.options,d=CWN2.app.map,e="zoomin",c=new OpenLayers.Control.ZoomBox();d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:e,tooltip:CWN2.I18n.get("Zoom In"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,control:c,enableToggle:true,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.ZoomNext",{extend:"Ext.button.Button",alias:"widget.cwn2-button-zoomnext",constructor:function(b){var a=b.options,c=b.panels,d=CWN2.app.map,f="zoomnext";function e(){var h=null,g=d.getControlsByClass("OpenLayers.Control.NavigationHistory");if(g.length===0){h=new OpenLayers.Control.NavigationHistory();d.addControl(h)}else{h=g[0]}return h}this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{tooltip:CWN2.I18n.get("Zoom Successivo"),iconCls:(a&&a.iconCls)?a.iconCls:f,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,disabled:true,control:e().next,pressed:false,id:f}))}});Ext.define("CWN2.button.ZoomOut",{extend:"Ext.button.Button",alias:"widget.cwn2-button-zoomout",constructor:function(b){var a=b.options,d=CWN2.app.map,e="zoomout",c=new OpenLayers.Control.ZoomBox({out:true});d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{id:e,tooltip:CWN2.I18n.get("Zoom Out"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,enableToggle:true,control:c,toggleGroup:"mapInteractToggleGroup"}))}});Ext.define("CWN2.button.ZoomPrevious",{extend:"Ext.button.Button",alias:"widget.cwn2-button-zoomprevious",constructor:function(b){var a=b.options,c=b.panels,d=CWN2.app.map,f="zoomprevious";function e(){var h=null,g=d.getControlsByClass("OpenLayers.Control.NavigationHistory");if(g.length===0){h=new OpenLayers.Control.NavigationHistory();d.addControl(h)}else{h=g[0]}return h}this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{tooltip:CWN2.I18n.get("Zoom Precedente"),iconCls:(a&&a.iconCls)?a.iconCls:f,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,disabled:true,control:e().previous,pressed:false,id:f}))}});Ext.define("CWN2.button.ZoomToInitialExtent",{extend:"Ext.button.Button",alias:"widget.cwn2-button-zoomtoinitialextent",constructor:function(b){var a=b.options,d=CWN2.app.map,e="zoomToInitialExtent",c=new CWN2.Control.ZoomToInitialExtent();d.addControl(c);this.superclass.constructor.call(this,Ext.create("GeoExt.Action",{tooltip:CWN2.I18n.get("Zoom alla estensione iniziale"),iconCls:(a&&a.iconCls)?a.iconCls:e,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,pressed:false,control:c,id:e}))}});Ext.define("CWN2.button.redirect",{extend:"Ext.button.Button",alias:"widget.cwn2-button-redirect",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{tooltip:(a&&a.tooltip)?a.tooltip:CWN2.I18n.get("Redirect"),iconCls:(a&&a.iconCls)?a.iconCls:a.id,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,id:a.id})}});Ext.define("CWN2.controller.button.redirect",{extend:"Ext.app.Controller",views:["CWN2.button.redirect"],refs:[{ref:"button",selector:"cwn2-button-redirect"}],init:function(a){CWN2.Util.log("CWN2.controller.button.redirect: init");this.control({"cwn2-button-redirect":{click:this.onClick}})},onClick:function(){window.location.href=this.getButton().config.options.url}});Ext.define("CWN2.button.window",{extend:"Ext.button.Button",alias:"widget.cwn2-button-window",constructor:function(b){var a=b.options;this.config=b;this.superclass.constructor.call(this,{tooltip:(a&&a.tooltip)?a.tooltip:CWN2.I18n.get("Finestra"),iconCls:(a&&a.iconCls)?a.iconCls:a.id,text:(a&&a.text)?a.text:"",width:(a&&a.width)?a.width:26,id:a.id})}});Ext.define("CWN2.controller.button.window",{extend:"Ext.app.Controller",views:["CWN2.button.window"],refs:[{ref:"button",selector:"cwn2-button-window"}],init:function(a){CWN2.Util.log("CWN2.controller.button.window: init");this.control({"cwn2-button-window":{click:this.onClick}})},onClick:function(){this.createWin(this.getButton())},createWin:function(f){var d=CWN2.app.layout.mapPanel,c=f.config.options.winWidth||600,j=f.config.options.winHeight||400,b=f.config.options.url,a=f.config.options.resizable||false,h=f.config.options.target||"panel",e=f.config.options.id+"-win";if(!b){CWN2.Util.handleException({message:"Url del bottone 'window' non definita",level:1});return}if(h==="panel"){var g=Ext.ComponentQuery.query("#"+e)[0];if(!g){g=Ext.create("CWN2.IframeWindow",{url:b,id:e,width:c,height:j,resizable:a,hide:true})}this.showHideWin(g,d)}else{}},showHideWin:function(a,b){if(!a.isVisible()){a.show();a.alignTo(b.body,"tl-tl",[10,10])}else{a.hide()}}});Ext.define("CWN2.Widget.Button",{constructor:function(f,c){CWN2.Util.log("CWN2.Widget.button");var g=f.id,e="bottone",b=null,a=null;if(!f.id){CWN2.Util.log("Attenzione: id widget Button non definito",0)}var d=CWN2.app.map;if(f.options){if(f.options.text){e=f.options.text}if(f.options.handler){b=f.options.handler}if(f.options.width){a=f.options.width}if(f.options.align&&f.options.align==="right"){c.addStatusbarItem("->")}}return[{xtype:"button",id:g,text:CWN2.I18n.get(e),width:a,handler:b}]}});Ext.define("CWN2.Widget.CoordinateReadOut",{constructor:function(d,b){CWN2.Util.log("CWN2.Widget.CoordinateReadOut");var a="cwn2-coordinate-readout-div";var c=CWN2.app.map;function e(h){var f=c.getLonLatFromPixel(h.xy),g=0,j;if(c.displayProjection){if(c.displayProjection.projCode==="EPSG:4326"){g=6}f.transform(c.getProjectionObject(),c.displayProjection)}j=" X="+f.lon.toFixed(g)+" Y="+f.lat.toFixed(g);b.setStatusbarItemText(a,j)}c.events.register("mousemove",c,e);return[CWN2.I18n.get("Coordinate:"),{id:a,text:"",width:200,xtype:"tbtext"}]}});Ext.define("CWN2.Widget.Scale",{constructor:function(e,b){CWN2.Util.log("CWN2.Widget.Scale");var a="cwn2-scale-div";var d=CWN2.app.map;function c(){var f=" 1:"+d.getScale().toFixed(0);b.setStatusbarItemText(a,f)}d.events.register("zoomend",d,c);c();return[CWN2.I18n.get("Scala"),{id:a,text:"",width:60,xtype:"tbtext"}]}});Ext.define("CWN2.Widget.ScaleCombo",{constructor:function(g,b){CWN2.Util.log("CWN2.Widget.ScaleCombo");var a="cwn2-scale-combo-div";var e=CWN2.app.map;function c(){d.setValue(e.zoom.toString())}e.events.register("zoomend",e,c);var f=Ext.create("Ext.data.Store",{fields:["zoom","scale"],data:[{zoom:"8",scale:"1:1.600.000"},{zoom:"9",scale:"1:800.000"},{zoom:"10",scale:"1:400.000"},{zoom:"11",scale:"1:200.000"},{zoom:"12",scale:"1:100.000"},{zoom:"13",scale:"1:50.000"},{zoom:"14",scale:"1:25.000"},{zoom:"15",scale:"1:12.500"},{zoom:"16",scale:"1:6.250"},{zoom:"17",scale:"1:3.125"},{zoom:"18",scale:"1:1.560"},{zoom:"19",scale:"1:800"},{zoom:"20",scale:"1:400"}]});var d=Ext.create("Ext.form.ComboBox",{store:f,queryMode:"local",displayField:"scale",valueField:"zoom",width:100,editable:false,listeners:{select:function(l,h,j){var k=parseInt(h[0].data.zoom);if(CWN2.app.map.zoom!==k){CWN2.app.map.zoomTo(k)}}}});return[CWN2.I18n.get("Scala "),d]}});