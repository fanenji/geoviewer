<!DOCTYPE HTML>

<html>
<head>
    <meta charset="utf-8">

    <!-- librerie css -->
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/extjs/resources/css/ext-all-gray.css"/>
    <link rel="stylesheet" type="text/css" href="/geoviewer/stili/default/base.css"/>
    <link rel="stylesheet" type="text/css" href="print.css"/>
    <!-- librerie js -->
    <script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2&language=it"></script>
    <script src="/geoviewer/lib/OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src='/geoviewer/lib/proj4js/lib/proj4js-min.js'></script>
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/ext.js"></script>
    <script type="text/javascript" src="/geoviewer/lib/ExtJs/locale/ext-lang-it.js"></script>
    <script src="/geoviewer/lib/Cwn2/cwn2-debug.js"></script>

    <script>

        //http://parodi.datasiel.net:8080/geoviewer/pages/apps/print/legend.html?print_config_url=/geoservices/temp/print_c5843cd6-8bd4-4aa5-97ef-86924422f616.json

        Ext.application({
            name: 'stampa_legenda',

            launch: function() {
                // imposto la url del servizio di configurazione
                var printConfigUrl = decodeURIComponent(CWN2.Util.getUrlParam('print_config_url'));

                if (!printConfigUrl) {
                    return;
                }


                CWN2.Util.ajaxRequest({
                    type: "JSON",
                    url: printConfigUrl,
                    callBack: function(response) {
                        var extent = (response.mapOptions.flagSameScale) ? null : response.mapOptions.extent,
                                legendDiv = Ext.get("legend_div");


                        var html = '<span id="legend_span"><b><br>Legenda</b><br><br><br></span>';
                        response.layers.reverse();
                        Ext.each(response.layers, function(layerConfig) {
                            if (layerConfig.inRange && layerConfig.visible) {
                                // layer vettoriale monoclasse
                                if (layerConfig.geomType === "VECTOR" && !layerConfig.multiClasse) {
                                    html += '<span id="layer_span"><b>' + layerConfig.legend.label + '</b></span><span id="layer_span"><img src="' + layerConfig.legend.icon + '">' + '</span><br>';
                                    html += '<br>';
                                }
                                // layer multiclasse
                                if (layerConfig.geomType === "VECTOR" && layerConfig.multiClasse) {
                                    html += '<span id="layer_span"><b>' + layerConfig.legend.label + '</b></span><br><br>';
                                    if (layerConfig.flagGeoserver) {
                                        var multiClassUrl = layerConfig.wmsParams.url + "LAYER=" + layerConfig.name + "&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&";
                                        html += '<span id="rule_span"><img src="' + multiClassUrl + '">' + '</span><br>';
                                        html += '<br>';
                                    } else {
                                        // mapserver
                                        Ext.each(layerConfig.classes, function(rule) {
                                            html += '<span id="rule_span"><img src="' + encodeURI(rule.legendIcon) + '">' + '</span><span id="layer_span">' + rule.legendLabel + '</span><br>';
                                        });
                                        html += '<br>';
                                    }
                                }
                            }
                        });
                        legendDiv.update(html);
                    }
                });


            } //eo launch
        });


    </script>


</head>

<body>
<div id="legend_div"></div>

</body>

</html>
		